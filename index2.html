<!DOCTYPE html>
<html lang="en" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StakzShop</title>
    
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Google reCAPTCHA v2 -->
    <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        zinc: {
                            850: '#202023',
                            900: '#18181b',
                            950: '#09090b',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'marquee': 'marquee 25s linear infinite',
                        'spin-slow': 'spin 3s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        marquee: {
                            '0%': { transform: 'translateX(0%)' },
                            '100%': { transform: 'translateX(-100%)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body { 
            background-color: #fafafa;
            color: #18181b;
            -webkit-font-smoothing: antialiased;
        }
        #html-root.dark body {
            background-color: #000000;
            color: #f4f4f5;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 2px; }
        ::-webkit-scrollbar-track { background: #e4e4e7; }
        ::-webkit-scrollbar-thumb { background: #a1a1aa; }
        #html-root.dark ::-webkit-scrollbar-track { background: #09090b; }
        #html-root.dark ::-webkit-scrollbar-thumb { background: #27272a; }

        /* Animations */
        .animate-enter { animation: enter 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes enter {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }
        #html-root.dark .glass {
            background: rgba(24, 24, 27, 0.85);
            border-bottom-color: rgba(255, 255, 255, 0.08);
        }
        /* Light mode overrides for common dark backgrounds */
        #html-root:not(.dark) .bg-black { background-color: #ffffff !important; }
        #html-root:not(.dark) [class*="bg-zinc-900"] { background-color: #f4f4f5 !important; }
        #html-root:not(.dark) [class*="border-white/"] { border-color: rgba(0,0,0,0.08) !important; }
        #html-root:not(.dark) .text-white { color: #18181b !important; }
        #html-root:not(.dark) .text-zinc-400,
        #html-root:not(.dark) .text-zinc-500 { color: #52525b !important; }
        #html-root:not(.dark) .text-zinc-600 { color: #3f3f46 !important; }
        /* Keep white text on primary buttons in light mode */
        #html-root:not(.dark) .btn-primary-light { color: #ffffff !important; }
        #html-root:not(.dark) .voucher-apply-btn { color: #ffffff !important; }
        /* Green/emerald buttons: white text in light mode */
        #html-root:not(.dark) .btn-green-light { color: #ffffff !important; }
        /* Stripe button: keep white text in light mode */
        #html-root:not(.dark) .btn-stripe-light { color: #ffffff !important; }
        /* Admin Stocks Save Changes: keep white text on dark button in light mode */
        #html-root:not(.dark) .admin-save-btn { color: #ffffff !important; }
        /* Admin Orders Send message: keep white text on dark button in light mode */
        #html-root:not(.dark) .admin-send-btn { color: #ffffff !important; }
        /* Admin Orders Fulfill button: keep white text on dark button in light mode */
        #html-root:not(.dark) .admin-fulfill-btn { color: #ffffff !important; }
        /* Buyer Request OTP button: keep white text on dark button in light mode */
        #html-root:not(.dark) .request-otp-btn { color: #ffffff !important; }
        /* Buyer send message button: keep white icon on dark button in light mode */
        #html-root:not(.dark) .buyer-send-btn { color: #ffffff !important; }
        #html-root:not(.dark) .buyer-send-btn i { color: #ffffff !important; }
        /* Admin login Authenticate button: keep white text on dark button in light mode */
        #html-root:not(.dark) .admin-auth-btn { color: #ffffff !important; background-color: #111827 !important; }
        #html-root:not(.dark) .admin-auth-btn:hover { background-color: #1f2937 !important; }
        /* Admin settings buttons: keep white text on dark button in light mode */
        #html-root:not(.dark) .admin-settings-btn { color: #ffffff !important; background-color: #111827 !important; }
        #html-root:not(.dark) .admin-settings-btn:hover { background-color: #1f2937 !important; }
        /* Success page Check Status button: black/dark with white text (all themes) */
        .success-check-status-btn,
        .success-check-status-btn:hover,
        .success-check-status-btn:focus,
        button.success-check-status-btn,
        #html-root .success-check-status-btn,
        #html-root:not(.dark) .success-check-status-btn { color: #ffffff !important; background-color: #111827 !important; }
        .success-check-status-btn:hover { background-color: #1f2937 !important; }

        /* Use Wallet toggle switch */
        .wallet-toggle-input { position: absolute; opacity: 0; width: 0; height: 0; }
        .wallet-toggle-track {
            display: block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
            border-radius: 9999px;
            background-color: #3f3f46;
            transition: background-color 0.2s ease;
            position: relative;
        }
        .wallet-toggle-track::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            border-radius: 9999px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
        }
        .wallet-toggle-input:checked + .wallet-toggle-track {
            background-color: #10b981;
        }
        .wallet-toggle-input:checked + .wallet-toggle-track::after {
            transform: translateX(20px);
        }
        .wallet-toggle-input:disabled + .wallet-toggle-track {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* Toast Container */
        #toast-container {
            position: fixed;
            top: 4.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 90%;
            max-width: 350px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: #18181b;
            padding: 10px 14px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.3s ease-out forwards;
        }
        #html-root.dark .toast {
            background: rgba(20, 20, 20, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.8);
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            border-radius: 50%;
            border: 2px solid currentColor;
            border-top-color: transparent;
            animation: spinner-rotate 0.8s linear infinite;
        }
        .spinner-sm { width: 14px; height: 14px; border-width: 2px; }
        .spinner-md { width: 24px; height: 24px; border-width: 2px; }
        .spinner-lg { width: 32px; height: 32px; border-width: 3px; }
        @keyframes spinner-rotate {
            to { transform: rotate(360deg); }
        }

        /* Confirm Payment: advanced white preloader (visible on green in light & dark) */
        .confirm-preloader {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: #ffffff;
        }
        .confirm-preloader .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ffffff;
            animation: confirm-preloader-bounce 0.6s ease-in-out infinite both;
        }
        .confirm-preloader .dot:nth-child(1) { animation-delay: 0s; }
        .confirm-preloader .dot:nth-child(2) { animation-delay: 0.15s; }
        .confirm-preloader .dot:nth-child(3) { animation-delay: 0.3s; }
        @keyframes confirm-preloader-bounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* V2 Specific Styles */
        .v2-gradient-bg {
            background: linear-gradient(135deg, #f6f7f9 0%, #ffffff 100%);
        }
        #html-root.dark .v2-gradient-bg {
            background: linear-gradient(135deg, #09090b 0%, #18181b 100%);
        }
        /* Force peso and numbers to use Poppins or sans-serif fallback (no serif) */
        .price-poppins {
            font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }
    </style>
    <script>
        (function() {
            const stored = localStorage.getItem('stakz_theme');
            const isDark = stored !== null ? stored === 'dark' : false;
            document.documentElement.classList.toggle('dark', isDark);
        })();
    </script>
</head>
<body>

    <div id="toast-container"></div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
        <div class="bg-zinc-900 border border-white/10 p-6 rounded-lg max-w-xs w-full shadow-2xl transform scale-95 transition-transform duration-200 mx-4" id="modal-content">
            <div class="flex flex-col items-center text-center mb-4">
                <div class="w-10 h-10 bg-zinc-800 rounded-full flex items-center justify-center mb-3 text-zinc-400" id="modal-icon">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                </div>
                <h3 id="modal-title" class="text-lg font-bold text-white tracking-tight">Confirm Action</h3>
            </div>
            <p id="modal-message" class="text-zinc-400 text-xs mb-6 leading-relaxed text-center">Are you sure you want to proceed?</p>
            <div class="flex gap-3">
                <button onclick="window.closeModal()" class="flex-1 py-3 text-[10px] font-bold uppercase text-zinc-400 hover:text-white transition-colors bg-zinc-800/50 hover:bg-zinc-800 rounded-sm tracking-wider border border-white/5">Cancel</button>
                <button onclick="window.confirmModalAction()" class="flex-1 py-3 text-[10px] font-bold uppercase text-black bg-white hover:bg-zinc-200 transition-colors rounded-sm tracking-wider shadow-lg" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md hidden opacity-0 transition-opacity duration-200">
        <div class="bg-zinc-900 border border-white/10 p-6 rounded-lg max-w-md w-full shadow-2xl transform scale-95 transition-transform duration-200 mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-sm font-bold uppercase tracking-widest text-white">Add New Product</h3>
                <button onclick="window.closeAddProductModal()" class="text-zinc-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Title</label>
                    <input type="text" id="new-prod-title" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="e.g. SHEIN ACCT (100c)" />
                </div>
                <div>
                    <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Tag</label>
                    <input type="text" id="new-prod-tag" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="e.g. HOT SALE" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Price (₱)</label>
                        <input type="number" id="new-prod-price" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="0" />
                    </div>
                    <div>
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Initial Stock</label>
                        <input type="number" id="new-prod-stock" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="0" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Bulk Price (₱)</label>
                        <input type="number" id="new-prod-bulk-price" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="0" />
                    </div>
                    <div>
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Bulk Threshold</label>
                        <input type="number" id="new-prod-bulk-thresh" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" value="10" />
                    </div>
                </div>
                <div>
                    <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Description</label>
                    <textarea id="new-prod-desc" rows="3" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="Product details..."></textarea>
                </div>
                <button onclick="window.submitNewProduct()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white btn-green-light font-bold py-3 text-[10px] uppercase tracking-widest rounded-sm transition-colors mt-2">
                    Create Product
                </button>
            </div>
        </div>
    </div>

    <div id="app" class="w-full min-h-screen bg-zinc-50 dark:bg-black overflow-x-hidden relative text-zinc-900 dark:text-zinc-100 flex flex-col text-sm">
        <div class="flex items-center justify-center min-h-screen w-full">
            <div class="flex flex-col items-center gap-4 px-6">
                <div class="spinner spinner-lg text-emerald-500" aria-hidden="true"></div>
                <span class="text-xs font-mono text-zinc-500 uppercase tracking-widest">Connecting...</span>
                <span class="text-[10px] text-zinc-600 font-mono">Initializing database</span>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const SITE_NAME = "StakzShop";
        const GCASH_QR_URL = "https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg"; 
        const GCASH_NUMBER = "0917 123 4567";
        const apiKey = ""; // Enter Gemini API Key Here
        const NOTIFICATION_SOUND = new Audio("data:audio/mp3;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAeAAAJxgAHCxUVFxceHyEhISIlJioqKi0vMjIyMjU4Ozs7O0BAQ0NDQ0dKSk5OTlFUVVVVVVhZWlpaWl5hYmJiYmRlZmZmZmlsbGxsbG9wc3NzHM/+/wAAACxMYXZjNTguOTEuMTAwAAAAAAAAAAAAAAAAIAGQAAAAAAAAAAAAAA//7UGQAAABpE/X/sUACAaovv/4QAAJ2B/S/s0AAAAA0gAAAAABH//gAAAAAAAAAAAAAAAB9//gAAAAAAAAAAAAAAAB//4AAAAAAAAAAAAAAAH//+AAAAAAAAAAAAAAA//tQZAAACjWDO/2CgAAAA0gAAAAABJ8X9L+zQAAAAA0gAAAAAB//4AAAAAAAAAAAAAAAH//gAAAAAAAAAAAAAAAf/+AAAAAAAAAAAAAAAB//4AAAAAAAAAAAAAAD/+1BkAAAKQYNJ/YSAAAAADSAAAAAAEoxf0v7NAAAAANIAAAAAAf/+AAAAAAAAAAAAAAAB//4AAAAAAAAAAAAAAAH//gAAAAAAAAAAAAAAAf/+AAAAAAAAAAAAAAA//tQZAAACimDR/2EgAAAAA0gAAAAABKEX9L+zQAAAAA0gAAAAAB//4AAAAAAAAAAAAAAAH//gAAAAAAAAAAAAAAAf/+AAAAAAAAAAAAAAAB//4AAAAAAAAAAAAAAD/+1BkAAAJoX9H/YSAAAAADSAAAAAAEkhf0v7NAAAAANIAAAAAAf/+AAAAAAAAAAAAAAAB//4AAAAAAAAAAAAAAAH//gAAAAAAAAAAAAAAAf/+AAAAAAAAAAAAAAA//tQZAAACcl/S/2EgAAAAA0gAAAAABIQX9L+zQAAAAA0gAAAAAB//4AAAAAAAAAAAAAAAH//gAAAAAAAAAAAAAAAf/+AAAAAAAAAAAAAAAB//4AAAAAAAAAAAAAAD/+1BkAAAI4X9L/YSAAAAADSAAAAAAEcBf0v7NAAAAANIAAAAAAf/+AAAAAAAAAAAAAAAB//4AAAAAAAAAAAAAAAH//gAAAAAAAAAAAAAAAf/+AAAAAAAAAAAAAAA//tQZAAAB8F/S/2EgAAAAA0gAAAAABCgX9L+zQAAAAA0gAAAAAB//4AAAAAAAAAAAAAAAH//gAAAAAAAAAAAAAAAf/+AAAAAAAAAAAAAAAB//4AAAAAAAAAAAAAAD/+1BkAAAAAA0gAAAAAAAAADSAAAAAACAAIAAAAAAAgACAAAAAAH//gAAAAAAAAAAAAAAAf/+AAAAAAAAAAAAAAAB//4AAAAAAAAAAAAAAAH//gAAAAAAAAAAAAAA");
        const RECAPTCHA_SITE_KEY = "6LcMHmwsAAAAAFu2VXOqspB0JuzGLyHM-oWjTcoX";
        const TURNSTILE_SITE_KEY = "0x4AAAAAACcm7IGyb3q3w9nr";

        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://kbecxughnfneiyyxsizb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiZWN4dWdobmZuZWl5eXhzaXpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODkxOTcsImV4cCI6MjA4NjY2NTE5N30.m4c9DdUsoCbOJ1arpZ_-3Pb8rXwtGamoGtTLE9grdig';
        
        let supabaseClient;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) {
            console.error("Supabase failed to init:", e);
        }

        // Stripe: base URL for Supabase Edge Functions (same project as SUPABASE_URL)
        const STRIPE_FUNCTIONS_BASE = SUPABASE_URL.replace(/\/$/, '') + '/functions/v1';

        // --- State Management ---
        const state = {
            view: 'home',
            uiVariant: localStorage.getItem('stakz_ui_variant') || 'v2', // 'v1' = Classic, 'v2' = Modern (default)
            user: null,
            userProfile: null, // Stores credits and last spin
            products: [],
            orders: [],
            userOrders: [],
            selectedProduct: null,
            quantity: 1,
            refNumber: '',
            paymentMethod: 'gcash', // 'gcash' | 'stripe'
            lastOrderId: null,
            trackerInput: '',
            searchResult: null,
            adminAuth: false,
            adminTab: 'orders',
            activeFulfillmentId: null,
            fulfillmentText: '',
            aiLoading: false,
            aiContent: null,
            discount: 0,
            isSubmitting: false,
            authLoading: false,
            modalCallback: null,
            sessionOrderCount: 0,
            selectedOrderId: null,
            paymentSettings: { payment_qr_url: '', payment_number: '', captcha_provider: 'recaptcha' },
            captchaToken: null,
            payWithCredits: false
        };

        // --- Helpers ---
        function toggleTheme() {
            const root = document.documentElement;
            const isDark = root.classList.toggle('dark');
            localStorage.setItem('stakz_theme', isDark ? 'dark' : 'light');
            render(false);
        }
        
        function toggleUiVariant() {
            state.uiVariant = state.uiVariant === 'v1' ? 'v2' : 'v1';
            localStorage.setItem('stakz_ui_variant', state.uiVariant);
            render(true);
            showToast(`Switched to ${state.uiVariant === 'v2' ? 'Modern' : 'Classic'} UI`, 'info');
        }

        const formatPHP = (amount) => new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount);
        /* Use "PHP" instead of ₱ so the whole price renders in Poppins (₱ often falls back to serif) */
        const formatPHPPoppins = (amount) => 'PHP ' + new Intl.NumberFormat('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
        const escapeHtml = (s) => ('' + s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        const generateOrderId = () => 'STKZ-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        const GUEST_ORDERS_KEY = 'stakz_guest_order_ids';
        const getGuestOrderIds = () => { try { return JSON.parse(localStorage.getItem(GUEST_ORDERS_KEY) || '[]'); } catch(e) { return []; } };
        const addGuestOrderId = (id) => { const ids = getGuestOrderIds(); if(!ids.includes(id)) { ids.unshift(id); localStorage.setItem(GUEST_ORDERS_KEY, JSON.stringify(ids)); } };
        const removeGuestOrderId = (id) => { const ids = getGuestOrderIds().filter(x => x !== id); localStorage.setItem(GUEST_ORDERS_KEY, JSON.stringify(ids)); };
        const formatDate = (dateStr) => new Date(dateStr).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            let icon = '';
            if (type === 'success') icon = '<i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i>';
            else if (type === 'error') icon = '<i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i>';
            else icon = '<i data-lucide="info" class="w-4 h-4 text-blue-400"></i>';
            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard', 'success'))
                .catch(() => fallbackCopyTextToClipboard(text));
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard', 'success');
            } catch (err) {
                showToast('Copy failed', 'error');
            }
            document.body.removeChild(textArea);
        }

        function togglePassword(id) {
            const input = document.getElementById(id);
            if (input) {
                input.type = input.type === "password" ? "text" : "password";
            }
        }

        function toggleOrderDetails(id) {
            const el = document.getElementById(`order-details-${id}`);
            if (el) el.classList.toggle('hidden');
        }

        function renderOrderAccountsContent(res) {
            if (!res.accounts || res.accounts.length === 0) return '';
            const isDark = document.documentElement.classList.contains('dark');
            return `
            <div class="mt-4 border-t border-dashed ${isDark ? 'border-zinc-800' : 'border-gray-300'} pt-4">
                <h4 class="text-[9px] font-bold uppercase mb-2 ${isDark ? 'text-zinc-400' : 'text-gray-600'} tracking-wider flex items-center gap-2"><i data-lucide="key" class="w-3 h-3 ${isDark ? 'text-zinc-400' : 'text-gray-600'}"></i> Access Details</h4>
                <div class="space-y-2">
                    ${res.accounts.map((acc, idx) => {
                        const otp = acc.otpRequest || { status: 'idle', code: null };
                        // Check if on cooldown (applies to all statuses)
                        let isOnCooldown = false;
                        let cooldownSeconds = 0;
                        if(otp.requestedAt) {
                            const lastRequestTime = new Date(otp.requestedAt).getTime();
                            const now = new Date().getTime();
                            const timeSinceLastRequest = (now - lastRequestTime) / 1000; // seconds
                            const cooldownDuration = 2 * 60; // 2 minutes in seconds
                            if(timeSinceLastRequest < cooldownDuration) {
                                isOnCooldown = true;
                                cooldownSeconds = Math.ceil(cooldownDuration - timeSinceLastRequest);
                            }
                        }
                        return `
                    <div class="${isDark ? 'bg-zinc-800/30' : 'bg-gray-50'} border ${acc.used ? (isDark ? 'border-zinc-700/50 opacity-50' : 'border-gray-300 opacity-50') : (isDark ? 'border-emerald-500/20' : 'border-emerald-500/40')} p-3 rounded-md">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] ${isDark ? 'text-zinc-500' : 'text-gray-600'} font-mono">Slot #${idx + 1}</span>
                            <button onclick="window.toggleAccountUsed('${res.id}', '${acc.id}')" class="text-[8px] ${acc.used ? (isDark ? 'text-zinc-500' : 'text-gray-500') : (isDark ? 'text-zinc-400 hover:text-white' : 'text-gray-600 hover:text-gray-900')} uppercase font-bold">
                                ${acc.used ? 'Used' : 'Mark Used'}
                            </button>
                        </div>
                        ${(() => {
                            const sep = (acc.creds || '').indexOf(':');
                            const email = sep >= 0 ? acc.creds.slice(0, sep) : acc.creds;
                            const pass = sep >= 0 ? acc.creds.slice(sep + 1) : '';
                            return `
                        <div class="space-y-1.5 mb-3">
                            <div>
                                <span class="text-[8px] ${isDark ? 'text-zinc-500' : 'text-gray-600'} uppercase font-bold block mb-0.5">Email</span>
                                <span class="font-mono text-xs select-all break-all ${acc.used ? (isDark ? 'line-through text-zinc-600' : 'line-through text-gray-400') : (isDark ? 'text-white' : 'text-gray-900')}">${escapeHtml(email)}</span>
                            </div>
                            ${pass ? `
                            <div>
                                <span class="text-[8px] ${isDark ? 'text-zinc-500' : 'text-gray-600'} uppercase font-bold block mb-0.5">Password</span>
                                <span class="font-mono text-xs select-all break-all ${acc.used ? (isDark ? 'line-through text-zinc-600' : 'line-through text-gray-400') : 'text-emerald-500'}">${escapeHtml(pass)}</span>
                            </div>` : ''}
                        </div>`;
                        })()}
                        <div class="${isDark ? 'bg-zinc-800/20 border-white/5' : 'bg-gray-100 border-gray-300'} p-2 rounded border">
                            ${otp.status === 'sent' ? `
                            <div class="mb-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-[9px] font-bold ${isDark ? 'text-zinc-500' : 'text-gray-600'} uppercase">2FA CODE:</span>
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono font-bold ${isDark ? 'text-white' : 'text-gray-900'} text-sm tracking-widest">${otp.code}</span>
                                        <i data-lucide="copy" class="w-3 h-3 ${isDark ? 'text-zinc-500 hover:text-white' : 'text-gray-600 hover:text-gray-900'} cursor-pointer" onclick="window.copyToClipboard('${otp.code}')"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between w-full pt-2 border-t ${isDark ? 'border-white/5' : 'border-gray-300'}">
                                <span class="text-[8px] ${isDark ? 'text-zinc-500' : 'text-gray-600'} uppercase">Need a new code?</span>
                                ${isOnCooldown ? `
                                <button disabled class="${isDark ? 'bg-zinc-800/50 text-zinc-500 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed'} text-[8px] font-bold px-2 py-0.5 uppercase rounded-sm tracking-wide">Wait ${cooldownSeconds}s</button>
                                ` : `
                                <button onclick="window.requestOtp('${res.id}', '${acc.id}')" class="${isDark ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-gray-800 hover:bg-gray-700 text-white request-otp-btn'} text-[8px] font-bold px-2 py-0.5 uppercase transition-colors rounded-sm tracking-wide">Request New OTP</button>
                                `}
                            </div>` : otp.status === 'pending' ? `
                            <div class="flex items-center gap-2 w-full text-yellow-500/80 justify-center py-0.5">
                                <span class="spinner spinner-sm text-yellow-500 shrink-0"></span>
                                <span class="text-[8px] font-bold uppercase tracking-wide font-mono">Waiting for Admin...</span>
                            </div>` : isOnCooldown ? `
                            <div class="flex items-center justify-between w-full">
                                <span class="text-[8px] ${isDark ? 'text-zinc-500' : 'text-gray-600'} uppercase">Verify Login</span>
                                <button disabled class="${isDark ? 'bg-zinc-800/50 text-zinc-500 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed'} text-[8px] font-bold px-2 py-0.5 uppercase rounded-sm tracking-wide">Wait ${cooldownSeconds}s</button>
                            </div>` : `
                            <div class="flex items-center justify-between w-full">
                                <span class="text-[8px] ${isDark ? 'text-zinc-500' : 'text-gray-600'} uppercase">Verify Login</span>
                                <button onclick="window.requestOtp('${res.id}', '${acc.id}')" class="${isDark ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-gray-800 hover:bg-gray-700 text-white request-otp-btn'} text-[8px] font-bold px-2 py-0.5 uppercase transition-colors rounded-sm tracking-wide">Request OTP</button>
                            </div>`}
                            <div class="border-t ${isDark ? 'border-white/5' : 'border-gray-300'} pt-2 mt-2">
                                ${acc.messages && acc.messages.length > 0 ? `
                                <div class="mb-2 space-y-1 max-h-20 overflow-y-auto custom-scrollbar">
                                    ${acc.messages.map(msg => `
                                        <div class="text-[8px] ${msg.sender === 'admin' ? 'text-emerald-400' : (isDark ? 'text-zinc-400' : 'text-gray-600')} font-mono">
                                            <span class="uppercase font-bold">${msg.sender}:</span> ${msg.text}
                                        </div>
                                    `).join('')}
                                </div>` : ''}
                                <div class="flex gap-2">
                                    <input type="text" id="msg-${acc.id}" placeholder="Report issue..." class="${isDark ? 'bg-zinc-800 border-zinc-700 text-zinc-300 focus:border-zinc-500' : 'bg-white border-gray-300 text-gray-900 focus:border-gray-500'} border text-[9px] px-2 py-1 w-full focus:outline-none rounded-sm" />
                                    <button onclick="window.sendAccountMessage('${res.id}', '${acc.id}', document.getElementById('msg-${acc.id}').value, 'user')" class="${isDark ? 'bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white' : 'bg-gray-800 hover:bg-gray-700 text-white buyer-send-btn'} px-2 rounded-sm"><i data-lucide="send" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        window.onRecaptchaLoad = function() { window.recaptchaReady = true; };

        function renderRecaptcha() {
            const container = document.getElementById('captcha-container');
            if (!container || !window.grecaptcha || !window.recaptchaReady) return;
            if (window.recaptchaWidgetId != null) try { window.grecaptcha.reset(window.recaptchaWidgetId); } catch(e) {}
            container.innerHTML = '';
            window.recaptchaWidgetId = window.grecaptcha.render(container, {
                sitekey: RECAPTCHA_SITE_KEY,
                theme: 'dark',
                callback: function(token) { state.captchaToken = token; },
            });
        }

        function renderTurnstile() {
            const container = document.getElementById('captcha-container');
            if (!container || !window.turnstile) return;
            container.innerHTML = '';
            window.turnstile.render(container, {
                sitekey: TURNSTILE_SITE_KEY,
                theme: 'dark',
                callback: function(token) { state.captchaToken = token; },
            });
        }

        function renderCaptcha() {
            const provider = (state.paymentSettings?.captcha_provider || 'recaptcha');
            if (provider === 'turnstile') {
                if (window.turnstile) renderTurnstile();
                else setTimeout(renderCaptcha, 200);
            } else {
                if (window.recaptchaReady && window.grecaptcha) renderRecaptcha();
                else setTimeout(renderCaptcha, 300);
            }
        }

        // --- Modal Logic ---
        function showModal(title, message, callback, type = 'danger', confirmText = 'Confirm') {
            const modal = document.getElementById('confirmation-modal');
            const modalContent = document.getElementById('modal-content');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.textContent = confirmText;
            const iconContainer = document.getElementById('modal-icon');
            if (type === 'danger') {
                confirmBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase text-white bg-red-600 hover:bg-red-500 transition-colors rounded-sm tracking-wider shadow-lg shadow-red-900/20";
                iconContainer.className = "w-10 h-10 bg-red-500/10 rounded-full flex items-center justify-center mb-3 text-red-500";
                iconContainer.innerHTML = '<i data-lucide="alert-triangle" class="w-5 h-5"></i>';
            } else if (type === 'warning') {
                confirmBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase text-black bg-orange-400 hover:bg-orange-300 transition-colors rounded-sm tracking-wider shadow-lg shadow-orange-900/20";
                iconContainer.className = "w-10 h-10 bg-orange-500/10 rounded-full flex items-center justify-center mb-3 text-orange-500";
                iconContainer.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5"></i>';
            } else {
                confirmBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase text-black bg-white hover:bg-zinc-200 transition-colors rounded-sm tracking-wider shadow-lg";
                iconContainer.className = "w-10 h-10 bg-zinc-800 rounded-full flex items-center justify-center mb-3 text-white";
                iconContainer.innerHTML = '<i data-lucide="info" class="w-5 h-5"></i>';
            }
            state.modalCallback = callback;
            lucide.createIcons();
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            });
        }

        function closeModal() {
            const modal = document.getElementById('confirmation-modal');
            const modalContent = document.getElementById('modal-content');
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                state.modalCallback = null;
            }, 200);
        }

        function confirmModalAction() {
            if (state.modalCallback) state.modalCallback();
            closeModal();
        }

        function openAddProductModal() {
            const modal = document.getElementById('add-product-modal');
            const modalContent = modal.querySelector('div');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            });
        }

        function closeAddProductModal() {
            const modal = document.getElementById('add-product-modal');
            const modalContent = modal.querySelector('div');
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        // --- Core Application Functions (Defined before usage) ---

        async function callGemini(prompt, type) {
            state.aiLoading = true;
            state.aiContent = null;
            render(false); 

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    }
                );
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "System busy.";
                state.aiContent = { type, text };
            } catch (e) {
                console.error(e);
                state.aiContent = { type, text: "Connection error. Check API Key." };
            }
            
            state.aiLoading = false;
            render(false); 
        }

        async function submitNewProduct() {
            const title = document.getElementById('new-prod-title').value;
            const tag = document.getElementById('new-prod-tag').value;
            const price = document.getElementById('new-prod-price').value;
            const stock = document.getElementById('new-prod-stock').value;
            const bulkPrice = document.getElementById('new-prod-bulk-price').value;
            const bulkThresh = document.getElementById('new-prod-bulk-thresh').value;
            const desc = document.getElementById('new-prod-desc').value;

            if(!title || !price || !stock) return showToast("Title, Price and Stock are required", "error");

            const { error } = await supabaseClient.from('products').insert([{
                title, tag, price, stock, 
                bulk_price: bulkPrice || price,
                bulk_threshold: bulkThresh || 10,
                description: desc,
                color: 'bg-zinc-900'
            }]);

            if(error) showToast("Failed to create product", "error");
            else {
                showToast("Product Created", "success");
                closeAddProductModal();
                fetchProducts();
            }
        }

        async function saveProductChanges(id) {
            const title = document.getElementById(`prod-title-${id}`).value;
            const price = document.getElementById(`prod-price-${id}`).value;
            const stock = document.getElementById(`prod-stock-${id}`).value;

            const { error } = await supabaseClient.from('products').update({
                title, price, stock
            }).eq('id', id);

            if(error) showToast("Failed to save changes", "error");
            else showToast("Changes saved", "success");
        }

        async function fetchProducts() {
            if(!supabaseClient) return;
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .order('id', { ascending: true });

            if (data) {
                state.products = data;
                if(state.view === 'admin' && state.adminTab === 'products') render(false);
                else if(state.view === 'home') render(false);
            }
        }

        async function fetchPaymentSettings() {
            if (!supabaseClient) return;
            const { data, error } = await supabaseClient.from('settings').select('key, value');
            if (!error && data && data.length) {
                const map = {};
                data.forEach(r => { map[r.key] = r.value || ''; });
                const provider = (map.captcha_provider || '').trim().toLowerCase();
                state.paymentSettings = {
                    payment_qr_url: map.payment_qr_url || '',
                    payment_number: map.payment_number || '',
                    captcha_provider: (provider === 'turnstile' ? 'turnstile' : 'recaptcha')
                };
            }
        }

        function getPaymentQrUrl() {
            const url = (state.paymentSettings?.payment_qr_url || '').trim();
            return url || GCASH_QR_URL;
        }

        function getPaymentNumber() {
            const num = (state.paymentSettings?.payment_number || '').trim();
            return num || GCASH_NUMBER;
        }

        async function fetchAllOrders() {
            if(!supabaseClient || !state.adminAuth) return;
            const { data, error } = await supabaseClient
                .from('orders')
                .select('*')
                .order('created_at', { ascending: false });

            if (data) {
                state.orders = data.map(mapOrderData);
                render(false);
            }
        }

        async function fetchUserOrders() {
            if(!supabaseClient || !state.user) return;
            const { data, error } = await supabaseClient
                .from('orders')
                .select('*')
                .eq('user_id', state.user.id)
                .order('created_at', { ascending: false });

            if(data) state.userOrders = data.map(mapOrderData);
        }

        async function fetchGuestOrders() {
            if(!supabaseClient) return;
            const ids = getGuestOrderIds();
            if(ids.length === 0) { state.userOrders = []; return; }
            const { data, error } = await supabaseClient
                .from('orders')
                .select('*')
                .in('id', ids)
                .order('created_at', { ascending: false });
            if(data) {
                const byId = Object.fromEntries(data.map(o => [o.id, o]));
                state.userOrders = ids.filter(id => byId[id]).map(id => mapOrderData(byId[id]));
            } else state.userOrders = [];
        }

        async function fetchUserProfile() {
            if(!supabaseClient || !state.user) return;
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', state.user.id)
                    .single();
                
                if(error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    console.error('Fetch profile error:', error);
                }
                
                if(data) {
                    state.userProfile = data;
                } else {
                    // Create profile if it doesn't exist (ensures credits are recorded)
                    state.userProfile = { id: state.user.id, credits: 0, last_spin_at: null };
                    await supabaseClient.from('profiles').upsert({
                        id: state.user.id,
                        credits: 0,
                        last_spin_at: null
                    }, { onConflict: 'id' });
                }
            } catch(e) {
                console.error('Profile fetch exception:', e);
            }
        }

        function mapOrderData(o) {
            return {
                id: o.id,
                date: o.created_at,
                product: o.product_title,
                quantity: o.quantity,
                total: o.total,
                refNumber: o.ref_number,
                creditsUsed: o.credits_used ?? 0,
                status: o.status,
                accounts: o.accounts_data || [],
                refundRequest: o.refund_request || null,
                userId: o.user_id
            };
        }

        function setupRealtime() {
            if(!supabaseClient) return;
            
            supabaseClient.channel('public:products')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => fetchProducts())
            .subscribe();

            supabaseClient.channel('public:orders')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
                if(state.adminAuth && payload.eventType === 'UPDATE' && payload.new.accounts_data) {
                    const hasUnread = payload.new.accounts_data.some(acc => 
                        acc.messages && acc.messages.some(m => m.sender === 'user' && !m.read)
                    );
                    if(hasUnread) {
                        try { NOTIFICATION_SOUND.play(); } catch(e) {}
                    }
                }

                if(state.adminAuth) fetchAllOrders();
                if(state.user) fetchUserOrders().then(() => {
                    if (state.view === 'my-orders') render(false);
                });
                if(!state.user && state.view === 'my-orders') fetchGuestOrders().then(() => render(false));
                if(state.view === 'tracker' && state.trackerInput) handleTrack(true);
            })
            .subscribe();
        }

        async function markMessagesRead(orderId) {
            const { data } = await supabaseClient.from('orders').select('accounts_data').eq('id', orderId).single();
            if(!data) return;

            let hasUpdates = false;
            const updatedAccounts = data.accounts_data.map(acc => {
                if(acc.messages && acc.messages.some(m => m.sender === 'user' && !m.read)) {
                    hasUpdates = true;
                    return {
                        ...acc,
                        messages: acc.messages.map(m => m.sender === 'user' ? {...m, read: true} : m)
                    };
                }
                return acc;
            });

            if(hasUpdates) {
                await supabaseClient.from('orders').update({ accounts_data: updatedAccounts }).eq('id', orderId);
            }
        }

        async function initAuth() {
            if(!supabaseClient) return;
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                state.user = session.user;
                await fetchUserOrders();
                await fetchUserProfile();
            }

            supabaseClient.auth.onAuthStateChange(async (_event, session) => {
                state.user = session ? session.user : null;
                if(state.user) {
                    await fetchUserOrders();
                    await fetchUserProfile();
                }
                render();
            });
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            if(!email || !pass) return showToast("Please fill all fields", "error");

            state.authLoading = true;
            render(false);

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
            state.authLoading = false;
            
            if(error) {
                showToast(error.message, "error");
                render(false);
            } else {
                showToast("Login Successful", "success");
                state.user = data.user;
                await fetchUserProfile();
                goHome();
            }
        }

        async function handleRegister() {
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            if(!email || !pass) return showToast("Please fill all fields", "error");
            if(pass.length < 6) return showToast("Password must be 6+ chars", "error");

            const acctCount = parseInt(localStorage.getItem('stakz_acct_count') || '0');
            if (acctCount >= 1 && !state.captchaToken) return showToast("Please complete the captcha", "error");

            state.authLoading = true;
            render(false);

            const { data, error } = await supabaseClient.auth.signUp({ email, password: pass });
            state.authLoading = false;

            if(error) {
                showToast(error.message, "error");
                render(false);
            } else {
                showToast("Account created! Logging in...", "success");
                localStorage.setItem('stakz_acct_count', (acctCount + 1).toString());
                
                // Ensure profile is created with credits/last_spin_at (same as spin.html)
                if(data.user) {
                    await supabaseClient.from('profiles').upsert({
                        id: data.user.id,
                        credits: 0,
                        last_spin_at: null
                    }, { onConflict: 'id' });
                }

                if(data.session) {
                    state.user = data.user;
                    await fetchUserProfile();
                    goHome();
                } else {
                    showToast("Please check email for verification link", "info");
                    setView('login');
                }
            }
        }

        async function handlePasswordReset() {
            const email = document.getElementById('resetEmail').value;
            if(!email) return showToast("Please enter your email", "error");

            state.authLoading = true;
            render(false);

            const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
            state.authLoading = false;
            render(false);

            if(error) showToast(error.message, "error");
            else {
                showToast("Password reset link sent to email", "success");
                setView('login');
            }
        }

        async function handleUserLogout() {
            await supabaseClient.auth.signOut();
            state.user = null;
            state.userOrders = [];
            goHome();
            showToast("Logged out", "success");
        }

        function goHome() { setView('home'); }

        function setView(view) {
            state.view = view;
            if (view !== 'my-orders') state.selectedOrderId = null;
            if(view === 'home' || view === 'product') {
                state.discount = 0; 
                state.quantity = 1;
                state.captchaToken = null;
                state.payWithCredits = false;
            }
            if (view === 'admin' && state.adminAuth) fetchAllOrders();
            if (view === 'my-orders') {
                if (state.user) fetchUserOrders().then(() => render(false));
                else fetchGuestOrders().then(() => render(false));
            }
            render();
        }

        function selectProduct(id) {
            state.selectedProduct = state.products.find(p => p.id === id);
            if(state.selectedProduct.stock <= 0) return showToast("Item out of stock", "error");
            state.quantity = 1;
            setView('product');
        }

        function updateQuantity(change) {
            const newQty = state.quantity + change;
            if (newQty >= 1) {
                state.quantity = newQty;
                render(false);
            }
        }

        function getPrice() {
            if (!state.selectedProduct) return 0;
            return state.quantity >= state.selectedProduct.bulk_threshold 
                ? state.selectedProduct.bulk_price 
                : state.selectedProduct.price;
        }

        function applyDiscount() {
            const input = document.getElementById('discountInput');
            if(!input) return;
            const code = input.value.trim().toUpperCase();
            if (code === 'TEST1111') {
                if (state.discount > 0) return showToast("Discount already applied", "info");
                state.discount = 0.05; 
                showToast("Voucher Applied: 5% OFF", "success");
                render(false); 
            } else if (code === '') {
                showToast("Please enter a code", "error");
            } else {
                showToast("Invalid Voucher Code", "error");
            }
        }

        function togglePayWithCredits() {
            if ((state.userProfile?.credits || 0) <= 0) return;
            state.payWithCredits = !state.payWithCredits;
            render(false);
        }

        function setPaymentMethod(method) {
            state.paymentMethod = method === 'stripe' ? 'stripe' : 'gcash';
        }

        async function createStripeCheckoutAndRedirect() {
            if (!state.selectedProduct) return showToast("No product selected", "error");
            const baseTotal = getPrice() * state.quantity;
            const finalTotal = baseTotal - (baseTotal * state.discount);
            const credits = parseFloat(state.userProfile?.credits || 0);
            const creditsUsed = state.payWithCredits ? Math.min(credits, finalTotal) : 0;
            const amountToCharge = finalTotal - creditsUsed;
            if (amountToCharge <= 0) return showToast("Use Confirm Payment for credits-only orders", "info");
            // Stripe requires total to be at least ~$0.50 USD (~₱30)
            const STRIPE_MIN_PHP = 30;
            if (amountToCharge < STRIPE_MIN_PHP) return showToast("Stripe minimum is ₱" + STRIPE_MIN_PHP + " (~$0.50). Use Manual Transfer for smaller amounts.", "error");

            state.isSubmitting = true;
            render(false);

            if (creditsUsed > 0) {
                const newCredits = credits - creditsUsed;
                const { error: credErr } = await supabaseClient.from('profiles').update({ credits: newCredits }).eq('id', state.user.id);
                if (credErr) {
                    state.isSubmitting = false;
                    render(false);
                    return showToast("Payment failed", "error");
                }
                if (state.userProfile) state.userProfile = { ...state.userProfile, credits: newCredits };
            }

            const baseUrl = window.location.origin + window.location.pathname;
            const successUrl = baseUrl + '?stripe=success&session_id={CHECKOUT_SESSION_ID}';
            const cancelUrl = baseUrl + (window.location.hash || '#checkout');

            try {
                const res = await fetch(STRIPE_FUNCTIONS_BASE + '/create-stripe-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + SUPABASE_KEY },
                    body: JSON.stringify({
                        product_title: state.selectedProduct.title,
                        quantity: state.quantity,
                        total_php: Math.round(amountToCharge),
                        user_id: state.user ? state.user.id : null,
                        credits_used: creditsUsed,
                        success_url: successUrl,
                        cancel_url: cancelUrl
                    })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    state.isSubmitting = false;
                    render(false);
                    return showToast(data.message || "Stripe checkout failed", "error");
                }
                if (data.url) {
                    window.location.href = data.url;
                    return;
                }
            } catch (e) {
                console.error("Stripe checkout error:", e);
                const msg = (e && e.message) ? e.message : "Network error. Try again.";
                if (msg.includes("Failed to fetch") || msg.includes("NetworkError")) {
                    showToast("Cannot reach payment server. Deploy the Supabase Edge Functions (see STRIPE_SETUP.md) and open this page from a web URL (not file://).", "error");
                } else {
                    showToast(msg, "error");
                }
            }
            state.isSubmitting = false;
            render(false);
        }

        async function confirmStripeOrder(sessionId) {
            if (!sessionId) return;
            try {
                const res = await fetch(STRIPE_FUNCTIONS_BASE + '/confirm-stripe-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + SUPABASE_KEY },
                    body: JSON.stringify({ session_id: sessionId })
                });
                const data = await res.json().catch(() => ({}));
                if (res.ok && data.order_id) {
                    state.lastOrderId = data.order_id;
                    if (state.user) fetchUserOrders();
                    else addGuestOrderId(data.order_id);
                    setView('success');
                    showToast("Order submitted successfully", "success");
                } else {
                    showToast(data.message || "Could not confirm order", "error");
                }
            } catch (e) {
                console.error(e);
                showToast("Could not confirm order", "error");
            }
        }

        async function submitOrder() {
            const refInput = document.getElementById('refNumberInput');
            const baseTotal = getPrice() * state.quantity;
            const finalTotal = baseTotal - (baseTotal * state.discount);
            const credits = parseFloat(state.userProfile?.credits || 0);
            const creditsUsed = state.payWithCredits ? Math.min(credits, finalTotal) : 0;
            const remainingToPay = finalTotal - creditsUsed;

            const refRaw = refInput ? refInput.value.trim() : '';
            const refDigits = (refRaw || '').replace(/\D/g, '');
            if (remainingToPay > 0 && refDigits.length < 4) return showToast("Please enter at least the last 4 digits of your payment reference.", "error");
            if (state.sessionOrderCount >= 3 && !state.captchaToken) return showToast("Please complete the captcha", "error");

            state.isSubmitting = true;
            render(false); 
            
            if (creditsUsed > 0) {
                const newCredits = credits - creditsUsed;
                const { data: updatedProfile, error: credErr } = await supabaseClient
                    .from('profiles')
                    .update({ credits: newCredits })
                    .eq('id', state.user.id)
                    .select()
                    .single();
                if(credErr) {
                    state.isSubmitting = false;
                    render(false);
                    return showToast("Payment failed", "error");
                }
                if (updatedProfile) state.userProfile = updatedProfile;
            }

            const newOrderId = generateOrderId();
            const refNumber = remainingToPay <= 0 ? 'PAID-VIA-CREDITS' : (refInput ? refInput.value.trim() : '');
            const dbPayload = {
                id: newOrderId,
                product_title: state.selectedProduct.title,
                quantity: state.quantity,
                total: finalTotal,
                ref_number: refNumber,
                credits_used: creditsUsed,
                status: 'Processing',
                accounts_data: [],
                refund_request: null,
                user_id: state.user ? state.user.id : null 
            };

            const { error } = await supabaseClient.from('orders').insert([dbPayload]);

            if(error) {
                console.error(error);
                state.isSubmitting = false;
                render(false);
                showToast("Error submitting order. Try again.", "error");
                // Refund credits if failed? Complexity for another time.
                return;
            }

            state.lastOrderId = newOrderId;
            state.sessionOrderCount++;
            state.captchaToken = null; 
            if(state.user) {
                fetchUserOrders(); 
                fetchUserProfile();
            } else {
                addGuestOrderId(newOrderId);
            }
            
            state.isSubmitting = false;
            setView('success');
            showToast("Order submitted successfully", "success");
        }

        async function handleTrack(silent = false) {
            const input = document.getElementById('trackerInputVal');
            if(input) state.trackerInput = input.value.trim();
            
            if(!state.trackerInput && !silent) return showToast("Please enter an Order ID", "error");

            const { data, error } = await supabaseClient.from('orders').select('*').eq('id', state.trackerInput).single();
            if (data) state.searchResult = mapOrderData(data);
            else state.searchResult = 'not-found';
            
            if(!silent) {
                setView('tracker');
            } else {
                render();
            }
        }

        async function cancelOrder(id) {
            showModal('Cancel Order?', 'Are you sure you want to cancel this order? This action cannot be undone.', async () => {
                const { data: order, error: fetchErr } = await supabaseClient.from('orders').select('created_at, user_id, credits_used').eq('id', id).single();
                if (fetchErr || !order) return showToast("Order not found", "error");
                const timeDiff = new Date() - new Date(order.created_at);
                if (timeDiff > 60000 && !state.adminAuth) return showToast('Cancellation window has expired.', 'error');

                const { error } = await supabaseClient.from('orders').update({ status: 'Cancelled' }).eq('id', id);
                if(error) return showToast("Error cancelling order", "error");

                const creditsToRefund = parseFloat(order.credits_used || 0);
                if (creditsToRefund > 0 && order.user_id) {
                    const { data: prof } = await supabaseClient.from('profiles').select('credits').eq('id', order.user_id).single();
                    const newCredits = parseFloat(prof?.credits || 0) + creditsToRefund;
                    await supabaseClient.from('profiles').update({ credits: newCredits }).eq('id', order.user_id);
                    if (state.user?.id === order.user_id) await fetchUserProfile();
                }
                showToast("Order cancelled", "info");
            }, 'danger', 'Yes, Cancel Order');
        }

        async function deleteOrder(id) {
            const isGuest = !state.user;
            const msg = isGuest 
                ? "Remove this order from your local history?" 
                : "This will permanently remove this order from your history.";
            showModal('Delete Order?', msg, async () => {
                if (isGuest) {
                    removeGuestOrderId(id);
                    await fetchGuestOrders();
                    showToast("Removed from history", "success");
                    if (state.view === 'my-orders') render(false);
                    return;
                }
                const { data: order, error: fetchErr } = await supabaseClient.from('orders').select('status').eq('id', id).single();
                if (fetchErr || !order) return showToast("Order not found", "error");
                if (order.status !== 'Cancelled' && order.status !== 'Refunded') return showToast("Only cancelled or refunded orders can be deleted", "error");

                const { error } = await supabaseClient.from('orders').delete().eq('id', id);
                if(error) showToast("Failed to delete", "error");
                else {
                    showToast("Order deleted", "success");
                    await fetchUserOrders();
                    if (state.view === 'my-orders') render(false);
                }
            }, 'danger', isGuest ? 'Remove' : 'Delete');
        }

        async function submitRefundRequest(orderId) {
            const name = document.getElementById('refundName').value;
            const number = document.getElementById('refundNumber').value;
            if (!name || !number) return showToast("Please fill in all refund details", "error");

            const payload = { gcashName: name, gcashNumber: number, requestedAt: new Date().toISOString() };
            const { error } = await supabaseClient.from('orders').update({ status: 'Refund Pending', refund_request: payload }).eq('id', orderId);

            if(error) showToast("Failed to submit refund", "error");
            else showToast("Refund request submitted", "success");
        }

        async function sendAccountMessage(orderId, accId, text, sender) {
            if(!text || !text.trim()) return;

            const { data, error: fetchError } = await supabaseClient.from('orders').select('accounts_data').eq('id', orderId).single();
            if(fetchError || !data) return showToast("Error fetching order", "error");

            const updatedAccounts = data.accounts_data.map(acc => {
                if(acc.id === accId) {
                    const msgs = acc.messages || [];
                    return { 
                        ...acc, 
                        messages: [...msgs, { text: text.trim(), sender: sender, time: new Date().toISOString(), read: false }] 
                    };
                }
                return acc;
            });

            const { error } = await supabaseClient.from('orders').update({ accounts_data: updatedAccounts }).eq('id', orderId);
            if(error) showToast("Message failed to send", "error");
            else {
                showToast("Message sent", "success");
                const inputEl = document.getElementById(sender === 'admin' ? `admin-msg-${accId}` : `msg-${accId}`);
                if(inputEl) inputEl.value = '';
            }
        }

        async function handleAdminLogin() {
            const pass = document.getElementById('adminPassInput').value;
            const { data } = await supabaseClient.from('admins').select('*').eq('username', 'admin').eq('password', pass).single();

            if (data) {
                state.adminAuth = true;
                fetchAllOrders(); 
                render();
                showToast("Welcome back, Admin.", "success");
            } else {
                showToast('Invalid Access Code', 'error');
            }
        }

        function handleAdminLogout() {
            state.adminAuth = false;
            state.orders = []; 
            state.adminTab = 'orders';
            state.activeFulfillmentId = null;
            setView('admin'); 
            showToast("Logged out successfully", "success");
        }

        async function fulfillOrder(id) {
            const emailsEl = document.getElementById('fulfillmentEmailsArea');
            const passwordsEl = document.getElementById('fulfillmentPasswordsArea');
            const emails = (emailsEl?.value || '').trim().split('\n').map(l => l.trim()).filter(Boolean);
            const rawPass = (passwordsEl?.value || '').trim();
            const passwords = rawPass ? [rawPass] : [];
            if (emails.length === 0 || passwords.length === 0) return showToast("Please enter at least one email and one password", "error");

            // Use one password for all emails, or pair by index and reuse last password for extras
            const getPassword = (i) => passwords[Math.min(i, passwords.length - 1)] || '';
            const newAccounts = emails.map((email, index) => ({
                id: `acc-${Date.now()}-${index}`,
                creds: `${email}:${getPassword(index)}`,
                used: false,
                otpRequest: { status: 'idle', code: null, requestedAt: null },
                messages: [] 
            }));

            const { error } = await supabaseClient.from('orders').update({ status: 'Completed', accounts_data: newAccounts }).eq('id', id);
            if(!error) {
                state.activeFulfillmentId = null;
                showToast("Order fulfilled successfully", "success");
            } else showToast("Database Error", "error");
        }

        async function adminAction(id, action) {
            let updatePayload = {};
            let title = '';
            let message = '';
            let btnType = 'danger';
            let btnText = 'Confirm';

            if (action === 'cancel') {
                title = 'Cancel Order?';
                message = 'Are you sure you want to CANCEL this order?';
                updatePayload = { status: 'Cancelled' };
                btnType = 'danger';
                btnText = 'Yes, Cancel';
            } else if (action === 'refund') {
                title = 'Refund Order?';
                message = 'Mark this order as REFUNDED? Ensure payment has been returned.';
                updatePayload = { status: 'Refunded' };
                btnType = 'warning';
                btnText = 'Mark Refunded';
            } else return;

            showModal(title, message, async () => {
                const { error } = await supabaseClient.from('orders').update(updatePayload).eq('id', id);
                if(error) showToast("Action failed", "error");
                else showToast(`Order ${action}ed`, "success");
            }, btnType, btnText);
        }

        async function savePaymentSettings() {
            const url = (document.getElementById('settingsPaymentQrUrl')?.value || '').trim();
            const num = (document.getElementById('settingsPaymentNumber')?.value || '').trim();
            const providerEl = document.getElementById('settingsCaptchaProvider');
            const captchaProvider = providerEl ? (providerEl.value === 'turnstile' ? 'turnstile' : 'recaptcha') : (state.paymentSettings?.captcha_provider || 'recaptcha');

            async function setSetting(key, value) {
                const { data: updated, error: updateErr } = await supabaseClient.from('settings').update({ value }).eq('key', key).select('key');
                if (updateErr) return { error: updateErr };
                if (updated && updated.length > 0) return {};
                const { error: insertErr } = await supabaseClient.from('settings').insert([{ key, value }]);
                return { error: insertErr };
            }

            const r0 = await setSetting('captcha_provider', captchaProvider);
            if (r0.error) return showToast(r0.error.message || "Failed to save captcha setting", "error");
            const r1 = await setSetting('payment_qr_url', url);
            if (r1.error) return showToast(r1.error.message || "Failed to save QR URL", "error");
            const r2 = await setSetting('payment_number', num);
            if (r2.error) return showToast(r2.error.message || "Failed to save number", "error");

            state.paymentSettings = { payment_qr_url: url, payment_number: num, captcha_provider: captchaProvider };
            showToast("Settings saved", "success");
            render(false);
        }

        async function updateAdminPassword() {
            const newPass = document.getElementById('newAdminPass').value;
            if (!newPass || newPass.length < 4) return showToast("Password too short", "error");

            const { data, error } = await supabaseClient.from('admins').update({ password: newPass }).eq('username', 'admin').select();
            if (error || data.length === 0) showToast("Update failed.", "error");
            else {
                showToast("Password updated. Please login again.", "success");
                handleAdminLogout();
            }
        }

        async function sendOtp(orderId, accId, code) {
            const { data } = await supabaseClient.from('orders').select('accounts_data').eq('id', orderId).single();
            if(!data) return;
            const updatedAccounts = data.accounts_data.map(acc => acc.id === accId ? { ...acc, otpRequest: { ...acc.otpRequest, status: 'sent', code: code } } : acc);
            await supabaseClient.from('orders').update({ accounts_data: updatedAccounts }).eq('id', orderId);
            showToast("OTP Sent", "success");
        }
        
        async function requestOtp(orderId, accId) {
            const { data } = await supabaseClient.from('orders').select('accounts_data').eq('id', orderId).single();
            if(!data) return;
            
            const account = data.accounts_data.find(acc => acc.id === accId);
            if(account && account.otpRequest && account.otpRequest.requestedAt) {
                const lastRequestTime = new Date(account.otpRequest.requestedAt).getTime();
                const now = new Date().getTime();
                const timeSinceLastRequest = (now - lastRequestTime) / 1000 / 60; // minutes
                
                if(timeSinceLastRequest < 2) {
                    const remainingSeconds = Math.ceil((2 - timeSinceLastRequest) * 60);
                    showToast(`Please wait ${remainingSeconds} seconds before requesting again`, "error");
                    return;
                }
            }
            
            const updatedAccounts = data.accounts_data.map(acc => acc.id === accId ? { ...acc, otpRequest: { ...acc.otpRequest, status: 'pending', code: null, requestedAt: new Date().toISOString() } } : acc);
            await supabaseClient.from('orders').update({ accounts_data: updatedAccounts }).eq('id', orderId);
            showToast("OTP Requested", "info");
            render(false);
        }

        async function toggleAccountUsed(orderId, accId) {
             const { data } = await supabaseClient.from('orders').select('accounts_data').eq('id', orderId).single();
            if(!data) return;
            const updatedAccounts = data.accounts_data.map(acc => acc.id === accId ? { ...acc, used: !acc.used } : acc);
            const { error } = await supabaseClient.from('orders').update({ accounts_data: updatedAccounts }).eq('id', orderId);
            if(error) showToast("Update failed", "error");
        }

        function getPendingOtpCount() {
            let count = 0;
            state.orders.forEach(o => {
                if (o.accounts) o.accounts.forEach(a => { if (a.otpRequest.status === 'pending') count++; });
            });
            return count;
        }

        // --- Render Functions ---

        function renderHeader() {
            const isV2 = state.uiVariant === 'v2';
            return `
            <div class="fixed top-0 left-0 w-full z-50 ${isV2 ? 'bg-white dark:bg-zinc-900 border-b border-gray-100 dark:border-white/10 font-poppins' : 'glass'}">
                <div class="flex justify-between items-center h-14 px-4 max-w-7xl mx-auto">
                    <div class="flex items-center gap-3">
                        <button onclick="window.goHome()" class="font-bold text-lg tracking-tighter italic ${isV2 ? 'text-black dark:text-white' : 'bg-clip-text text-transparent bg-gradient-to-r from-zinc-900 to-zinc-600 dark:from-white dark:to-zinc-500'} pr-2 pb-1">${SITE_NAME}</button>
                    </div>
                    <div class="flex items-center gap-4">
                        ${state.user 
                            ? `
                               <div class="flex items-center gap-1 text-[10px] ${isV2 ? 'font-poppins' : 'font-mono'} text-emerald-400 border border-emerald-500/20 px-2 py-0.5 rounded-sm bg-emerald-500/5">
                                    <span>₱${formatPHP(state.userProfile?.credits || 0).replace('₱', '')}</span>
                               </div>
                               <a href="spin.html" class="text-zinc-400 hover:text-yellow-400 transition-colors animate-pulse-slow"><i data-lucide="gift" class="w-4 h-4"></i></a>
                               <button onclick="window.setView('my-orders')" class="text-zinc-400 hover:text-emerald-500 transition-colors"><i data-lucide="package" class="w-4 h-4"></i></button>
                            `
                            : `
                               <button onclick="window.setView('login')" class="text-[10px] font-bold uppercase hover:text-emerald-500 transition-colors ${isV2 ? 'text-black dark:text-white' : 'text-zinc-400 hover:text-white'}">Login</button>
                               <button onclick="window.setView('my-orders')" class="${isV2 ? 'text-black dark:text-white' : 'text-zinc-400 hover:text-white'} transition-colors" title="Order history"><i data-lucide="package" class="w-4 h-4"></i></button>
                            `
                        }
                        ${state.user ? `<button onclick="window.handleUserLogout()" class="text-zinc-400 hover:text-red-400 transition-colors"><i data-lucide="log-out" class="w-4 h-4"></i></button>` : ''}
                        
                        <div class="flex items-center gap-2 border-l ${isV2 ? 'border-gray-200 dark:border-white/10' : 'border-white/10'} pl-4">
                            <button onclick="window.toggleUiVariant()" class="${isV2 ? 'text-zinc-600 hover:text-black dark:text-zinc-400 dark:hover:text-white' : 'text-zinc-500 hover:text-white'} transition-colors" title="Switch UI Style">
                                <i data-lucide="layout" class="w-4 h-4"></i>
                            </button>
                            <button onclick="window.toggleTheme()" class="${isV2 ? 'text-zinc-600 hover:text-black dark:text-zinc-400 dark:hover:text-white' : 'text-zinc-500 hover:text-white'} transition-colors" title="Toggle theme">${document.documentElement.classList.contains('dark') ? '<i data-lucide="sun" class="w-4 h-4"></i>' : '<i data-lucide="moon" class="w-4 h-4"></i>'}</button>
                            <button onclick="window.setView('admin')" class="${isV2 ? 'text-zinc-600 hover:text-black dark:text-zinc-400 dark:hover:text-white' : 'text-zinc-400 hover:text-white'} transition-colors"><i data-lucide="hexagon" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderTrackerSearchBar() {
            return `
            <div class="px-4 py-3 border-b border-white/5 bg-zinc-900/30">
                <div class="max-w-2xl mx-auto flex items-center gap-2">
                    <div class="flex-1 relative">
                        <i data-lucide="search" class="w-4 h-4 text-zinc-500 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                        <input type="text" id="trackerInputVal" value="${state.trackerInput}" placeholder="Track order by ID (e.g. STKZ-XXXXXXXX)" class="w-full bg-zinc-900 border border-white/10 rounded-lg pl-9 pr-4 py-2.5 text-xs text-white placeholder-zinc-600 focus:outline-none focus:border-emerald-500/50 font-mono" onkeydown="if(event.key==='Enter')window.handleTrack()" />
                    </div>
                    <button onclick="window.handleTrack()" class="bg-white text-black hover:bg-zinc-200 p-2.5 rounded-lg transition-colors shrink-0 flex items-center justify-center" title="Track order"><i data-lucide="package-search" class="w-5 h-5"></i></button>
                </div>
            </div>`;
        }

        // --- V1 (Classic) Home Render ---
        function renderHomeV1(animate) {
            const animClass = animate ? 'animate-enter' : '';
            return `
            <div class="pt-14 pb-16 ${animClass}">
                <div class="bg-zinc-900/50 border-b border-white/5 py-1.5 px-4 flex justify-center items-center gap-2 text-[9px] uppercase tracking-widest text-zinc-500 font-mono">
                    <i data-lucide="lock" class="w-3 h-3 text-zinc-400"></i>
                    All transactions are secured and safe
                </div>
                ${renderTrackerSearchBar()}
                <div class="overflow-hidden bg-zinc-200 dark:bg-black border-b border-zinc-300 dark:border-white/5 py-3 relative">
                     <div class="whitespace-nowrap animate-marquee flex gap-16 items-center text-[9px] font-mono text-zinc-500 dark:text-zinc-600 uppercase tracking-[0.2em]">
                        <span>VERIFIED SHEIN ACCTS</span>
                        <span>BULK PRICING AVAILABLE</span>
                        <span>MANUAL ORDER VERIFICATION</span>
                        <span>EXCLUSIVE VOUCHERS INCLUDED</span>
                        <span>SECURE PAYMENT PROCESSING</span>
                        <span>VERIFIED SHEIN ACCTS</span>
                        <span>BULK PRICING AVAILABLE</span>
                        <span>MANUAL ORDER VERIFICATION</span>
                      </div>
                      <div class="absolute inset-y-0 left-0 w-16 bg-gradient-to-r from-zinc-200 to-transparent dark:from-black z-10"></div>
                      <div class="absolute inset-y-0 right-0 w-16 bg-gradient-to-l from-zinc-200 to-transparent dark:from-black z-10"></div>
                </div>
                <div class="p-5 mb-2 relative overflow-hidden group max-w-7xl mx-auto">
                    <div class="relative z-10">
                        <h1 class="text-3xl font-bold leading-none mb-3 tracking-tighter text-white">SHOP WITHOUT<br/>HASSLE!</h1>
                        <p class="text-[10px] text-zinc-400 max-w-[220px] leading-relaxed font-mono">
                            Fresh SHEIN accounts with exclusive vouchers delivered to your dashboard. Secure. Fast. Anonymous.
                        </p>
                    </div>
                    <div class="absolute right-0 top-0 w-56 h-56 bg-gradient-to-b from-zinc-800 to-transparent opacity-20 blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                </div>
                <div class="px-6 max-w-7xl mx-auto w-full">
                    <div class="flex items-center gap-2 mb-4 opacity-50">
                        <i data-lucide="grid" class="w-3 h-3 text-white"></i>
                        <span class="text-[9px] font-bold tracking-[0.2em] uppercase text-zinc-400">AVAILABLE STOCK</span>
                    </div>
                    <div class="max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 pb-20">
                            ${state.products.length === 0 ? '<div class="col-span-full text-center text-zinc-500 py-10"><p>Loading products...</p></div>' : ''}
                            ${state.products.map(p => `
                            <div onclick="window.selectProduct(${p.id})" class="group cursor-pointer bg-zinc-900/50 border border-white/5 hover:border-emerald-500/50 hover:bg-zinc-900 transition-all duration-300 p-2.5 relative overflow-hidden h-full rounded-md ${p.stock <= 0 ? 'opacity-50 grayscale pointer-events-none' : ''}">
                                <div class="flex flex-col gap-2 h-full justify-between relative z-10">
                                    <div class="flex justify-between items-start">
                                        <div class="w-10 h-10 ${p.color} flex items-center justify-center border border-white/5 rounded-md">
                                            <i data-lucide="package" class="w-5 h-5 opacity-90 group-hover:scale-110 transition-transform duration-500 text-zinc-400"></i>
                                        </div>
                                        <div class="flex flex-col items-end gap-1">
                                            <span class="bg-white/5 text-zinc-400 border border-white/5 text-[8px] font-mono px-1.5 py-0.5 uppercase rounded-md tracking-tight">${p.tag}</span>
                                            ${p.stock <= 0 ? '<span class="text-[8px] text-red-500 font-bold uppercase tracking-wide">Out of Stock</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="flex items-end justify-between mt-1">
                                        <div>
                                            <h3 class="text-[10px] font-bold uppercase tracking-tight text-white group-hover:text-emerald-400 transition-colors leading-tight mb-1 line-clamp-2">${p.title}</h3>
                                            <span class="text-xs font-bold font-mono text-white">${formatPHP(p.price)}</span>
                                        </div>
                                        <div class="w-5 h-5 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-emerald-500 group-hover:text-black transition-colors shrink-0">
                                            <i data-lucide="arrow-up-right" class="w-3 h-3"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // --- V2 (Modern/Clean) Home Render ---
        function renderHomeV2(animate) {
             const animClass = animate ? 'animate-enter' : '';
             return `
             <div class="pt-14 pb-12 bg-white dark:bg-black font-poppins ${animClass} min-h-screen">
                <!-- Safe Banner -->
                <div class="bg-gray-100 dark:bg-zinc-900 py-1.5 flex justify-center items-center gap-2 text-[9px] uppercase font-semibold tracking-wider text-gray-500 dark:text-zinc-400">
                    <i data-lucide="lock" class="w-3 h-3"></i>
                    All transactions are secured and safe
                </div>

                <!-- Search Section -->
                <div class="px-4 pt-4 pb-3">
                    <div class="relative w-full max-w-lg mx-auto">
                        <div class="relative flex items-center">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 pointer-events-none"></i>
                            <input type="text" id="trackerInputVal" value="${state.trackerInput}" placeholder="Track order by ID (e.g. STKZ-XXXXX)" 
                                   class="w-full h-10 pl-10 pr-12 bg-white dark:bg-zinc-900 border border-gray-200 dark:border-white/10 rounded-lg text-xs text-gray-700 dark:text-zinc-100 placeholder-gray-400 dark:placeholder-zinc-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all shadow-sm"
                                   onkeydown="if(event.key==='Enter')window.handleTrack()" />
                            <button onclick="window.handleTrack()" class="absolute right-1 top-1 h-8 w-8 bg-blue-600 hover:bg-blue-700 rounded-md flex items-center justify-center text-white btn-primary-light transition-colors shadow-sm">
                                <i data-lucide="package-search" class="w-3.5 h-3.5 btn-primary-light"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center max-w-lg mx-auto mt-2 px-1">
                        <span class="text-[9px] font-bold text-gray-500 dark:text-zinc-400 uppercase tracking-widest cursor-pointer hover:text-black dark:hover:text-white transition-colors">Bulk Pricing Available</span>
                        <span class="text-[9px] font-bold text-gray-500 dark:text-zinc-400 uppercase tracking-widest cursor-pointer hover:text-black dark:hover:text-white transition-colors">Manual Order Verification</span>
                    </div>
                </div>

                <!-- Hero: SHOP WITHOUT HASSLE + search vector on same row -->
                <div class="px-4 py-4 pr-8 max-w-4xl mx-auto overflow-visible">
                    <div class="flex flex-row items-center justify-between gap-4 overflow-visible">
                        <div class="flex-1 min-w-0">
                            <h1 class="text-2xl font-extrabold text-black dark:text-white leading-tight tracking-tight">SHOP WITHOUT<br/>HASSLE.</h1>
                            <p class="text-gray-500 dark:text-zinc-400 text-xs leading-relaxed mt-2 max-w-xs">
                                Fresh SHEIN accounts with exclusive vouchers delivered to your dashboard. Secure. Fast. Anonymous.
                            </p>
                        </div>
                        <!-- Search animation vector (right side beside headline) -->
                        <div class="relative w-32 h-28 shrink-0 flex justify-end overflow-visible mr-2">
                            <div class="absolute top-0 right-2 w-20 h-24 bg-gray-50 dark:bg-zinc-800 border border-gray-200 dark:border-white/10 rounded-md shadow-sm flex flex-col items-center pt-3 gap-1.5 z-0 transform rotate-3">
                                <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
                                <div class="w-10 h-1 bg-gray-200 rounded-full self-start ml-3"></div>
                                <div class="w-12 h-1 bg-gray-200 rounded-full self-start ml-3"></div>
                                <div class="w-8 h-1 bg-gray-200 rounded-full self-start ml-3"></div>
                                <div class="absolute bottom-0 left-0 w-full h-1.5 bg-gray-50" style="clip-path: polygon(0 0, 10% 100%, 20% 0, 30% 100%, 40% 0, 50% 100%, 60% 0, 70% 100%, 80% 0, 90% 100%, 100% 0);"></div>
                            </div>
                            <div class="absolute top-6 right-2 z-10 animate-float">
                                <div class="w-12 h-12 border-2 border-blue-600 rounded-full bg-white/20 backdrop-blur-sm shadow-xl flex items-center justify-center">
                                    <div class="w-9 h-9 bg-blue-50/50 rounded-full"></div>
                                </div>
                                <div class="absolute bottom-0 right-0 translate-x-0.5 translate-y-1.5 w-3 h-9 bg-blue-600 rounded-full transform -rotate-45 origin-top-left shadow-lg"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Popular Accounts (2 per row) -->
                <div class="px-4 max-w-5xl mx-auto">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="layout-grid" class="w-3.5 h-3.5 text-black dark:text-white"></i>
                        <h3 class="text-[10px] font-bold text-gray-500 dark:text-zinc-400 uppercase tracking-widest">Popular Accounts</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                         ${state.products.length === 0 ? '<div class="col-span-2 text-center text-gray-400 dark:text-zinc-500 py-8 text-xs"><p>Loading products...</p></div>' : ''}
                         ${state.products.map((p) => {
                             return `
                             <div onclick="window.selectProduct(${p.id})" class="bg-gray-50 dark:bg-zinc-900 rounded-lg p-4 cursor-pointer hover:shadow-lg transition-all duration-300 border border-transparent hover:border-gray-200 dark:hover:border-white/10 group relative ${p.stock <= 0 ? 'opacity-50 grayscale pointer-events-none' : ''}">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-8 h-8 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center shadow-sm text-white">
                                        <i data-lucide="ticket" class="w-4 h-4"></i>
                                    </div>
                                    <span class="bg-gray-200/80 dark:bg-white/10 text-gray-600 dark:text-zinc-400 border border-gray-200 dark:border-white/10 text-[8px] font-mono px-1.5 py-0.5 uppercase rounded-md tracking-tight">${p.tag || ''}</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <div>
                                        <h4 class="font-bold text-gray-900 dark:text-white text-xs mb-0.5 group-hover:text-blue-600 transition-colors">${p.title}</h4>
                                        <p class="font-poppins font-medium text-gray-900 dark:text-white text-sm tracking-tight">${formatPHPPoppins(p.price)}</p>
                                    </div>
                                    <div class="w-6 h-6 rounded-full bg-gray-200 dark:bg-white/10 flex items-center justify-center text-gray-500 dark:text-zinc-400 group-hover:bg-black group-hover:text-white transition-colors">
                                        <i data-lucide="arrow-up-right" class="w-3 h-3"></i>
                                    </div>
                                </div>
                                ${p.stock <= 0 ? '<div class="absolute inset-0 bg-white/60 dark:bg-black/60 flex items-center justify-center font-bold text-red-500 uppercase tracking-widest text-[10px] border-2 border-red-500 rounded-lg m-1.5">Out of Stock</div>' : ''}
                             </div>
                             `
                         }).join('')}
                    </div>
                </div>
             </div>
             `;
        }

        function renderHome(animate = true) {
            // Check UI Variant
            if (state.uiVariant === 'v2') {
                return renderHomeV2(animate);
            }
            return renderHomeV1(animate);
        }

        function renderLogin() {
            const isDark = document.documentElement.classList.contains('dark');
            return `
            <div class="h-screen overflow-hidden ${isDark ? 'bg-black' : 'bg-gray-50'} flex items-center justify-center p-6 animate-enter">
                <div class="max-w-xs w-full">
                    <div class="text-center mb-8">
                        <h2 class="text-xl font-bold ${isDark ? 'text-white' : 'text-gray-900'} tracking-tighter mb-1">Welcome Back</h2>
                        <p class="${isDark ? 'text-zinc-500' : 'text-gray-500'} text-[10px] font-mono">Sign in to manage your orders</p>
                    </div>
                    <div class="space-y-3">
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full ${isDark ? 'bg-zinc-900 border-zinc-800 text-white' : 'bg-white border-gray-200 text-gray-900'} border p-3 text-xs rounded-sm focus:border-emerald-500 focus:outline-none" />
                        <div class="relative">
                            <input type="password" id="loginPass" placeholder="Password" class="w-full ${isDark ? 'bg-zinc-900 border-zinc-800 text-white' : 'bg-white border-gray-200 text-gray-900'} border p-3 text-xs rounded-sm focus:border-emerald-500 focus:outline-none pr-10" />
                            <button onclick="window.togglePassword('loginPass')" class="absolute right-3 top-1/2 -translate-y-1/2 ${isDark ? 'text-zinc-500 hover:text-white' : 'text-gray-400 hover:text-gray-900'}"><i data-lucide="eye" class="w-4 h-4"></i></button>
                        </div>
                        <button onclick="window.handleLogin()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white btn-green-light font-bold py-3 text-[10px] uppercase tracking-widest rounded-sm transition-colors flex items-center justify-center gap-2 ${state.authLoading ? 'opacity-50 cursor-not-allowed' : ''}">
                            ${state.authLoading ? '<span class="spinner spinner-sm shrink-0 border-white/40 border-t-transparent"></span> Signing In...' : 'Sign In'}
                        </button>
                    </div>
                    <div class="mt-4 flex justify-between items-center px-1">
                        <button onclick="window.setView('forgot-password')" class="text-[10px] ${isDark ? 'text-zinc-500 hover:text-zinc-300' : 'text-gray-500 hover:text-gray-700'}">Forgot Password?</button>
                        <button onclick="window.setView('register')" class="text-[10px] font-bold ${isDark ? 'text-white hover:text-emerald-400' : 'text-gray-900 hover:text-emerald-600'} uppercase">Create Account</button>
                    </div>
                    <button onclick="window.goHome()" class="w-full ${isDark ? 'text-zinc-600 hover:text-zinc-400' : 'text-gray-500 hover:text-gray-700'} text-[9px] uppercase mt-8">Back to Store</button>
                </div>
            </div>`;
        }

        function renderRegister() {
            const acctCount = parseInt(localStorage.getItem('stakz_acct_count') || '0');
            const showCaptcha = acctCount >= 1;
            const isDark = document.documentElement.classList.contains('dark');

            return `
            <div class="h-screen overflow-hidden ${isDark ? 'bg-black' : 'bg-gray-50'} flex items-center justify-center p-6 animate-enter">
                <div class="max-w-xs w-full">
                    <div class="text-center mb-8">
                        <h2 class="text-xl font-bold ${isDark ? 'text-white' : 'text-gray-900'} tracking-tighter mb-1">Create Account</h2>
                        <p class="${isDark ? 'text-zinc-500' : 'text-gray-500'} text-[10px] font-mono">Join StakzShop to save your history</p>
                    </div>
                    <div class="space-y-3">
                        <input type="email" id="regEmail" placeholder="Email" class="w-full ${isDark ? 'bg-zinc-900 border-zinc-800 text-white' : 'bg-white border-gray-200 text-gray-900'} border p-3 text-xs rounded-sm focus:border-emerald-500 focus:outline-none" />
                        <div class="relative">
                            <input type="password" id="regPass" placeholder="Password (Min 6 chars)" class="w-full ${isDark ? 'bg-zinc-900 border-zinc-800 text-white' : 'bg-white border-gray-200 text-gray-900'} border p-3 text-xs rounded-sm focus:border-emerald-500 focus:outline-none pr-10" />
                            <button onclick="window.togglePassword('regPass')" class="absolute right-3 top-1/2 -translate-y-1/2 ${isDark ? 'text-zinc-500 hover:text-white' : 'text-gray-400 hover:text-gray-900'}"><i data-lucide="eye" class="w-4 h-4"></i></button>
                        </div>
                        
                        ${showCaptcha ? '<div id="captcha-container" class="w-full my-2 min-h-[78px]"></div>' : ''}

                        <button onclick="window.handleRegister()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white btn-green-light font-bold py-3 text-[10px] uppercase tracking-widest rounded-sm transition-colors flex items-center justify-center gap-2 ${state.authLoading ? 'opacity-50 cursor-not-allowed' : ''}">
                            ${state.authLoading ? '<span class="spinner spinner-sm shrink-0 border-white/40 border-t-transparent"></span> Creating...' : 'Register'}
                        </button>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-[10px] ${isDark ? 'text-zinc-500' : 'text-gray-500'}">Already have an account?</p>
                        <button onclick="window.setView('login')" class="text-[10px] font-bold ${isDark ? 'text-white hover:text-emerald-400' : 'text-gray-900 hover:text-emerald-600'} uppercase mt-1">Sign In</button>
                    </div>
                    <button onclick="window.goHome()" class="w-full ${isDark ? 'text-zinc-600 hover:text-zinc-400' : 'text-gray-500 hover:text-gray-700'} text-[9px] uppercase mt-8">Back to Store</button>
                </div>
            </div>`;
        }

        function renderForgotPassword() {
            const isDark = document.documentElement.classList.contains('dark');
            return `
            <div class="h-screen overflow-hidden ${isDark ? 'bg-black' : 'bg-gray-50'} flex items-center justify-center p-6 animate-enter">
                <div class="max-w-xs w-full">
                    <div class="text-center mb-8">
                        <h2 class="text-xl font-bold ${isDark ? 'text-white' : 'text-gray-900'} tracking-tighter mb-1">Reset Password</h2>
                        <p class="${isDark ? 'text-zinc-500' : 'text-gray-500'} text-[10px] font-mono">Enter your email to receive reset instructions</p>
                    </div>
                    <div class="space-y-3">
                        <input type="email" id="resetEmail" placeholder="Email Address" class="w-full ${isDark ? 'bg-zinc-900 border-zinc-800 text-white' : 'bg-white border-gray-200 text-gray-900'} border p-3 text-xs rounded-sm focus:border-emerald-500 focus:outline-none" />
                        <button onclick="window.handlePasswordReset()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white btn-green-light font-bold py-3 text-[10px] uppercase tracking-widest rounded-sm transition-colors flex items-center justify-center gap-2 ${state.authLoading ? 'opacity-50 cursor-not-allowed' : ''}">
                            ${state.authLoading ? '<span class="spinner spinner-sm shrink-0 border-white/40 border-t-transparent"></span> Sending...' : 'Send Reset Link'}
                        </button>
                    </div>
                    <button onclick="window.setView('login')" class="w-full ${isDark ? 'text-zinc-500 hover:text-white' : 'text-gray-500 hover:text-gray-700'} text-[10px] uppercase mt-6">Back to Login</button>
                </div>
            </div>`;
        }

        function showOrderAccounts(orderId) {
            state.selectedOrderId = orderId;
            render(false);
        }

        function clearOrderSelection() {
            state.selectedOrderId = null;
            render(false);
        }

        function renderUserOrders() {
            const selected = state.selectedOrderId ? state.userOrders.find(o => o.id === state.selectedOrderId) : null;
            const showingAccounts = selected && selected.status === 'Completed' && selected.accounts && selected.accounts.length > 0;
            const isGuest = !state.user;
            const isDark = document.documentElement.classList.contains('dark');

            return `
            <div class="min-h-screen ${isDark ? 'bg-black' : 'bg-gray-50'} font-sans pb-16 pt-14">
                <div class="p-4 border-b ${isDark ? 'border-white/5 bg-black/80' : 'border-gray-200 bg-white/80'} flex items-center gap-3 sticky top-14 backdrop-blur-md z-10 max-w-7xl mx-auto w-full">
                    <button onclick="${showingAccounts ? "window.clearOrderSelection()" : "window.goHome()"}" class="${isDark ? 'hover:text-white text-zinc-400' : 'hover:text-gray-900 text-gray-600'} transition-colors"><i data-lucide="${showingAccounts ? 'arrow-left' : 'arrow-left'}" class="w-4 h-4"></i></button>
                    <span class="text-xs font-bold uppercase tracking-[0.2em] ${isDark ? 'text-zinc-300' : 'text-gray-700'}">${showingAccounts ? 'Access details' : 'My Order History'}</span>
                </div>
                <div class="p-4 max-w-2xl mx-auto w-full">
                    ${isGuest ? `
                    <div class="mb-4 p-3 bg-amber-500/10 border border-amber-500/20 rounded-lg flex items-start gap-2">
                        <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-500 shrink-0 mt-0.5"></i>
                        <p class="text-[10px] text-amber-200/90">Your order history is not saved online. Sign in to sync orders across devices and access them anytime.</p>
                    </div>
                    ` : ''}
                    ${showingAccounts ? `
                        <div class="${isDark ? 'bg-zinc-900/50 border-white/5' : 'bg-white border-gray-200'} border p-5 relative overflow-hidden backdrop-blur-sm mb-4">
                            <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                            <div class="pl-2 mb-2">
                                <h3 class="font-bold text-xs tracking-tight mb-0.5 ${isDark ? 'text-white' : 'text-gray-900'}">${selected.id}</h3>
                                <p class="text-[9px] ${isDark ? 'text-zinc-500' : 'text-gray-600'} font-mono">${formatDate(selected.date)} · ${selected.product}</p>
                            </div>
                            ${renderOrderAccountsContent(selected)}
                        </div>
                        <button onclick="window.clearOrderSelection()" class="w-full text-center text-[9px] font-bold uppercase ${isDark ? 'text-zinc-500 hover:text-white border-white/10' : 'text-gray-600 hover:text-gray-900 border-gray-300'} py-2 border rounded-sm transition-colors">Back to order list</button>
                    ` : state.userOrders.length === 0 ? `
                        <div class="text-center py-10 text-zinc-600">
                            <i data-lucide="package-open" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p class="text-[10px] uppercase tracking-widest">No orders yet</p>
                        </div>
                    ` : `
                        <div class="space-y-4">
                            ${state.userOrders.map(order => renderOrderCard(order, true)).join('')}
                        </div>
                    `}
                </div>
            </div>`;
        }

        function renderProduct(animate = true) {
            const p = state.selectedProduct;
            const subtotal = getPrice() * state.quantity;
            const discountAmount = subtotal * state.discount;
            const total = subtotal - discountAmount;
            const isBulk = state.quantity >= p.bulk_threshold;
            const animClass = animate ? 'animate-enter' : '';
            const isV2 = state.uiVariant === 'v2';
            
            // Adjust styles for V2 Product Page if needed, but keeping it unified for now with conditional colors
            const bgClass = isV2 ? 'bg-white dark:bg-black' : 'bg-transparent';
            const textMain = isV2 ? 'text-black dark:text-white' : 'text-white';
            const textSub = isV2 ? 'text-gray-500 dark:text-zinc-400' : 'text-zinc-400';

            return `
            <div class="pt-14 pb-32 ${animClass} flex flex-col h-full max-w-7xl mx-auto w-full ${bgClass} min-h-screen ${isV2 ? 'font-poppins' : ''}">
                <div class="p-6">
                    <button onclick="window.goHome()" class="flex items-center gap-2 text-[10px] font-mono hover:underline transition-colors ${textSub}">
                        <i data-lucide="arrow-left" class="w-3 h-3"></i> Back to Catalog
                    </button>
                </div>

                <div class="px-6 flex-1 pt-2 max-w-2xl mx-auto w-full">
                    <div class="flex justify-between items-start mb-3">
                        <h1 class="text-xl font-bold uppercase leading-tight tracking-tight ${textMain}">${p.title}</h1>
                        <span class="font-mono text-emerald-500 text-[10px] border border-emerald-500/20 bg-emerald-500/10 px-2 py-0.5 rounded-md">${p.tag}</span>
                    </div>
                    
                    <p class="${textSub} text-xs mb-6 leading-relaxed font-light border-l-2 ${isV2 ? 'border-gray-300 dark:border-zinc-700' : 'border-zinc-800'} pl-3">${p.description}</p>

                    <div class="${isV2 ? 'bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-white/10' : 'bg-zinc-900/50 border border-white/5'} p-4 mb-6 rounded-sm">
                        <div class="flex justify-between items-center mb-2 pb-2 border-b ${isV2 ? 'border-gray-200 dark:border-white/10' : 'border-white/5'} ${!isBulk ? textMain : textSub}">
                            <span class="text-[10px] uppercase font-bold tracking-wider">Single Unit</span>
                            <span class="${isV2 ? 'price-poppins' : 'font-mono'} text-xs">${formatPHP(p.price)}</span>
                        </div>
                        <div class="flex justify-between items-center ${isBulk ? 'text-emerald-500' : textSub}">
                            <span class="text-[10px] uppercase font-bold tracking-wider flex items-center gap-2">
                                Bulk Pack (10+) 
                                ${isBulk ? '<span>●</span>' : ''}
                            </span>
                            <span class="${isV2 ? 'price-poppins' : 'font-mono'} text-xs">${formatPHP(p.bulk_price)}</span>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <span class="text-[10px] font-bold uppercase tracking-[0.2em] ${textSub}">QUANTITY</span>
                        <div class="flex items-center gap-1 ${isV2 ? 'bg-gray-100 dark:bg-zinc-800 border border-gray-200 dark:border-white/10' : 'bg-zinc-900 border border-white/10'} p-1 rounded-full">
                            <button onclick="window.updateQuantity(-1)" class="w-8 h-8 rounded-full flex items-center justify-center ${isV2 ? 'hover:bg-white dark:hover:bg-zinc-700 text-black dark:text-white' : 'hover:bg-zinc-800 text-white'} transition-colors">-</button>
                            <span class="w-10 text-center text-xs ${isV2 ? 'font-poppins' : 'font-mono'} font-bold text-emerald-500">${state.quantity}</span>
                            <button onclick="window.updateQuantity(1)" class="w-8 h-8 rounded-full flex items-center justify-center ${isV2 ? 'hover:bg-white dark:hover:bg-zinc-700 text-black dark:text-white' : 'hover:bg-zinc-800 text-white'} transition-colors">+</button>
                        </div>
                    </div>

                    <div class="mb-10">
                        <label class="block text-[10px] font-bold uppercase ${textSub} mb-2 tracking-wider">Voucher Code</label>
                        <div class="flex gap-2">
                            <input type="text" id="discountInput" class="w-full ${isV2 ? 'bg-gray-50 dark:bg-zinc-900 border-gray-200 dark:border-white/10 text-black dark:text-white placeholder-gray-400 dark:placeholder-zinc-500 font-poppins' : 'bg-zinc-900 border-white/10 text-white placeholder-zinc-700 font-mono'} border py-2.5 px-3 text-xs focus:outline-none focus:border-emerald-500 transition-colors uppercase" placeholder="ENTER CODE" value="${state.discount > 0 ? 'TEST1111' : ''}" ${state.discount > 0 ? 'disabled' : ''} />
                            <button onclick="window.applyDiscount()" class="${isV2 ? 'bg-zinc-800 dark:bg-white text-white dark:text-black hover:bg-zinc-700 dark:hover:bg-zinc-200 voucher-apply-btn' : 'bg-white/10 text-white hover:bg-white/20'} font-bold py-2 px-3 text-[9px] uppercase transition-colors" ${state.discount > 0 ? 'disabled' : ''}>Apply</button>
                        </div>
                        ${state.discount > 0 ? `<p class="text-emerald-500 text-[9px] mt-2 ${isV2 ? 'font-poppins' : 'font-mono'} flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> 5% DISCOUNT APPLIED</p>` : ''}
                    </div>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 right-0 ${isV2 ? 'bg-white dark:bg-zinc-900 border-t border-gray-100 dark:border-white/10' : 'glass border-t border-white/10'} p-3 safe-area-bottom z-20">
                <div class="max-w-7xl mx-auto flex items-center gap-3">
                    <div class="flex-1">
                        <span class="text-[9px] uppercase ${textSub} block mb-0.5 ${isV2 ? 'font-poppins' : 'font-mono'} tracking-wider">Total</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-base font-bold ${isV2 ? 'price-poppins' : 'font-mono'} ${textMain}">${formatPHP(total)}</span>
                            ${state.discount > 0 ? `<span class="text-xs text-zinc-500 line-through ${isV2 ? 'price-poppins' : 'font-mono'} decoration-zinc-500">${formatPHP(subtotal)}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="window.setView('checkout')" class="flex-1 ${isV2 ? 'bg-blue-600 hover:bg-blue-700 text-white btn-primary-light' : 'bg-white hover:bg-zinc-200 text-black'} font-bold py-2.5 px-4 text-[10px] uppercase tracking-wider transition-all flex items-center justify-center gap-2">
                        Proceed to Payment <i data-lucide="arrow-right" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>`;
        }

        function renderCheckout(animate = true) {
            const subtotal = getPrice() * state.quantity;
            const discountAmount = subtotal * state.discount;
            const finalTotal = subtotal - discountAmount;
            const animClass = animate ? 'animate-enter' : '';
            const showCaptcha = state.sessionOrderCount >= 3;
            
            const buttonContent = state.isSubmitting 
                ? `<span class="confirm-preloader shrink-0"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span> VERIFYING...`
                : `Confirm Payment`;
            const buttonDisabled = state.isSubmitting ? 'disabled opacity-50 cursor-not-allowed' : 'hover:bg-emerald-400';

            const isDark = document.documentElement.classList.contains('dark');
            return `
            <div class="min-h-screen ${isDark ? 'bg-black' : 'bg-gray-50'} pb-16 pt-14 ${animClass}">
                <div class="p-4 border-b ${isDark ? 'border-white/5 bg-black/80' : 'border-gray-200 bg-white'} flex items-center gap-3 sticky top-14 backdrop-blur-md z-10 max-w-7xl mx-auto w-full">
                    <button onclick="window.setView('product')" class="${isDark ? 'hover:text-white text-zinc-400' : 'hover:text-gray-900 text-gray-600'} transition-colors"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                    <h2 class="font-mono text-[10px] uppercase tracking-widest ${isDark ? 'text-white' : 'text-gray-900'}">Secure Checkout</h2>
                </div>

                <div class="p-5 max-w-2xl mx-auto w-full">
                    <div class="bg-zinc-50 text-black p-5 mb-6 relative font-mono text-[10px] shadow-xl transform rotate-1">
                         <div class="absolute top-0 left-0 right-0 h-1.5 bg-black" style="clip-path: polygon(0 2px, 5px 0, 10px 2px, 15px 0, 20px 2px, 25px 0, 30px 2px, 35px 0, 40px 2px, 45px 0, 50px 2px, 55px 0, 60px 2px, 65px 0, 70px 2px, 75px 0, 80px 2px, 85px 0, 90px 2px, 95px 0, 100% 2px, 100% 100%, 0 100%);"></div>
                         
                         <div class="text-center mb-4 mt-2">
                            <h3 class="font-bold text-base uppercase tracking-tight">${SITE_NAME}</h3>
                            <p class="text-[9px] uppercase opacity-60">Order Summary</p>
                         </div>
                         
                         <div class="border-b border-dashed border-black/20 pb-3 mb-3">
                            <div class="flex justify-between mb-1">
                                <span class="uppercase">${state.selectedProduct.title}</span>
                                <span class="font-bold">x${state.quantity}</span>
                            </div>
                            <div class="flex justify-between opacity-60 text-[9px]">
                                <span>SKU: ${state.selectedProduct.id.toString().padStart(4, '0')}</span>
                                <span>UNIT: ${formatPHP(getPrice())}</span>
                            </div>
                         </div>

                         <div class="space-y-1 mb-4">
                             <div class="flex justify-between items-center text-zinc-600">
                                <span>SUBTOTAL</span>
                                <span>${formatPHP(subtotal)}</span>
                             </div>
                             ${state.discount > 0 ? `
                             <div class="flex justify-between items-center text-emerald-600 font-bold">
                                <span>DISCOUNT (5%)</span>
                                <span>-${formatPHP(discountAmount)}</span>
                             </div>` : ''}
                             <div class="flex justify-between items-end text-base font-bold pt-2 border-t border-black/10 mt-2">
                                <span>TOTAL AMOUNT</span>
                                <span>${formatPHP(finalTotal)}</span>
                             </div>
                         </div>

                         <div class="text-center opacity-40 text-[8px]">
                            <p>Payment Status: Pending</p>
                            <p>${new Date().toISOString()}</p>
                         </div>
                    </div>

                    ${state.user ? `
                    <div class="mb-4 bg-zinc-900 border border-white/10 p-4 rounded-lg ${(state.userProfile?.credits || 0) <= 0 ? 'opacity-60' : ''}">
                        <label class="flex items-center justify-between gap-4 ${(state.userProfile?.credits || 0) <= 0 ? 'cursor-not-allowed' : 'cursor-pointer'}">
                            <div class="min-w-0">
                                <p class="text-xs font-semibold text-white">Use Wallet</p>
                                <p class="text-[10px] text-zinc-500 mt-0.5">Balance: ${formatPHP(state.userProfile?.credits || 0)} ${(state.userProfile?.credits || 0) <= 0 ? '• Spin daily to earn' : '• Applied as discount'}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <input type="checkbox" onchange="window.togglePayWithCredits()" ${state.payWithCredits && (state.userProfile?.credits || 0) > 0 ? 'checked' : ''} ${(state.userProfile?.credits || 0) <= 0 ? 'disabled' : ''} class="wallet-toggle-input" id="pay-with-credits-toggle" />
                                <span class="wallet-toggle-track" aria-hidden="true"></span>
                            </div>
                        </label>
                        ${state.payWithCredits && (state.userProfile?.credits || 0) > 0 ? `
                        <div class="mt-2 pt-2 border-t border-white/5 space-y-1">
                            <div class="flex justify-between text-[9px]">
                                <span class="text-zinc-500">Credits applied</span>
                                <span class="text-emerald-400 font-mono">-${formatPHP(Math.min(state.userProfile?.credits || 0, finalTotal))}</span>
                            </div>
                            <div class="flex justify-between text-[9px] font-bold">
                                <span class="text-zinc-400">Amount to pay</span>
                                <span class="text-white font-mono">${formatPHP(Math.max(0, finalTotal - (state.userProfile?.credits || 0)))}</span>
                            </div>
                        </div>` : ''}
                    </div>` : ''}

                    ${!(state.payWithCredits && (state.userProfile?.credits || 0) >= finalTotal) ? `
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                            <span class="text-[9px] font-bold uppercase tracking-widest text-zinc-400">Payment Method</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <button type="button" onclick="window.setPaymentMethod('gcash'); render(false);" class="py-2.5 px-3 rounded-lg border text-[10px] font-bold uppercase tracking-wider transition-all ${state.paymentMethod === 'gcash' ? 'bg-emerald-500/20 border-emerald-500 text-emerald-400' : 'bg-zinc-900 border-white/10 text-zinc-400 hover:border-white/20'}">
                                <i data-lucide="smartphone" class="w-3.5 h-3.5 inline-block mr-1.5 align-middle"></i> Manual Transfer
                            </button>
                            <button type="button" onclick="window.setPaymentMethod('stripe'); render(false);" class="py-2.5 px-3 rounded-lg border text-[10px] font-bold uppercase tracking-wider transition-all ${state.paymentMethod === 'stripe' ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-zinc-900 border-white/10 text-zinc-400 hover:border-white/20'}">
                                <i data-lucide="credit-card" class="w-3.5 h-3.5 inline-block mr-1.5 align-middle"></i> Card (Stripe)
                            </button>
                        </div>
                    </div>

                    ${state.paymentMethod === 'gcash' ? '<div class="mb-6"><div class="flex items-center gap-2 mb-3"><div class="w-1.5 h-1.5 bg-white rounded-full"></div><span class="text-[9px] font-bold uppercase tracking-widest text-zinc-400">Payment Gateway</span></div><div class="bg-zinc-900 border border-white/10 p-4 flex flex-col items-center justify-center gap-3 relative overflow-hidden"><div class="absolute inset-0 bg-[url(\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMDUiLz4KPC9zdmc+\')] opacity-10"></div><img src="' + getPaymentQrUrl() + '" alt="QR" class="w-48 h-48 object-contain" onerror="this.src=\'' + GCASH_QR_URL + '\'" /><div class="text-center relative z-10"><p class="font-mono text-sm font-bold text-white tracking-widest">' + getPaymentNumber() + '</p><p class="text-[9px] uppercase text-zinc-500 mt-0.5">Scan to transfer funds</p></div></div><div class="mt-4"><label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1.5 tracking-wider">Reference Number</label><div class="relative"><input type="text" id="refNumberInput" placeholder="Last 4 digits or full reference" class="w-full bg-zinc-900 border border-white/10 py-3 px-3 pl-10 text-xs font-mono text-white focus:outline-none focus:border-emerald-500 transition-colors placeholder-zinc-700" /><i data-lucide="hash" class="w-3 h-3 text-zinc-600 absolute left-3.5 top-1/2 -translate-y-1/2"></i></div></div></div>' : '<div class="mb-6 bg-zinc-900 border border-white/10 p-4 rounded-lg"><p class="text-[10px] text-zinc-400 mb-3">You will be redirected to Stripe to pay securely with card.</p><p class="text-xs font-mono font-bold text-white">' + formatPHP(finalTotal) + '</p></div>'}
                        
                        ${state.paymentMethod === 'gcash' ? showCaptcha ? '<div id="captcha-container" class="w-full my-4 min-h-[78px]"></div>' : '' : ''}

                        ${state.paymentMethod === 'stripe' ? '<button onclick="window.createStripeCheckoutAndRedirect()" class="w-full bg-[#635BFF] hover:bg-[#5449e0] text-white btn-stripe-light font-bold py-3 px-4 text-[10px] uppercase mt-5 transition-all tracking-wider flex items-center justify-center gap-2" ' + (state.isSubmitting ? 'disabled' : '') + '>' + (state.isSubmitting ? '<span class="confirm-preloader shrink-0"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span> REDIRECTING...' : '<i data-lucide="credit-card" class="w-4 h-4"></i> Pay with Stripe') + '</button>' : '<button onclick="window.submitOrder()" class="w-full bg-emerald-500 text-white btn-green-light font-bold py-3 px-4 text-[10px] uppercase mt-5 transition-all tracking-wider shadow-[0_0_20px_rgba(16,185,129,0.3)] flex items-center justify-center gap-2 ' + buttonDisabled + '">' + buttonContent + '</button>'}
                    </div>
                </div>
            </div>` : ''}
            `;
        }

        function renderSuccess(animate = true) {
            const animClass = animate ? 'animate-enter' : '';
            return `
            <div class="min-h-screen flex flex-col items-center justify-center p-6 pt-20 text-center bg-black ${animClass} relative overflow-hidden">
                <div class="absolute inset-0 bg-emerald-500/5 radial-gradient"></div>

                <div class="w-16 h-16 bg-zinc-900 border border-emerald-500/30 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(16,185,129,0.2)] relative z-10">
                    <i data-lucide="check" class="w-6 h-6 text-emerald-500"></i>
                </div>
                
                <h2 class="text-2xl font-bold tracking-tighter mb-2 text-white relative z-10">Order Received</h2>
                <p class="text-zinc-500 text-[10px] mb-8 max-w-[220px] leading-relaxed font-mono relative z-10">
                    We have received your payment reference. Your order is being processed. ETA: 10-30m.
                </p>
                
                <div class="bg-zinc-900 border border-dashed border-zinc-700 p-3 w-full mb-6 relative group max-w-xs">
                    <p class="text-[8px] text-zinc-500 uppercase tracking-widest mb-1 font-mono">Order Reference ID</p>
                    <p class="text-lg font-mono font-bold text-white tracking-widest">${state.lastOrderId}</p>
                    <button onclick="window.copyToClipboard('${state.lastOrderId}')" class="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-600 hover:text-white p-1.5 transition-colors">
                        <i data-lucide="copy" class="w-3 h-3"></i>
                    </button>
                </div>

                <div class="space-y-2 w-full max-w-xs relative z-10">
                    <button onclick="window.setView('my-orders')" class="w-full bg-gray-900 text-white font-bold py-2.5 px-4 text-[10px] uppercase hover:bg-gray-800 transition-colors tracking-wider success-check-status-btn">
                        Check Status
                    </button>
                    <button onclick="window.goHome()" class="w-full text-zinc-500 font-bold py-2.5 px-4 text-[10px] uppercase hover:text-white transition-colors tracking-wider">
                        Return to Store
                    </button>
                </div>
            </div>`;
        }

        // Shared Render Logic for Order Cards (Used in Tracker and User Orders)
        function renderOrderCard(res, isMyOrders = false) {
            const isProcessing = res.status === 'Processing';
            const isRefundPending = res.status === 'Refund Pending';
            const isCompleted = res.status === 'Completed';
            const isCancelled = res.status === 'Cancelled';
            
            const timeDiff = new Date() - new Date(res.date);
            const canCancel = isProcessing && timeDiff < 60000;
            const canRequestRefund = isProcessing && timeDiff > 3600000;
            const canDelete = isCancelled || res.status === 'Refunded';

            let statusColor = '';
            if(isCompleted) statusColor = 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20';
            else if(isCancelled) statusColor = 'text-red-400 bg-red-500/10 border-red-500/20';
            else if(isRefundPending) statusColor = 'text-orange-400 bg-orange-500/10 border-orange-500/20';
            else statusColor = 'text-yellow-400 bg-yellow-500/10 border-yellow-500/20';

            let accountsHtml = '';
            if(isCompleted && res.accounts && res.accounts.length > 0) {
                if (isMyOrders && state.view === 'my-orders') {
                    accountsHtml = `
                    <div class="mt-4 pt-3 border-t border-white/5">
                        <button onclick="window.showOrderAccounts('${res.id}')" class="w-full text-center text-[9px] font-bold uppercase text-emerald-400 hover:text-emerald-300 transition-colors py-2 flex items-center justify-center gap-2">
                            <i data-lucide="key" class="w-3 h-3"></i> View access details
                        </button>
                    </div>`;
                } else {
                    const content = renderOrderAccountsContent(res);
                    accountsHtml = `
                    <div class="mt-4 pt-3 border-t border-white/5">
                        <button onclick="window.toggleOrderDetails('${res.id}')" class="w-full text-center text-[9px] font-bold uppercase text-zinc-500 hover:text-white transition-colors py-2 flex items-center justify-center gap-2">
                            <span>View</span> <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                        <div id="order-details-${res.id}" class="hidden">
                            ${content}
                        </div>
                    </div>`;
                }
            }

            return `
            <div class="bg-zinc-900/50 border border-white/5 p-5 relative overflow-hidden backdrop-blur-sm animate-enter">
                <div class="absolute top-0 left-0 w-1 h-full ${isCompleted ? 'bg-emerald-500' : (isCancelled ? 'bg-red-500' : (isRefundPending ? 'bg-orange-500' : 'bg-yellow-500'))}"></div>
                <div class="flex justify-between items-start mb-5 pl-2">
                    <div>
                        <h3 class="font-bold text-xs tracking-tight mb-1 text-white">${res.id}</h3>
                        <p class="text-[9px] text-zinc-500 font-mono">${formatDate(res.date)}</p>
                    </div>
                    <span class="${statusColor} border text-[8px] font-bold px-2 py-0.5 uppercase tracking-wider">${res.status}</span>
                </div>
                <div class="border-t border-dashed border-zinc-800 pt-3 space-y-1 pl-2">
                    <div class="flex justify-between text-[10px]">
                        <span class="text-zinc-500 uppercase tracking-wider text-[9px]">Product</span>
                        <span class="font-medium text-white truncate max-w-[150px]">${res.product}</span>
                    </div>
                     <div class="flex justify-between text-[10px]">
                        <span class="text-zinc-500 uppercase tracking-wider text-[9px]">Total Amount</span>
                        <span class="font-bold font-mono text-white">${formatPHP(res.total)}</span>
                    </div>
                </div>
                
                ${canDelete && state.view === 'my-orders' ? `
                <div class="mt-5 pl-2">
                    <button onclick="window.deleteOrder('${res.id}')" class="w-full bg-red-600/10 hover:bg-red-600/20 text-red-500 border border-red-500/20 font-bold py-2.5 px-3 text-[9px] uppercase transition-colors tracking-wide flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Delete from History
                    </button>
                </div>
                ` : ''}

                ${canCancel ? `
                <div class="mt-5 pl-2">
                    <button onclick="window.cancelOrder('${res.id}')" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 font-bold py-2.5 px-3 text-[9px] uppercase transition-colors tracking-wide">
                        Cancel Order (Undo)
                    </button>
                    <p class="text-[8px] text-zinc-600 text-center mt-2 font-mono">TIMER: < 60s remaining</p>
                </div>` : ''}
                ${(canRequestRefund && !res.refundRequest) ? `
                <div class="mt-6 border-t border-dashed border-zinc-800 pt-4">
                    <p class="text-[10px] text-zinc-500 mb-2 font-mono">Delivery limit exceeded. Request refund:</p>
                    <div class="space-y-2">
                        <input type="text" id="refundName" placeholder="GCash Name" class="w-full bg-zinc-900/50 border border-zinc-700 p-2 text-[10px] font-mono text-zinc-300" />
                        <input type="text" id="refundNumber" placeholder="GCash Number" class="w-full bg-zinc-900/50 border border-zinc-700 p-2 text-[10px] font-mono text-zinc-300" />
                        <button onclick="window.submitRefundRequest('${res.id}')" class="w-full bg-orange-500/10 hover:bg-orange-500/20 text-orange-500 border border-orange-500/20 font-bold py-2 px-3 text-[9px] uppercase transition-colors tracking-wider">
                            Request Refund
                        </button>
                    </div>
                </div>` : ''}
                ${res.refundRequest ? `
                <div class="mt-6 border-t border-dashed border-zinc-800 pt-4">
                    <div class="bg-orange-500/5 border border-orange-500/10 p-3 rounded-sm">
                        <p class="text-[9px] text-orange-400 uppercase font-bold mb-1 flex items-center gap-2"><i data-lucide="refresh-ccw" class="w-3 h-3"></i> Refund Requested</p>
                        <p class="text-[9px] text-zinc-500 font-mono">Status: Pending Admin Action</p>
                    </div>
                </div>` : ''}
                ${accountsHtml}
            </div>`;
        }

        function renderTracker(animate = true) {
            return `
            <div class="min-h-screen bg-black font-sans pb-16 pt-14">
                ${renderTrackerSearchBar()}
                <div class="p-5 max-w-md mx-auto w-full">
                    ${!state.searchResult ? `
                        <div class="text-center py-16 text-zinc-500">
                            <i data-lucide="package-search" class="w-12 h-12 mx-auto mb-3 opacity-40"></i>
                            <p class="text-xs font-mono">Enter your order ID above to track status</p>
                        </div>
                    ` : 
                      state.searchResult === 'not-found' ? `
                        <div class="animate-enter text-center p-6 text-zinc-500 border border-dashed border-zinc-800 bg-zinc-900/30 mt-4">
                            <i data-lucide="search-x" class="w-6 h-6 mx-auto mb-2 opacity-50"></i>
                            <p class="text-[10px] font-mono">Error: Order not found</p>
                        </div>
                      ` : renderOrderCard(state.searchResult)
                    }
                </div>
            </div>`;
        }

        function renderAdmin() {
            const isDark = document.documentElement.classList.contains('dark');
            
            if (!state.adminAuth) {
                return `
                <div class="min-h-screen ${isDark ? 'bg-black text-white' : 'bg-gray-50 text-gray-900'} font-sans flex items-center justify-center p-6 fixed top-0 left-0 w-full z-50">
                    <div class="${isDark ? 'bg-zinc-900 border-white/10' : 'bg-white border-gray-200'} border p-6 max-w-xs w-full relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-emerald-500 to-transparent opacity-50"></div>
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-center uppercase tracking-[0.2em] text-xs">Administration</h3>
                            <button onclick="window.goHome()" class="text-[9px] ${isDark ? 'text-zinc-500 hover:text-white' : 'text-gray-600 hover:text-gray-900'} uppercase">Exit</button>
                         </div>
                        <div class="mb-5">
                            <label class="block text-[9px] font-bold uppercase ${isDark ? 'text-zinc-500' : 'text-gray-600'} mb-1.5 tracking-wider">Password</label>
                            <input type="password" id="adminPassInput" class="w-full ${isDark ? 'bg-black border-white/10 text-white focus:border-emerald-500/50' : 'bg-gray-50 border-gray-300 text-gray-900 focus:border-emerald-500'} border py-2.5 px-3 text-xs font-mono focus:outline-none transition-colors" />
                        </div>
                        <button onclick="window.handleAdminLogin()" class="w-full ${isDark ? 'bg-white text-black hover:bg-zinc-200' : 'bg-gray-900 text-white hover:bg-gray-800 admin-auth-btn'} font-bold py-2.5 px-4 text-[10px] uppercase tracking-wider transition-colors">Authenticate</button>
                    </div>
                </div>`;
            }

            const pending = state.orders.filter(o => o.status === 'Processing').length;
            // Updated Revenue Calculation: Only count 'Completed' orders
            const revenue = state.orders
                .filter(o => o.status === 'Completed')
                .reduce((acc, cur) => acc + cur.total, 0);
            
            const pendingOtp = getPendingOtpCount();
            const adminBg = isDark ? 'bg-black' : 'bg-gray-50';
            const adminHeaderBg = isDark ? 'bg-black border-white/10' : 'bg-white border-gray-200';
            const adminText = isDark ? 'text-white' : 'text-gray-900';
            const adminTextMuted = isDark ? 'text-zinc-400' : 'text-gray-500';
            const adminCard = isDark ? 'bg-zinc-900 border-white/5' : 'bg-white border-gray-200';
            const adminInput = isDark ? 'bg-zinc-900 border-zinc-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900';
            const adminBorder = isDark ? 'border-white/5' : 'border-gray-200';

            // Orders Tab Content
            let tabContent = '';
            if (state.adminTab === 'orders') {
                tabContent = `
                <div class="${adminCard} border ${adminBorder} overflow-hidden rounded-lg">
                    <table class="w-full text-left">
                        <tbody class="divide-y ${adminBorder}">
                            ${state.orders.map(order => {
                                // Count User Messages: only unread
                                const msgCount = order.accounts 
                                    ? order.accounts.reduce((acc, curr) => acc + (curr.messages ? curr.messages.filter(m => m.sender === 'user' && !m.read).length : 0), 0)
                                    : 0;

                                return `
                            <tr class="${isDark ? 'hover:bg-white/5' : 'hover:bg-gray-50'} group transition-colors">
                                <td class="p-3">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-[10px] ${adminText} font-mono">${order.id}</span>
                                    </div>
                                    <div class="text-[9px] ${adminTextMuted} font-mono mt-0.5 opacity-60">Ref: ${order.refNumber}</div>
                                    <div class="text-[9px] ${adminTextMuted} mt-0.5 uppercase tracking-wide">${order.product} <span class="${isDark ? 'text-zinc-600' : 'text-gray-400'}">x${order.quantity}</span></div>
                                </td>
                                <td class="p-3">
                                    <span class="${order.status === 'Completed' ? 'text-emerald-400 border-emerald-500/20 bg-emerald-500/5' : (order.status === 'Cancelled' ? 'text-red-400 border-red-500/20 bg-red-500/5' : (order.status === 'Refund Pending' ? 'text-orange-400 border-orange-500/20 bg-orange-500/5' : 'text-yellow-400 border-yellow-500/20 bg-yellow-500/5'))} border text-[8px] font-bold px-1.5 py-0.5 uppercase rounded-sm">${order.status}</span>
                                </td>
                                <td class="p-3 text-right">
                                    ${order.status === 'Processing' || order.status === 'Refund Pending' ? `
                                        <div class="flex gap-1 justify-end">
                                            <button onclick="state.activeFulfillmentId = '${order.id}'; render()" class="${isDark ? 'bg-white text-black hover:bg-zinc-200' : 'bg-gray-800 text-white hover:bg-gray-700 admin-fulfill-btn'} px-2 py-1 text-[9px] uppercase font-bold tracking-wide">Fulfill</button>
                                            <button onclick="window.adminAction('${order.id}', 'cancel')" class="border border-white/10 text-zinc-400 hover:text-white px-2 py-1 text-[9px] uppercase font-bold"><i data-lucide="x" class="w-3 h-3"></i></button>
                                            <button onclick="window.adminAction('${order.id}', 'refund')" class="border border-white/10 text-zinc-400 hover:text-white px-2 py-1 text-[9px] uppercase font-bold"><i data-lucide="refresh-ccw" class="w-3 h-3"></i></button>
                                        </div>
                                    ` : order.status === 'Completed' ? `
                                        <div class="relative inline-block">
                                            <button onclick="window.markMessagesRead('${order.id}'); state.activeFulfillmentId = state.activeFulfillmentId === '${order.id}' ? null : '${order.id}'; render()" class="text-[9px] text-zinc-500 hover:text-white font-bold uppercase underline">View</button>
                                            ${msgCount > 0 ? `<span class="absolute -top-2 -right-3 bg-red-500 text-white text-[8px] px-1.5 rounded-full animate-pulse">${msgCount}</span>` : ''}
                                        </div>
                                    ` : ''}
                                </td>
                            </tr>
                            ${state.activeFulfillmentId === order.id ? `
                            <tr>
                                <td colspan="3" class="${isDark ? 'bg-zinc-800/50' : 'bg-gray-100'} p-4 border-y ${adminBorder} animate-enter">
                                    ${order.status === 'Completed' ? `
                                        <div class="mb-4">
                                            <h4 class="text-[9px] font-bold uppercase mb-2 ${adminTextMuted} tracking-wider">Account Details</h4>
                                            ${order.accounts.map(acc => `
                                                <div class="${isDark ? 'bg-black/50 border-white/5' : 'bg-white border-gray-200'} p-3 mb-2 border rounded-lg shadow-sm">
                                                    <div class="flex justify-between items-center mb-1">
                                                        <span class="text-emerald-600 font-mono text-[10px]">${acc.creds}</span>
                                                        <span class="text-[8px] ${adminTextMuted}">${acc.otpRequest.status === 'sent' ? 'OTP Sent' : 'No OTP'}</span>
                                                    </div>
                                                    ${acc.messages && acc.messages.length > 0 ? `
                                                    <div class="border-t ${adminBorder} mt-2 pt-2">
                                                        ${acc.messages.map(msg => `
                                                            <div class="text-[8px] ${msg.sender === 'admin' ? 'text-emerald-600' : adminTextMuted} font-mono mb-0.5">
                                                                <span class="uppercase font-bold">${msg.sender}:</span> ${msg.text}
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                    ` : ''}
                                                    <div class="flex gap-2 mt-2">
                                                        <input type="text" id="admin-msg-${acc.id}" placeholder="Reply to user..." class="${adminInput} text-[9px] px-2 py-1.5 w-full focus:outline-none focus:border-emerald-500 rounded-sm border" />
                                                        <button onclick="window.sendAccountMessage('${order.id}', '${acc.id}', document.getElementById('admin-msg-${acc.id}').value, 'admin')" class="${isDark ? 'bg-zinc-700 hover:bg-zinc-600 text-white' : 'bg-gray-800 hover:bg-gray-700 text-white admin-send-btn'} px-2 rounded-sm text-[9px] uppercase font-bold">Send</button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <h4 class="text-[9px] font-bold uppercase mb-2 ${adminTextMuted} tracking-wider">Add Accounts (one per line)</h4>
                                        <div class="space-y-3 mb-3">
                                            <div>
                                                <label class="block text-[8px] font-bold uppercase ${adminTextMuted} mb-1 tracking-wider">Email / Username</label>
                                                <textarea id="fulfillmentEmailsArea" class="${adminInput} w-full border p-2 text-[10px] font-mono h-16 focus:border-emerald-500 focus:outline-none rounded-sm resize-none" placeholder="user1@email.com&#10;user2@email.com"></textarea>
                                            </div>
                                            <div>
                                                <label class="block text-[8px] font-bold uppercase ${adminTextMuted} mb-1 tracking-wider">Password</label>
                                                <input type="password" id="fulfillmentPasswordsArea" class="${adminInput} w-full border p-2 text-[10px] font-mono focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="One password for all accounts" />
                                            </div>
                                        </div>
                                        <div class="flex justify-end gap-2">
                                            <button onclick="state.activeFulfillmentId = null; render()" class="${adminTextMuted} hover:${isDark ? 'text-white' : 'text-gray-900'} text-[10px] font-bold uppercase transition-colors">Cancel</button>
                                            <button onclick="window.fulfillOrder('${order.id}')" class="bg-emerald-600 hover:bg-emerald-500 text-white btn-green-light px-3 py-1.5 text-[9px] uppercase font-bold tracking-wide">Confirm & Send</button>
                                        </div>
                                    `}
                                </td>
                            </tr>` : ''}
                            `}).join('')}
                        </tbody>
                    </table>
                </div>`;
            } else if (state.adminTab === 'products') {
                const cardBg = isDark ? 'bg-black/50 border-white/5' : 'bg-white border-gray-200';
                const cardBorderT = isDark ? 'border-t border-white/5' : 'border-t border-gray-200';
                tabContent = `
                <div class="${adminCard} border ${adminBorder} rounded-lg overflow-hidden">
                    <div class="p-4 border-b ${adminBorder} flex justify-between items-center">
                        <h3 class="text-[10px] font-bold uppercase ${adminTextMuted} tracking-widest">Inventory Management</h3>
                        <button onclick="window.openAddProductModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white btn-green-light px-3 py-1.5 text-[9px] uppercase font-bold tracking-wide flex items-center gap-2"><i data-lucide="plus" class="w-3 h-3"></i> Add Product</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                        ${state.products.map(p => `
                        <div class="${cardBg} border p-4 relative group rounded-lg shadow-sm">
                            <div class="mb-3">
                                <label class="text-[8px] ${adminTextMuted} uppercase font-bold block mb-1">Product Title</label>
                                <input type="text" id="prod-title-${p.id}" value="${p.title}" class="${adminInput} w-full text-xs p-2 focus:outline-none focus:border-emerald-500 rounded-sm border" />
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-[8px] ${adminTextMuted} uppercase font-bold block mb-1">Price</label>
                                    <div class="relative">
                                        <span class="absolute left-2 top-1/2 -translate-y-1/2 ${adminTextMuted} text-xs">₱</span>
                                        <input type="number" id="prod-price-${p.id}" value="${p.price}" class="${adminInput} w-full text-xs py-2 pl-6 pr-2 focus:outline-none focus:border-emerald-500 rounded-sm border" />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-[8px] ${adminTextMuted} uppercase font-bold block mb-1">Stock</label>
                                    <input type="number" id="prod-stock-${p.id}" value="${p.stock}" class="${adminInput} w-full text-xs p-2 focus:outline-none focus:border-emerald-500 rounded-sm border" />
                                </div>
                            </div>

                            <div class="flex justify-end pt-2 ${cardBorderT}">
                                <button onclick="window.saveProductChanges('${p.id}')" class="${isDark ? 'bg-white text-black hover:bg-zinc-200' : 'bg-gray-900 text-white hover:bg-gray-800 admin-save-btn'} px-3 py-1.5 text-[9px] uppercase font-bold tracking-wide rounded-sm">Save Changes</button>
                            </div>
                        </div>
                        `).join('')}
                    </div>
                </div>`;
            } else if (state.adminTab === 'otp') {
                const pendingReqs = [];
                state.orders.forEach(o => {
                    if (o.accounts) o.accounts.forEach((a, idx) => {
                        if (a.otpRequest.status === 'pending') pendingReqs.push({ orderId: o.id, accId: a.id, creds: a.creds, idx: idx + 1, reqAt: a.otpRequest.requestedAt });
                    });
                });

                if (pendingReqs.length > 0) {
                    tabContent = `
                    <div class="${adminCard} border ${adminBorder} divide-y ${adminBorder} rounded-lg overflow-hidden">
                        ${pendingReqs.map(req => `
                        <div class="p-3 ${isDark ? 'bg-yellow-500/5' : 'bg-amber-50'} animate-enter">
                            <div class="mb-2">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-[10px] ${adminText} font-mono">${req.orderId}</span>
                                    <span class="text-[8px] border ${adminBorder} px-1 ${adminTextMuted} uppercase font-bold">Slot #${req.idx}</span>
                                </div>
                                <div class="font-mono text-[10px] px-2 py-0.5 inline-block ${isDark ? 'bg-black border-white/10' : 'bg-gray-100 border-gray-300'} border text-emerald-600 rounded-sm mb-1">${req.creds}</div>
                                <div class="flex items-center gap-1 text-[9px] ${adminTextMuted}"><i data-lucide="clock" class="w-3 h-3"></i> T+ ${Math.floor((new Date() - new Date(req.reqAt)) / 60000)}m</div>
                            </div>
                            <div class="flex gap-2 items-center ${isDark ? 'bg-black border-white/10' : 'bg-white border-gray-200'} p-1.5 pr-2 rounded border">
                                <input type="text" id="otp-input-${req.accId}" placeholder="Enter 2FA Code" class="${adminInput} p-1.5 text-xs w-full focus:outline-none font-mono rounded border flex-1" />
                                <button onclick="window.sendOtp('${req.orderId}', '${req.accId}', document.getElementById('otp-input-${req.accId}').value)" class="bg-emerald-600 hover:bg-emerald-500 text-white btn-green-light p-2 rounded-sm shrink-0"><i data-lucide="send" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        `).join('')}
                    </div>`;
                } else {
                    tabContent = `<div class="p-8 text-center ${adminTextMuted} ${adminCard} border ${adminBorder} rounded-lg"><p class="text-[10px] font-bold uppercase tracking-widest">No pending OTP requests</p></div>`;
                }
            } else if (state.adminTab === 'settings') {
                const qrUrl = (state.paymentSettings?.payment_qr_url || '').trim();
                const payNum = (state.paymentSettings?.payment_number || '').trim();
                const captchaProvider = (state.paymentSettings?.captcha_provider || 'recaptcha');
                tabContent = `
                <div class="space-y-6 max-w-md">
                    <div class="${adminCard} border ${adminBorder} p-6">
                        <h3 class="text-[10px] font-bold uppercase ${adminTextMuted} mb-4 tracking-widest">Captcha Provider</h3>
                        <div class="mb-4">
                            <label class="block text-[9px] font-bold uppercase ${adminTextMuted} mb-1.5 tracking-wider">Use on register & checkout</label>
                            <select id="settingsCaptchaProvider" class="${adminInput} w-full py-2.5 px-3 text-xs font-mono focus:outline-none focus:border-emerald-500/50">
                                <option value="recaptcha" ${captchaProvider === 'recaptcha' ? 'selected' : ''}>Google reCAPTCHA</option>
                                <option value="turnstile" ${captchaProvider === 'turnstile' ? 'selected' : ''}>Cloudflare Turnstile</option>
                            </select>
                        </div>
                        <button onclick="window.savePaymentSettings()" class="${isDark ? 'bg-white text-black hover:bg-zinc-200' : 'bg-gray-900 text-white hover:bg-gray-800 admin-settings-btn'} font-bold py-2 px-4 text-[10px] uppercase tracking-wider mb-6 transition-colors">Save captcha setting</button>
                    </div>
                    <div class="${adminCard} border ${adminBorder} p-6">
                        <h3 class="text-[10px] font-bold uppercase ${adminTextMuted} mb-4 tracking-widest">Payment (QR + Number)</h3>
                        <p class="text-[9px] ${adminTextMuted} mb-3">Upload your QR image in Supabase Storage (Storage → New bucket "payment", Public ON → Upload file), then paste the Public URL below.</p>
                        <div class="mb-4">
                            <label class="block text-[9px] font-bold uppercase ${adminTextMuted} mb-1.5 tracking-wider">Payment QR image URL</label>
                            <input type="url" id="settingsPaymentQrUrl" placeholder="https://...supabase.co/storage/v1/object/public/payment/qr.png" class="${adminInput} w-full py-2.5 px-3 text-xs font-mono focus:outline-none focus:border-emerald-500/50" value="${qrUrl.replace(/"/g, '&quot;')}" />
                        </div>
                        <div class="mb-4">
                            <label class="block text-[9px] font-bold uppercase ${adminTextMuted} mb-1.5 tracking-wider">GCash / payment number</label>
                            <input type="text" id="settingsPaymentNumber" placeholder="0917 123 4567" class="${adminInput} w-full py-2.5 px-3 text-xs font-mono focus:outline-none focus:border-emerald-500/50" value="${payNum.replace(/"/g, '&quot;')}" />
                        </div>
                        <button onclick="window.savePaymentSettings()" class="${isDark ? 'bg-white text-black hover:bg-zinc-200' : 'bg-gray-900 text-white hover:bg-gray-800 admin-settings-btn'} font-bold py-2 px-4 text-[10px] uppercase tracking-wider transition-colors">Save payment settings</button>
                    </div>
                    <div class="${adminCard} border ${adminBorder} p-6">
                        <h3 class="text-[10px] font-bold uppercase ${adminTextMuted} mb-4 tracking-widest">Security Settings</h3>
                        <div class="mb-4">
                            <label class="block text-[9px] font-bold uppercase ${adminTextMuted} mb-1.5 tracking-wider">New Password</label>
                            <input type="password" id="newAdminPass" class="${adminInput} w-full py-2.5 px-3 text-xs font-mono focus:outline-none focus:border-emerald-500/50 transition-colors" />
                        </div>
                        <button onclick="window.updateAdminPassword()" class="${isDark ? 'bg-white text-black hover:bg-zinc-200' : 'bg-gray-900 text-white hover:bg-gray-800 admin-settings-btn'} font-bold py-2 px-4 text-[10px] uppercase tracking-wider transition-colors">Update Password</button>
                    </div>
                </div>`;
            }

            const tabActive = isDark ? 'border-b-2 border-white text-white' : 'border-b-2 border-gray-900 text-gray-900';
            const tabInactive = isDark ? 'text-zinc-600 hover:text-zinc-400' : 'text-gray-500 hover:text-gray-700';
            return `
            <div class="min-h-screen ${adminBg} ${adminText} font-sans">
                <div class="fixed top-0 left-0 w-full z-50 ${adminHeaderBg} border-b p-4 flex justify-between items-center">
                    <h2 class="font-black text-xs tracking-[0.2em] flex items-center gap-2 ${isDark ? 'text-zinc-300' : 'text-gray-700'}">ADMIN PANEL <span class="bg-red-900/50 text-red-200 border border-red-500/30 px-1 text-[8px] rounded-sm">V3.1</span></h2>
                    <button onclick="window.handleAdminLogout()" class="text-[9px] font-bold hover:text-emerald-500 uppercase tracking-wider transition-colors">Logout</button>
                </div>
                <div class="pt-20 max-w-7xl mx-auto p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
                        <div class="${adminCard} p-3 border"><p class="text-[8px] ${adminTextMuted} uppercase font-bold tracking-widest">Gross Rev</p><p class="text-lg font-bold font-mono ${adminText}">${formatPHP(revenue)}</p></div>
                        <div class="${adminCard} p-3 border"><p class="text-[8px] ${adminTextMuted} uppercase font-bold tracking-widest">Total Tx</p><p class="text-lg font-bold ${adminText}">${state.orders.length}</p></div>
                        <div class="${adminCard} p-3 border"><p class="text-[8px] ${adminTextMuted} uppercase font-bold tracking-widest">Pending</p><p class="text-lg font-bold text-yellow-600">${pending}</p></div>
                        <div onclick="state.adminTab = 'otp'; render()" class="${adminCard} p-3 border cursor-pointer hover:border-emerald-500/30 transition-colors ${pendingOtp > 0 ? 'border-red-500/50 shadow-[0_0_15px_rgba(239,68,68,0.1)]' : ''}">
                            <p class="text-[8px] ${adminTextMuted} uppercase font-bold flex justify-between tracking-widest">OTP Requests <i data-lucide="radio" class="w-3 h-3"></i></p>
                            <p class="text-lg font-bold text-red-500">${pendingOtp}</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 mb-5 border-b ${adminBorder} pb-1 px-1 overflow-x-auto">
                        <button onclick="state.adminTab = 'orders'; render()" class="text-[9px] font-bold uppercase pb-2 px-1 transition-all tracking-widest ${state.adminTab === 'orders' ? tabActive : tabInactive}">Orders</button>
                        <button onclick="state.adminTab = 'products'; render()" class="text-[9px] font-bold uppercase pb-2 px-1 transition-all tracking-widest ${state.adminTab === 'products' ? tabActive : tabInactive}">Stocks</button>
                        <button onclick="state.adminTab = 'otp'; render()" class="text-[9px] font-bold uppercase pb-2 px-1 transition-all tracking-widest flex items-center gap-2 ${state.adminTab === 'otp' ? tabActive : tabInactive}">OTP Codes ${pendingOtp > 0 ? `<span class="bg-red-500 text-white px-1.5 rounded-full text-[8px] animate-pulse">${pendingOtp}</span>` : ''}</button>
                        <button onclick="state.adminTab = 'settings'; render()" class="text-[9px] font-bold uppercase pb-2 px-1 transition-all tracking-widest ${state.adminTab === 'settings' ? tabActive : tabInactive}">Settings</button>
                    </div>
                    ${tabContent}
                </div>
            </div>`;
        }

        function render(animate = true) {
            const app = document.getElementById('app');
            let html = '';

            if (state.view === 'admin') {
                html = renderAdmin();
            } else if (state.view === 'login') {
                html = renderLogin();
            } else if (state.view === 'register') {
                html = renderRegister();
            } else if (state.view === 'forgot-password') {
                html = renderForgotPassword();
            } else if (state.view === 'my-orders') {
                html = renderHeader() + renderUserOrders();
            } else {
                html = renderHeader();
                if (state.view === 'home') html += renderHome(animate);
                else if (state.view === 'product') html += renderProduct(animate);
                else if (state.view === 'checkout') html += renderCheckout(animate);
                else if (state.view === 'success') html += renderSuccess(animate);
                else if (state.view === 'tracker') html += renderTracker(animate);
            }

            app.innerHTML = html;
            lucide.createIcons();
            
            // Re-render captcha (reCAPTCHA or Turnstile per admin setting)
            if (state.view === 'checkout' || state.view === 'register') setTimeout(renderCaptcha, 100);

            // Clear existing cooldown timer
            if (window.otpCooldownTimer) {
                clearInterval(window.otpCooldownTimer);
                window.otpCooldownTimer = null;
            }

            // Set up cooldown timer for OTP requests
            if (state.view === 'my-orders' && state.userOrders && state.userOrders.length > 0) {
                const hasActiveCooldown = state.userOrders.some(order => 
                    order.accounts && order.accounts.some(acc => {
                        const otp = acc.otpRequest || {};
                        if(otp.requestedAt) {
                            const lastRequestTime = new Date(otp.requestedAt).getTime();
                            const now = new Date().getTime();
                            const timeSinceLastRequest = (now - lastRequestTime) / 1000;
                            return timeSinceLastRequest < 120; // 2 minutes
                        }
                        return false;
                    })
                );

                if (hasActiveCooldown) {
                    window.otpCooldownTimer = setInterval(() => {
                        const stillHasCooldown = state.userOrders.some(order => 
                            order.accounts && order.accounts.some(acc => {
                                const otp = acc.otpRequest || {};
                                if(otp.requestedAt) {
                                    const lastRequestTime = new Date(otp.requestedAt).getTime();
                                    const now = new Date().getTime();
                                    const timeSinceLastRequest = (now - lastRequestTime) / 1000;
                                    return timeSinceLastRequest < 120;
                                }
                                return false;
                            })
                        );
                        if (stillHasCooldown && state.view === 'my-orders') {
                            render(false);
                        } else {
                            if (window.otpCooldownTimer) {
                                clearInterval(window.otpCooldownTimer);
                                window.otpCooldownTimer = null;
                            }
                        }
                    }, 1000);
                }
            }

            if (animate) {
                window.scrollTo(0, 0);
            }
        }

        // Functions to Expose
        window.goHome = goHome;
        window.setView = setView;
        window.toggleTheme = toggleTheme;
        window.toggleUiVariant = toggleUiVariant;
        window.showOrderAccounts = showOrderAccounts;
        window.clearOrderSelection = clearOrderSelection;
        window.selectProduct = selectProduct;
        window.updateQuantity = updateQuantity;
        window.submitOrder = submitOrder;
        window.handleTrack = handleTrack;
        window.cancelOrder = cancelOrder;
        window.toggleAccountUsed = toggleAccountUsed;
        window.requestOtp = requestOtp;
        window.handleAdminLogin = handleAdminLogin;
        window.handleAdminLogout = handleAdminLogout; 
        window.fulfillOrder = fulfillOrder;
        window.adminAction = adminAction;
        window.savePaymentSettings = savePaymentSettings;
        window.updateAdminPassword = updateAdminPassword;
        window.sendAccountMessage = sendAccountMessage;
        window.sendOtp = sendOtp;
        window.callGemini = callGemini;
        window.showToast = showToast;
        window.applyDiscount = applyDiscount;
        window.submitRefundRequest = submitRefundRequest;
        window.copyToClipboard = copyToClipboard;
        window.togglePassword = togglePassword;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.confirmModalAction = confirmModalAction;
        window.deleteOrder = deleteOrder;
        window.toggleOrderDetails = toggleOrderDetails;
        window.markMessagesRead = markMessagesRead;
        window.togglePayWithCredits = togglePayWithCredits;
        window.setPaymentMethod = setPaymentMethod;
        window.createStripeCheckoutAndRedirect = createStripeCheckoutAndRedirect;
        
        // New Expose Functions
        window.openAddProductModal = openAddProductModal;
        window.closeAddProductModal = closeAddProductModal;
        window.submitNewProduct = submitNewProduct;
        window.saveProductChanges = saveProductChanges;
        
        // Auth Expose
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleUserLogout = handleUserLogout;
        window.handlePasswordReset = handlePasswordReset;

        // Init
        async function init() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('stripe') === 'success' && params.get('session_id')) {
                const sessionId = params.get('session_id');
                window.history.replaceState({}, '', window.location.pathname + (window.location.hash || ''));
                await initAuth();
                if (!supabaseClient) {
                    showToast("Database connection failed", "error");
                    return;
                }
                await confirmStripeOrder(sessionId);
                render();
                return;
            }

            if (!supabaseClient) {
                showToast("Database connection failed", "error");
                return;
            }
            
            await initAuth();
            await fetchProducts();
            await fetchPaymentSettings();
            setupRealtime();
            render();
        }

        init();

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StakzShop | Digital Asset Vault</title>
    
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        zinc: {
                            850: '#202023',
                            900: '#18181b',
                            950: '#09090b',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'marquee': 'marquee 25s linear infinite',
                    },
                    keyframes: {
                        marquee: {
                            '0%': { transform: 'translateX(0%)' },
                            '100%': { transform: 'translateX(-100%)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { 
            background-color: #000000; 
            color: #f4f4f5; 
            -webkit-font-smoothing: antialiased;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 2px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; }

        /* Animations */
        .animate-enter { animation: enter 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes enter {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .glass {
            background: rgba(24, 24, 27, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Toast Container */
        #toast-container {
            position: fixed;
            top: 4.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 90%;
            max-width: 350px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 14px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.8);
            animation: slideDown 0.3s ease-out forwards;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
        <div class="bg-zinc-900 border border-white/10 p-6 rounded-lg max-w-xs w-full shadow-2xl transform scale-95 transition-transform duration-200 mx-4" id="modal-content">
            <div class="flex flex-col items-center text-center mb-4">
                <div class="w-10 h-10 bg-zinc-800 rounded-full flex items-center justify-center mb-3 text-zinc-400" id="modal-icon">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                </div>
                <h3 id="modal-title" class="text-lg font-bold text-white tracking-tight">Confirm Action</h3>
            </div>
            <p id="modal-message" class="text-zinc-400 text-xs mb-6 leading-relaxed text-center">Are you sure you want to proceed?</p>
            <div class="flex gap-3">
                <button onclick="window.closeModal()" class="flex-1 py-3 text-[10px] font-bold uppercase text-zinc-400 hover:text-white transition-colors bg-zinc-800/50 hover:bg-zinc-800 rounded-sm tracking-wider border border-white/5">Cancel</button>
                <button onclick="window.confirmModalAction()" class="flex-1 py-3 text-[10px] font-bold uppercase text-black bg-white hover:bg-zinc-200 transition-colors rounded-sm tracking-wider shadow-lg" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md hidden opacity-0 transition-opacity duration-200">
        <div class="bg-zinc-900 border border-white/10 p-6 rounded-lg max-w-md w-full shadow-2xl transform scale-95 transition-transform duration-200 mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-sm font-bold uppercase tracking-widest text-white">Add New Product</h3>
                <button onclick="window.closeAddProductModal()" class="text-zinc-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Title</label>
                    <input type="text" id="new-prod-title" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="e.g. SHEIN ACCT (100c)" />
                </div>
                <div>
                    <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Tag</label>
                    <input type="text" id="new-prod-tag" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="e.g. HOT SALE" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Price (₱)</label>
                        <input type="number" id="new-prod-price" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="0" />
                    </div>
                    <div>
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Initial Stock</label>
                        <input type="number" id="new-prod-stock" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="0" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Bulk Price (₱)</label>
                        <input type="number" id="new-prod-bulk-price" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="0" />
                    </div>
                    <div>
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Bulk Threshold</label>
                        <input type="number" id="new-prod-bulk-thresh" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" value="10" />
                    </div>
                </div>
                <div>
                    <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1">Description</label>
                    <textarea id="new-prod-desc" rows="3" class="w-full bg-black border border-zinc-700 p-2 text-xs text-white focus:border-emerald-500 focus:outline-none rounded-sm" placeholder="Product details..."></textarea>
                </div>
                <button onclick="window.submitNewProduct()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 text-[10px] uppercase tracking-widest rounded-sm transition-colors mt-2">
                    Create Product
                </button>
            </div>
        </div>
    </div>

    <div id="app" class="w-full min-h-screen bg-black overflow-x-hidden relative text-zinc-100 flex flex-col text-sm">
        <!-- Content injected by JS -->
        <div class="flex items-center justify-center h-screen">
            <div class="flex flex-col items-center gap-2">
                <i data-lucide="loader" class="animate-spin w-6 h-6 text-emerald-500"></i>
                <span class="text-xs font-mono text-zinc-500 uppercase">Connecting to Database...</span>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const SITE_NAME = "StakzShop";
        const GCASH_QR_URL = "https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg"; 
        const GCASH_NUMBER = "0917 123 4567";
        const apiKey = ""; // Enter Gemini API Key Here

        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://kbecxughnfneiyyxsizb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtiZWN4dWdobmZuZWl5eXhzaXpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODkxOTcsImV4cCI6MjA4NjY2NTE5N30.m4c9DdUsoCbOJ1arpZ_-3Pb8rXwtGamoGtTLE9grdig';
        
        // Initialize Client
        let supabaseClient;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) {
            console.error("Supabase failed to init:", e);
        }

        // --- State Management ---
        const state = {
            view: 'home',
            user: null, // Logged in customer
            products: [], // Fetched from DB
            orders: [], // Admin view orders
            userOrders: [], // Logged in user orders
            selectedProduct: null,
            quantity: 1,
            refNumber: '',
            lastOrderId: null,
            trackerInput: '',
            searchResult: null,
            adminAuth: false,
            adminTab: 'orders',
            activeFulfillmentId: null,
            fulfillmentText: '',
            aiLoading: false,
            aiContent: null,
            discount: 0,
            isSubmitting: false,
            authLoading: false,
            modalCallback: null // Stores the function to execute on confirmation
        };

        // --- Helpers ---
        const formatPHP = (amount) => new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount);
        const generateOrderId = () => 'ORD-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        const formatDate = (dateStr) => new Date(dateStr).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            let icon = '';
            if (type === 'success') icon = '<i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i>';
            else if (type === 'error') icon = '<i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i>';
            else icon = '<i data-lucide="info" class="w-4 h-4 text-blue-400"></i>';

            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard', 'success'))
                .catch(() => fallbackCopyTextToClipboard(text));
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard', 'success');
            } catch (err) {
                showToast('Copy failed', 'error');
            }
            document.body.removeChild(textArea);
        }

        function togglePassword(id) {
            const input = document.getElementById(id);
            if (input) {
                input.type = input.type === "password" ? "text" : "password";
            }
        }

        // --- Modal Logic ---
        function showModal(title, message, callback, type = 'danger', confirmText = 'Confirm') {
            const modal = document.getElementById('confirmation-modal');
            const modalContent = document.getElementById('modal-content');
            
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.textContent = confirmText;
            
            const iconContainer = document.getElementById('modal-icon');
            
            // Customize styling based on type
            if (type === 'danger') {
                confirmBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase text-white bg-red-600 hover:bg-red-500 transition-colors rounded-sm tracking-wider shadow-lg shadow-red-900/20";
                iconContainer.className = "w-10 h-10 bg-red-500/10 rounded-full flex items-center justify-center mb-3 text-red-500";
                iconContainer.innerHTML = '<i data-lucide="alert-triangle" class="w-5 h-5"></i>';
            } else if (type === 'warning') {
                confirmBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase text-black bg-orange-400 hover:bg-orange-300 transition-colors rounded-sm tracking-wider shadow-lg shadow-orange-900/20";
                iconContainer.className = "w-10 h-10 bg-orange-500/10 rounded-full flex items-center justify-center mb-3 text-orange-500";
                iconContainer.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5"></i>';
            } else {
                // Default / Success
                confirmBtn.className = "flex-1 py-3 text-[10px] font-bold uppercase text-black bg-white hover:bg-zinc-200 transition-colors rounded-sm tracking-wider shadow-lg";
                iconContainer.className = "w-10 h-10 bg-zinc-800 rounded-full flex items-center justify-center mb-3 text-white";
                iconContainer.innerHTML = '<i data-lucide="info" class="w-5 h-5"></i>';
            }
            
            state.modalCallback = callback;
            lucide.createIcons();
            
            modal.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            });
        }

        function closeModal() {
            const modal = document.getElementById('confirmation-modal');
            const modalContent = document.getElementById('modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                state.modalCallback = null;
            }, 200);
        }

        function confirmModalAction() {
            if (state.modalCallback) {
                state.modalCallback();
            }
            closeModal();
        }

        function openAddProductModal() {
            const modal = document.getElementById('add-product-modal');
            const modalContent = modal.querySelector('div');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            });
        }

        function closeAddProductModal() {
            const modal = document.getElementById('add-product-modal');
            const modalContent = modal.querySelector('div');
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        async function submitNewProduct() {
            const title = document.getElementById('new-prod-title').value;
            const tag = document.getElementById('new-prod-tag').value;
            const price = document.getElementById('new-prod-price').value;
            const stock = document.getElementById('new-prod-stock').value;
            const bulkPrice = document.getElementById('new-prod-bulk-price').value;
            const bulkThresh = document.getElementById('new-prod-bulk-thresh').value;
            const desc = document.getElementById('new-prod-desc').value;

            if(!title || !price || !stock) return showToast("Title, Price and Stock are required", "error");

            const { error } = await supabaseClient.from('products').insert([{
                title, tag, price, stock, 
                bulk_price: bulkPrice || price,
                bulk_threshold: bulkThresh || 10,
                description: desc,
                color: 'bg-zinc-900'
            }]);

            if(error) showToast("Failed to create product", "error");
            else {
                showToast("Product Created", "success");
                closeAddProductModal();
                fetchProducts();
            }
        }

        // --- Supabase Logic ---

        async function fetchProducts() {
            if(!supabaseClient) return;
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .order('id', { ascending: true });

            if (data) {
                state.products = data;
                // If rendering admin page, refresh it to show new products
                if(state.view === 'admin' && state.adminTab === 'products') {
                    render(false);
                } else if(state.view === 'home') {
                    render(false);
                }
            } else if (error) {
                console.error("Fetch products error:", error);
            }
        }

        // Fetch All Orders (Admin Only)
        async function fetchAllOrders() {
            if(!supabaseClient || !state.adminAuth) return;
            const { data, error } = await supabaseClient
                .from('orders')
                .select('*')
                .order('created_at', { ascending: false });

            if (data) {
                state.orders = data.map(mapOrderData);
                if(state.view === 'admin') render(false);
            }
        }

        // Fetch My Orders (User Only)
        async function fetchUserOrders() {
            if(!supabaseClient || !state.user) return;
            const { data, error } = await supabaseClient
                .from('orders')
                .select('*')
                .eq('user_id', state.user.id)
                .order('created_at', { ascending: false });

            if(data) {
                state.userOrders = data.map(mapOrderData);
            }
        }

        function mapOrderData(o) {
            return {
                id: o.id,
                date: o.created_at,
                product: o.product_title,
                quantity: o.quantity,
                total: o.total,
                refNumber: o.ref_number,
                status: o.status,
                accounts: o.accounts_data || [],
                refundRequest: o.refund_request || null,
                userId: o.user_id
            };
        }

        function setupRealtime() {
            if(!supabaseClient) return;
            
            // Listen for Products
            supabaseClient.channel('public:products')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, payload => {
                fetchProducts();
            })
            .subscribe();

            // Listen for Orders
            supabaseClient.channel('public:orders')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
                if(state.adminAuth) fetchAllOrders();
                if(state.user) fetchUserOrders().then(() => {
                    if (state.view === 'my-orders') render(false);
                });
                if(state.view === 'tracker' && state.trackerInput) {
                    handleTrack(true);
                }
            })
            .subscribe();
        }

        // --- Auth Functions ---

        async function initAuth() {
            if(!supabaseClient) return;
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                state.user = session.user;
                fetchUserOrders();
            }

            supabaseClient.auth.onAuthStateChange((_event, session) => {
                state.user = session ? session.user : null;
                if(state.user) fetchUserOrders();
                render();
            });
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            if(!email || !pass) return showToast("Please fill all fields", "error");

            state.authLoading = true;
            render(false);

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: pass
            });

            state.authLoading = false;
            
            if(error) {
                showToast(error.message, "error");
                render(false);
            } else {
                showToast("Login Successful", "success");
                state.user = data.user;
                goHome();
            }
        }

        async function handleRegister() {
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            if(!email || !pass) return showToast("Please fill all fields", "error");
            if(pass.length < 6) return showToast("Password must be 6+ chars", "error");

            state.authLoading = true;
            render(false);

            const { data, error } = await supabaseClient.auth.signUp({
                email: email,
                password: pass
            });

            state.authLoading = false;

            if(error) {
                showToast(error.message, "error");
                render(false);
            } else {
                showToast("Account created! Logging in...", "success");
                if(data.session) {
                    state.user = data.user;
                    goHome();
                } else {
                    showToast("Please check email for verification link", "info");
                    setView('login');
                }
            }
        }

        async function handlePasswordReset() {
            const email = document.getElementById('resetEmail').value;
            if(!email) return showToast("Please enter your email", "error");

            state.authLoading = true;
            render(false);

            const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
            
            state.authLoading = false;
            render(false);

            if(error) {
                showToast(error.message, "error");
            } else {
                showToast("Password reset link sent to email", "success");
                setView('login');
            }
        }

        async function handleUserLogout() {
            await supabaseClient.auth.signOut();
            state.user = null;
            state.userOrders = [];
            goHome();
            showToast("Logged out", "success");
        }

        // --- Core Logic ---

        async function init() {
            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
            window.scrollTo(0, 0);
            
            await initAuth();
            await fetchProducts(); // Fetch products on init
            setupRealtime();
            render();
            lucide.createIcons();
        }

        function goHome() {
            setView('home');
        }

        function setView(view) {
            state.view = view;
            if(view === 'home' || view === 'product') {
                state.discount = 0; 
                state.quantity = 1;
            }
            if (view === 'admin' && state.adminAuth) {
                fetchAllOrders();
            }
            render();
        }

        function selectProduct(id) {
            state.selectedProduct = state.products.find(p => p.id === id);
            // Check stock
            if(state.selectedProduct.stock <= 0) return showToast("Item out of stock", "error");
            
            state.quantity = 1;
            setView('product');
        }

        function updateQuantity(change) {
            const newQty = state.quantity + change;
            if (newQty >= 1) {
                state.quantity = newQty;
                render(false);
            }
        }

        function getPrice() {
            if (!state.selectedProduct) return 0;
            return state.quantity >= state.selectedProduct.bulk_threshold 
                ? state.selectedProduct.bulk_price 
                : state.selectedProduct.price;
        }

        function applyDiscount() {
            const input = document.getElementById('discountInput');
            if(!input) return;
            const code = input.value.trim().toUpperCase();
            if (code === 'TEST1111') {
                if (state.discount > 0) return showToast("Discount already applied", "info");
                state.discount = 0.05; 
                showToast("Voucher Applied: 5% OFF", "success");
                render(false); 
            } else if (code === '') {
                showToast("Please enter a code", "error");
            } else {
                showToast("Invalid Voucher Code", "error");
            }
        }

        async function submitOrder() {
            const refInput = document.getElementById('refNumberInput');
            if (!refInput || !refInput.value.trim()) {
                showToast("Please enter the payment reference number.", "error");
                return;
            }
            
            state.isSubmitting = true;
            render(false); 

            const baseTotal = getPrice() * state.quantity;
            const finalTotal = baseTotal - (baseTotal * state.discount);
            const newOrderId = generateOrderId();

            const dbPayload = {
                id: newOrderId,
                product_title: state.selectedProduct.title,
                quantity: state.quantity,
                total: finalTotal,
                ref_number: refInput.value.trim(),
                status: 'Processing',
                accounts_data: [],
                refund_request: null,
                user_id: state.user ? state.user.id : null 
            };

            const { error } = await supabaseClient.from('orders').insert([dbPayload]);

            if(error) {
                console.error(error);
                state.isSubmitting = false;
                render(false);
                showToast("Error submitting order. Try again.", "error");
                return;
            }

            state.lastOrderId = newOrderId;
            if(state.user) fetchUserOrders(); 
            
            state.isSubmitting = false;
            setView('success');
            showToast("Order submitted successfully", "success");
        }

        async function handleTrack(silent = false) {
            const input = document.getElementById('trackerInputVal');
            if(input) state.trackerInput = input.value.trim();
            
            if(!state.trackerInput && !silent) {
                showToast("Please enter an Order ID", "error");
                return;
            }

            const { data, error } = await supabaseClient
                .from('orders')
                .select('*')
                .eq('id', state.trackerInput)
                .single();

            if (data) {
                state.searchResult = mapOrderData(data);
            } else {
                state.searchResult = 'not-found';
            }
            
            if(!silent) render();
        }

        async function cancelOrder(id) {
            let orderDate = null;
            const inUser = state.userOrders.find(o => o.id === id);
            const inAdmin = state.orders.find(o => o.id === id);
            const inSearch = state.searchResult && state.searchResult.id === id ? state.searchResult : null;
            
            const target = inUser || inAdmin || inSearch;
            
            if (target) {
                orderDate = new Date(target.date);
                const timeDiff = new Date() - orderDate;
                if (timeDiff > 60000 && !state.adminAuth) { 
                    return showToast('Cancellation window has expired.', 'error');
                }
            }

            // Using Custom Modal
            showModal(
                'Cancel Order?',
                'Are you sure you want to cancel this order? This action cannot be undone.',
                async () => {
                    const { error } = await supabaseClient
                        .from('orders')
                        .update({ status: 'Cancelled' })
                        .eq('id', id);

                    if(error) showToast("Error cancelling order", "error");
                    else showToast("Order cancelled", "info");
                },
                'danger',
                'Yes, Cancel Order'
            );
        }

        async function submitRefundRequest(orderId) {
            const name = document.getElementById('refundName').value;
            const number = document.getElementById('refundNumber').value;

            if (!name || !number) return showToast("Please fill in all refund details", "error");

            const payload = {
                gcashName: name,
                gcashNumber: number,
                requestedAt: new Date().toISOString()
            };

            const { error } = await supabaseClient
                .from('orders')
                .update({ 
                    status: 'Refund Pending',
                    refund_request: payload
                })
                .eq('id', orderId);

            if(error) showToast("Failed to submit refund", "error");
            else showToast("Refund request submitted", "success");
        }

        // Admin & User Actions
        async function sendAccountMessage(orderId, accId, text, sender) {
            if(!text || !text.trim()) return;

            const { data, error: fetchError } = await supabaseClient
                .from('orders')
                .select('accounts_data')
                .eq('id', orderId)
                .single();
                
            if(fetchError || !data) return showToast("Error fetching order", "error");

            const updatedAccounts = data.accounts_data.map(acc => {
                if(acc.id === accId) {
                    const msgs = acc.messages || [];
                    return { 
                        ...acc, 
                        messages: [...msgs, { text: text.trim(), sender: sender, time: new Date().toISOString() }] 
                    };
                }
                return acc;
            });

            const { error } = await supabaseClient
                .from('orders')
                .update({ accounts_data: updatedAccounts })
                .eq('id', orderId);

            if(error) showToast("Message failed to send", "error");
            else {
                showToast("Message sent", "success");
                const inputEl = document.getElementById(sender === 'admin' ? `admin-msg-${accId}` : `msg-${accId}`);
                if(inputEl) inputEl.value = '';
            }
        }

        // Admin Logic
        async function handleAdminLogin() {
            const pass = document.getElementById('adminPassInput').value;
            
            const { data, error } = await supabaseClient
                .from('admins')
                .select('*')
                .eq('username', 'admin')
                .eq('password', pass)
                .single();

            if (data) {
                state.adminAuth = true;
                fetchAllOrders(); 
                render();
                showToast("Welcome back, Admin.", "success");
            } else {
                showToast('Invalid Access Code', 'error');
            }
        }

        function handleAdminLogout() {
            state.adminAuth = false;
            state.orders = []; 
            state.adminTab = 'orders';
            state.activeFulfillmentId = null;
            setView('admin'); 
            showToast("Logged out successfully", "success");
        }

        async function fulfillOrder(id) {
            const text = document.getElementById('fulfillmentTextArea').value;
            if (!text.trim()) return showToast("Please enter accounts", "error");

            const accountLines = text.trim().split('\n').filter(line => line.trim() !== '');
            const newAccounts = accountLines.map((line, index) => ({
                id: `acc-${Date.now()}-${index}`,
                creds: line.trim(),
                used: false,
                otpRequest: { status: 'idle', code: null, requestedAt: null },
                messages: [] 
            }));

            const { error } = await supabaseClient
                .from('orders')
                .update({ 
                    status: 'Completed',
                    accounts_data: newAccounts
                })
                .eq('id', id);

            if(!error) {
                state.activeFulfillmentId = null;
                showToast("Order fulfilled successfully", "success");
            } else {
                showToast("Database Error", "error");
            }
        }

        async function adminAction(id, action) {
            let updatePayload = {};
            let title = '';
            let message = '';
            let btnType = 'danger';
            let btnText = 'Confirm';

            if (action === 'cancel') {
                title = 'Cancel Order?';
                message = 'Are you sure you want to CANCEL this order? The customer will see the status change.';
                updatePayload = { status: 'Cancelled' };
                btnType = 'danger';
                btnText = 'Yes, Cancel';
            } else if (action === 'refund') {
                title = 'Refund Order?';
                message = 'Mark this order as REFUNDED? Ensure payment has been returned first.';
                updatePayload = { status: 'Refunded' };
                btnType = 'warning';
                btnText = 'Mark Refunded';
            } else return;

            // Using Custom Modal
            showModal(title, message, async () => {
                const { error } = await supabaseClient.from('orders').update(updatePayload).eq('id', id);
                if(error) showToast("Action failed", "error");
                else showToast(`Order ${action}ed`, "success");
            }, btnType, btnText);
        }

        async function updateAdminPassword() {
            const newPass = document.getElementById('newAdminPass').value;
            if (!newPass || newPass.length < 4) return showToast("Password too short", "error");

            const { data, error } = await supabaseClient
                .from('admins')
                .update({ password: newPass })
                .eq('username', 'admin')
                .select();

            if (error || data.length === 0) showToast("Update failed. Check database.", "error");
            else {
                showToast("Password updated. Please login again.", "success");
                handleAdminLogout();
            }
        }

        async function saveProductChanges(id) {
            const title = document.getElementById(`prod-title-${id}`).value;
            const price = document.getElementById(`prod-price-${id}`).value;
            const stock = document.getElementById(`prod-stock-${id}`).value;

            const { error } = await supabaseClient.from('products').update({
                title, price, stock
            }).eq('id', id);

            if(error) showToast("Failed to save changes", "error");
            else showToast("Changes saved", "success");
        }

        async function updateProduct(id, field, value) {
            // Deprecated direct update, used saveProductChanges instead.
            // Keeping empty to avoid errors if referenced elsewhere
        }

        async function sendOtp(orderId, accId, code) {
            const { data, error: fErr } = await supabaseClient.from('orders').select('accounts_data').eq('id', orderId).single();
            if(!data) return;

            const updatedAccounts = data.accounts_data.map(acc => {
                if(acc.id === accId) {
                    return { 
                        ...acc, 
                        otpRequest: { ...acc.otpRequest, status: 'sent', code: code } 
                    };
                }
                return acc;
            });

            const { error } = await supabaseClient
                .from('orders')
                .update({ accounts_data: updatedAccounts })
                .eq('id', orderId);

            if(!error) showToast("OTP Sent to user", "success");
        }
        
        async function requestOtp(orderId, accId) {
            const { data, error: fErr } = await supabaseClient.from('orders').select('accounts_data').eq('id', orderId).single();
            if(!data) return;

            const updatedAccounts = data.accounts_data.map(acc => {
                if(acc.id === accId) {
                    return { 
                        ...acc, 
                        otpRequest: { status: 'pending', code: null, requestedAt: new Date().toISOString() } 
                    };
                }
                return acc;
            });

            const { error } = await supabaseClient
                .from('orders')
                .update({ accounts_data: updatedAccounts })
                .eq('id', orderId);

            if(!error) showToast("OTP Requested. Wait for admin.", "info");
        }

        async function toggleAccountUsed(orderId, accId) {
             const { data, error: fErr } = await supabaseClient.from('orders').select('accounts_data').eq('id', orderId).single();
            if(!data) return;

            const updatedAccounts = data.accounts_data.map(acc => {
                if(acc.id === accId) return { ...acc, used: !acc.used };
                return acc;
            });

            const { error } = await supabaseClient.from('orders').update({ accounts_data: updatedAccounts }).eq('id', orderId);
            if(error) showToast("Update failed", "error");
        }

        function getPendingOtpCount() {
            let count = 0;
            state.orders.forEach(o => {
                if (o.accounts) {
                    o.accounts.forEach(a => {
                        if (a.otpRequest.status === 'pending') count++;
                    });
                }
            });
            return count;
        }

        async function callGemini(prompt, type) {
            state.aiLoading = true;
            state.aiContent = null;
            render(false); 

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    }
                );
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "System busy.";
                state.aiContent = { type, text };
            } catch (e) {
                console.error(e);
                state.aiContent = { type, text: "Connection error. Check API Key." };
            }
            
            state.aiLoading = false;
            render(false); 
        }

        // --- Render Functions ---

        function renderHeader() {
            return `
            <div class="fixed top-0 left-0 w-full z-50 glass">
                <div class="flex justify-between items-center h-14 px-4 max-w-7xl mx-auto">
                    <div class="flex items-center gap-3">
                        <button class="text-zinc-400 hover:text-white transition-colors"><i data-lucide="menu" class="w-4 h-4"></i></button>
                        <!-- Added pr-2 pb-1 to fix 'p' cutoff -->
                        <button onclick="window.goHome()" class="font-bold text-lg tracking-tighter italic bg-clip-text text-transparent bg-gradient-to-r from-white to-zinc-500 pr-2 pb-1">${SITE_NAME}</button>
                    </div>
                    <div class="flex items-center gap-4">
                        ${state.user 
                            ? `<button onclick="window.setView('my-orders')" class="text-[10px] font-bold uppercase hover:text-emerald-400 transition-colors">My Orders</button>
                               <button onclick="window.handleUserLogout()" class="text-zinc-400 hover:text-red-400 transition-colors"><i data-lucide="log-out" class="w-4 h-4"></i></button>`
                            : `<button onclick="window.setView('login')" class="text-[10px] font-bold uppercase hover:text-white transition-colors">Login</button>`
                        }
                        <button onclick="window.setView('tracker')" class="text-zinc-400 hover:text-white transition-colors"><i data-lucide="search" class="w-4 h-4"></i></button>
                        <button onclick="window.setView('admin')" class="text-zinc-400 hover:text-white transition-colors"><i data-lucide="hexagon" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>`;
        }

        function renderLogin() {
            // Added h-screen overflow-hidden to prevent scrolling
            return `
            <div class="h-screen overflow-hidden bg-black flex items-center justify-center p-6 animate-enter">
                <div class="max-w-xs w-full">
                    <div class="text-center mb-8">
                        <h2 class="text-xl font-bold text-white tracking-tighter mb-1">Welcome Back</h2>
                        <p class="text-zinc-500 text-[10px] font-mono">Sign in to manage your orders</p>
                    </div>
                    <div class="space-y-3">
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full bg-zinc-900 border border-zinc-800 p-3 text-xs text-white rounded-sm focus:border-emerald-500 focus:outline-none" />
                        <div class="relative">
                            <input type="password" id="loginPass" placeholder="Password" class="w-full bg-zinc-900 border border-zinc-800 p-3 text-xs text-white rounded-sm focus:border-emerald-500 focus:outline-none pr-10" />
                            <button onclick="window.togglePassword('loginPass')" class="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-500 hover:text-white"><i data-lucide="eye" class="w-4 h-4"></i></button>
                        </div>
                        <button onclick="window.handleLogin()" class="w-full bg-white hover:bg-zinc-200 text-black font-bold py-3 text-[10px] uppercase tracking-widest rounded-sm transition-colors ${state.authLoading ? 'opacity-50 cursor-not-allowed' : ''}">
                            ${state.authLoading ? 'Signing In...' : 'Sign In'}
                        </button>
                    </div>
                    <div class="mt-4 flex justify-between items-center px-1">
                        <button onclick="window.setView('forgot-password')" class="text-[10px] text-zinc-500 hover:text-zinc-300">Forgot Password?</button>
                        <button onclick="window.setView('register')" class="text-[10px] font-bold text-white hover:text-emerald-400 uppercase">Create Account</button>
                    </div>
                    <button onclick="window.goHome()" class="w-full text-zinc-600 hover:text-zinc-400 text-[9px] uppercase mt-8">Back to Store</button>
                </div>
            </div>`;
        }

        function renderRegister() {
            // Added h-screen overflow-hidden to prevent scrolling
            return `
            <div class="h-screen overflow-hidden bg-black flex items-center justify-center p-6 animate-enter">
                <div class="max-w-xs w-full">
                    <div class="text-center mb-8">
                        <h2 class="text-xl font-bold text-white tracking-tighter mb-1">Create Account</h2>
                        <p class="text-zinc-500 text-[10px] font-mono">Join StakzShop to save your history</p>
                    </div>
                    <div class="space-y-3">
                        <input type="email" id="regEmail" placeholder="Email" class="w-full bg-zinc-900 border border-zinc-800 p-3 text-xs text-white rounded-sm focus:border-emerald-500 focus:outline-none" />
                        <div class="relative">
                            <input type="password" id="regPass" placeholder="Password (Min 6 chars)" class="w-full bg-zinc-900 border border-zinc-800 p-3 text-xs text-white rounded-sm focus:border-emerald-500 focus:outline-none pr-10" />
                            <button onclick="window.togglePassword('regPass')" class="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-500 hover:text-white"><i data-lucide="eye" class="w-4 h-4"></i></button>
                        </div>
                        <button onclick="window.handleRegister()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 text-[10px] uppercase tracking-widest rounded-sm transition-colors ${state.authLoading ? 'opacity-50 cursor-not-allowed' : ''}">
                            ${state.authLoading ? 'Creating...' : 'Register'}
                        </button>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-[10px] text-zinc-500">Already have an account?</p>
                        <button onclick="window.setView('login')" class="text-[10px] font-bold text-white hover:text-emerald-400 uppercase mt-1">Sign In</button>
                    </div>
                    <button onclick="window.goHome()" class="w-full text-zinc-600 hover:text-zinc-400 text-[9px] uppercase mt-8">Back to Store</button>
                </div>
            </div>`;
        }

        function renderForgotPassword() {
            return `
            <div class="h-screen overflow-hidden bg-black flex items-center justify-center p-6 animate-enter">
                <div class="max-w-xs w-full">
                    <div class="text-center mb-8">
                        <h2 class="text-xl font-bold text-white tracking-tighter mb-1">Reset Password</h2>
                        <p class="text-zinc-500 text-[10px] font-mono">Enter your email to receive reset instructions</p>
                    </div>
                    <div class="space-y-3">
                        <input type="email" id="resetEmail" placeholder="Email Address" class="w-full bg-zinc-900 border border-zinc-800 p-3 text-xs text-white rounded-sm focus:border-emerald-500 focus:outline-none" />
                        <button onclick="window.handlePasswordReset()" class="w-full bg-white hover:bg-zinc-200 text-black font-bold py-3 text-[10px] uppercase tracking-widest rounded-sm transition-colors ${state.authLoading ? 'opacity-50 cursor-not-allowed' : ''}">
                            ${state.authLoading ? 'Sending...' : 'Send Reset Link'}
                        </button>
                    </div>
                    <button onclick="window.setView('login')" class="w-full text-zinc-500 hover:text-white text-[10px] uppercase mt-6">Back to Login</button>
                </div>
            </div>`;
        }

        function renderUserOrders() {
            return `
            <div class="min-h-screen bg-black font-sans pb-16 pt-14">
                <div class="p-4 border-b border-white/5 flex items-center gap-3 sticky top-14 bg-black/80 backdrop-blur-md z-10 max-w-7xl mx-auto w-full">
                    <button onclick="window.goHome()" class="hover:text-white text-zinc-400 transition-colors"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                    <span class="text-xs font-bold uppercase tracking-[0.2em] text-zinc-300">My Order History</span>
                </div>
                <div class="p-4 max-w-2xl mx-auto w-full">
                    ${state.userOrders.length === 0 ? `
                        <div class="text-center py-10 text-zinc-600">
                            <i data-lucide="package-open" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p class="text-[10px] uppercase tracking-widest">No orders yet</p>
                        </div>
                    ` : `
                        <div class="space-y-4">
                            ${state.userOrders.map(order => renderOrderCard(order)).join('')}
                        </div>
                    `}
                </div>
            </div>`;
        }

        function renderProduct(animate = true) {
            const p = state.selectedProduct;
            const subtotal = getPrice() * state.quantity;
            const discountAmount = subtotal * state.discount;
            const total = subtotal - discountAmount;
            const isBulk = state.quantity >= p.bulk_threshold;
            const animClass = animate ? 'animate-enter' : '';

            return `
            <div class="pt-14 pb-32 ${animClass} flex flex-col h-full max-w-7xl mx-auto w-full">
                <div class="p-6">
                    <button onclick="window.goHome()" class="flex items-center gap-2 text-[10px] font-mono text-zinc-400 hover:text-white transition-colors">
                        <i data-lucide="arrow-left" class="w-3 h-3"></i> Back to Catalog
                    </button>
                </div>

                <div class="px-6 flex-1 pt-2 max-w-2xl mx-auto w-full">
                    <div class="flex justify-between items-start mb-3">
                        <h1 class="text-xl font-bold uppercase leading-tight tracking-tight">${p.title}</h1>
                        <span class="font-mono text-emerald-400 text-[10px] border border-emerald-500/20 bg-emerald-500/10 px-2 py-0.5">${p.tag}</span>
                    </div>
                    
                    <p class="text-zinc-400 text-xs mb-6 leading-relaxed font-light border-l-2 border-zinc-800 pl-3">${p.description}</p>

                    <div class="bg-zinc-900/50 border border-white/5 p-4 mb-6 rounded-sm">
                        <div class="flex justify-between items-center mb-2 pb-2 border-b border-white/5 ${!isBulk ? 'text-white' : 'text-zinc-500'}">
                            <span class="text-[10px] uppercase font-bold tracking-wider">Single Unit</span>
                            <span class="font-mono text-xs">${formatPHP(p.price)}</span>
                        </div>
                        <div class="flex justify-between items-center ${isBulk ? 'text-emerald-400' : 'text-zinc-500'}">
                            <span class="text-[10px] uppercase font-bold tracking-wider flex items-center gap-2">
                                Bulk Pack (10+) 
                                ${isBulk ? '<span>●</span>' : ''}
                            </span>
                            <span class="font-mono text-xs">${formatPHP(p.bulk_price)}</span>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-zinc-500">QUANTITY</span>
                        <div class="flex items-center gap-1 bg-zinc-900 border border-white/10 p-1 rounded-full">
                            <button onclick="window.updateQuantity(-1)" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-zinc-800 text-white transition-colors">-</button>
                            <span class="w-10 text-center text-xs font-mono font-bold text-emerald-400">${state.quantity}</span>
                            <button onclick="window.updateQuantity(1)" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-zinc-800 text-white transition-colors">+</button>
                        </div>
                    </div>

                    <div class="mb-10">
                        <label class="block text-[10px] font-bold uppercase text-zinc-500 mb-2 tracking-wider">Voucher Code</label>
                        <div class="flex gap-2">
                            <input type="text" id="discountInput" class="w-full bg-zinc-900 border border-white/10 py-2.5 px-3 text-xs font-mono text-white focus:outline-none focus:border-emerald-500 transition-colors uppercase placeholder-zinc-700" placeholder="ENTER CODE" value="${state.discount > 0 ? 'TEST1111' : ''}" ${state.discount > 0 ? 'disabled' : ''} />
                            <button onclick="window.applyDiscount()" class="bg-white/10 hover:bg-white/20 text-white font-bold py-2 px-3 text-[9px] uppercase transition-colors" ${state.discount > 0 ? 'disabled' : ''}>Apply</button>
                        </div>
                        ${state.discount > 0 ? '<p class="text-emerald-500 text-[9px] mt-2 font-mono flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> 5% DISCOUNT APPLIED</p>' : ''}
                    </div>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 right-0 glass border-t border-white/10 p-3 safe-area-bottom z-20">
                <div class="max-w-7xl mx-auto flex items-center gap-3">
                    <div class="flex-1">
                        <span class="text-[9px] uppercase text-zinc-500 block mb-0.5 font-mono tracking-wider">Total</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-xl font-bold font-mono text-white">${formatPHP(total)}</span>
                            ${state.discount > 0 ? `<span class="text-xs text-zinc-500 line-through font-mono decoration-zinc-500">${formatPHP(subtotal)}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="window.setView('checkout')" class="flex-1 bg-white text-black font-bold py-2.5 px-4 text-[10px] uppercase tracking-wider hover:bg-zinc-200 transition-all flex items-center justify-center gap-2">
                        Proceed to Payment <i data-lucide="arrow-right" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>`;
        }

        function renderCheckout(animate = true) {
            const subtotal = getPrice() * state.quantity;
            const discountAmount = subtotal * state.discount;
            const finalTotal = subtotal - discountAmount;
            const animClass = animate ? 'animate-enter' : '';
            
            const buttonContent = state.isSubmitting 
                ? `<i data-lucide="loader" class="w-3 h-3 animate-spin"></i> VERIFYING...`
                : `Confirm Payment`;
            const buttonDisabled = state.isSubmitting ? 'disabled opacity-50 cursor-not-allowed' : 'hover:bg-emerald-400';

            return `
            <div class="min-h-screen bg-black pb-16 pt-14 ${animClass}">
                <div class="p-4 border-b border-white/5 flex items-center gap-3 sticky top-14 bg-black/80 backdrop-blur-md z-10 max-w-7xl mx-auto w-full">
                    <button onclick="window.setView('product')" class="hover:text-white text-zinc-400 transition-colors"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                    <h2 class="font-mono text-[10px] uppercase tracking-widest text-white">Secure Checkout</h2>
                </div>

                <div class="p-5 max-w-2xl mx-auto w-full">
                    <div class="bg-zinc-50 text-black p-5 mb-6 relative font-mono text-[10px] shadow-xl transform rotate-1">
                         <div class="absolute top-0 left-0 right-0 h-1.5 bg-black" style="clip-path: polygon(0 2px, 5px 0, 10px 2px, 15px 0, 20px 2px, 25px 0, 30px 2px, 35px 0, 40px 2px, 45px 0, 50px 2px, 55px 0, 60px 2px, 65px 0, 70px 2px, 75px 0, 80px 2px, 85px 0, 90px 2px, 95px 0, 100% 2px, 100% 100%, 0 100%);"></div>
                         
                         <div class="text-center mb-4 mt-2">
                            <h3 class="font-bold text-base uppercase tracking-tight">${SITE_NAME}</h3>
                            <p class="text-[9px] uppercase opacity-60">Order Summary</p>
                         </div>
                         
                         <div class="border-b border-dashed border-black/20 pb-3 mb-3">
                            <div class="flex justify-between mb-1">
                                <span class="uppercase">${state.selectedProduct.title}</span>
                                <span class="font-bold">x${state.quantity}</span>
                            </div>
                            <div class="flex justify-between opacity-60 text-[9px]">
                                <span>SKU: ${state.selectedProduct.id.toString().padStart(4, '0')}</span>
                                <span>UNIT: ${formatPHP(getPrice())}</span>
                            </div>
                         </div>

                         <div class="space-y-1 mb-4">
                             <div class="flex justify-between items-center text-zinc-600">
                                <span>SUBTOTAL</span>
                                <span>${formatPHP(subtotal)}</span>
                             </div>
                             ${state.discount > 0 ? `
                             <div class="flex justify-between items-center text-emerald-600 font-bold">
                                <span>DISCOUNT (5%)</span>
                                <span>-${formatPHP(discountAmount)}</span>
                             </div>` : ''}
                             <div class="flex justify-between items-end text-base font-bold pt-2 border-t border-black/10 mt-2">
                                <span>TOTAL AMOUNT</span>
                                <span>${formatPHP(finalTotal)}</span>
                             </div>
                         </div>

                         <div class="text-center opacity-40 text-[8px]">
                            <p>Payment Status: Pending</p>
                            <p>${new Date().toISOString()}</p>
                         </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                            <span class="text-[9px] font-bold uppercase tracking-widest text-zinc-400">Payment Gateway</span>
                        </div>
                        
                        <div class="bg-zinc-900 border border-white/10 p-4 flex flex-col items-center justify-center gap-3 relative overflow-hidden">
                             <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMDUiLz4KPC9zdmc+')] opacity-10"></div>
                             <div class="bg-white p-1.5">
                                <img src="${GCASH_QR_URL}" alt="QR" class="w-24 h-24 object-cover mix-blend-multiply" />
                             </div>
                             <div class="text-center relative z-10">
                                <p class="font-mono text-sm font-bold text-white tracking-widest">${GCASH_NUMBER}</p>
                                <p class="text-[9px] uppercase text-zinc-500 mt-0.5">Scan to transfer funds</p>
                             </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1.5 tracking-wider">Reference Number</label>
                        <div class="relative">
                            <input type="text" id="refNumberInput" placeholder="0000 0000 0000" class="w-full bg-zinc-900 border border-white/10 py-3 px-3 pl-10 text-xs font-mono text-white focus:outline-none focus:border-emerald-500 transition-colors placeholder-zinc-700" />
                            <i data-lucide="hash" class="w-3 h-3 text-zinc-600 absolute left-3.5 top-1/2 -translate-y-1/2"></i>
                        </div>
                        
                        <button onclick="window.submitOrder()" class="w-full bg-emerald-500 text-black font-bold py-3 px-4 text-[10px] uppercase mt-5 transition-all tracking-wider shadow-[0_0_20px_rgba(16,185,129,0.3)] flex items-center justify-center gap-2 ${buttonDisabled}">
                            ${buttonContent}
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function renderSuccess(animate = true) {
            const animClass = animate ? 'animate-enter' : '';
            return `
            <div class="min-h-screen flex flex-col items-center justify-center p-6 pt-20 text-center bg-black ${animClass} relative overflow-hidden">
                <div class="absolute inset-0 bg-emerald-500/5 radial-gradient"></div>

                <div class="w-16 h-16 bg-zinc-900 border border-emerald-500/30 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(16,185,129,0.2)] relative z-10">
                    <i data-lucide="check" class="w-6 h-6 text-emerald-500"></i>
                </div>
                
                <h2 class="text-2xl font-bold tracking-tighter mb-2 text-white relative z-10">Order Received</h2>
                <p class="text-zinc-500 text-[10px] mb-8 max-w-[220px] leading-relaxed font-mono relative z-10">
                    We have received your payment reference. Your order is being processed. ETA: 10-30m.
                </p>
                
                <div class="bg-zinc-900 border border-dashed border-zinc-700 p-3 w-full mb-6 relative group max-w-xs">
                    <p class="text-[8px] text-zinc-500 uppercase tracking-widest mb-1 font-mono">Order Reference ID</p>
                    <p class="text-lg font-mono font-bold text-white tracking-widest">${state.lastOrderId}</p>
                    <button onclick="window.copyToClipboard('${state.lastOrderId}')" class="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-600 hover:text-white p-1.5 transition-colors">
                        <i data-lucide="copy" class="w-3 h-3"></i>
                    </button>
                </div>

                <div class="space-y-2 w-full max-w-xs relative z-10">
                    <button onclick="window.setView('tracker')" class="w-full bg-white text-black font-bold py-2.5 px-4 text-[10px] uppercase hover:bg-zinc-200 transition-colors tracking-wider">
                        Check Status
                    </button>
                    <button onclick="window.goHome()" class="w-full text-zinc-500 font-bold py-2.5 px-4 text-[10px] uppercase hover:text-white transition-colors tracking-wider">
                        Return to Store
                    </button>
                </div>
            </div>`;
        }

        // Shared Render Logic for Order Cards (Used in Tracker and User Orders)
        function renderOrderCard(res) {
            const isProcessing = res.status === 'Processing';
            const isRefundPending = res.status === 'Refund Pending';
            const isCompleted = res.status === 'Completed';
            const isCancelled = res.status === 'Cancelled';
            
            const timeDiff = new Date() - new Date(res.date);
            const canCancel = isProcessing && timeDiff < 60000;
            const canRequestRefund = isProcessing && timeDiff > 3600000;

            let statusColor = '';
            if(isCompleted) statusColor = 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20';
            else if(isCancelled) statusColor = 'text-red-400 bg-red-500/10 border-red-500/20';
            else if(isRefundPending) statusColor = 'text-orange-400 bg-orange-500/10 border-orange-500/20';
            else statusColor = 'text-yellow-400 bg-yellow-500/10 border-yellow-500/20';

            let accountsHtml = '';
            if(isCompleted && res.accounts && res.accounts.length > 0) {
                accountsHtml = `
                <div class="mt-5 border-t border-dashed border-zinc-800 pt-4">
                    <h4 class="text-[9px] font-bold uppercase mb-2 text-zinc-400 tracking-wider flex items-center gap-2"><i data-lucide="key" class="w-3 h-3"></i> Access Details</h4>
                    <div class="space-y-2">
                        ${res.accounts.map((acc, idx) => `
                        <div class="bg-zinc-900 border ${acc.used ? 'border-zinc-800 opacity-50' : 'border-emerald-500/20'} p-3 rounded-sm">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[9px] text-zinc-500 font-mono">Slot #${idx + 1}</span>
                                <button onclick="window.toggleAccountUsed('${res.id}', '${acc.id}')" class="text-[8px] ${acc.used ? 'text-zinc-500' : 'text-zinc-400 hover:text-white'} uppercase font-bold">
                                    ${acc.used ? 'Used' : 'Mark Used'}
                                </button>
                            </div>
                            <div class="font-mono text-xs mb-3 select-all break-all ${acc.used ? 'line-through text-zinc-600' : 'text-emerald-500'}">${acc.creds}</div>
                            
                            <div class="bg-black/50 p-2 rounded border border-white/5">
                                ${acc.otpRequest.status === 'sent' ? `
                                <div class="flex justify-between items-center">
                                    <span class="text-[9px] font-bold text-zinc-500 uppercase">2FA CODE:</span>
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono font-bold text-white text-sm tracking-widest">${acc.otpRequest.code}</span>
                                        <i data-lucide="copy" class="w-3 h-3 text-zinc-500 cursor-pointer hover:text-white" onclick="window.copyToClipboard('${acc.otpRequest.code}')"></i>
                                    </div>
                                </div>` : acc.otpRequest.status === 'pending' ? `
                                <div class="flex items-center gap-2 w-full text-yellow-500/80 justify-center py-0.5">
                                    <i data-lucide="loader" class="w-3 h-3 animate-spin"></i>
                                    <span class="text-[8px] font-bold uppercase tracking-wide font-mono">Waiting for Admin...</span>
                                </div>` : `
                                <div class="flex items-center justify-between w-full">
                                    <span class="text-[8px] text-zinc-500 uppercase">Verify Login</span>
                                    <button onclick="window.requestOtp('${res.id}', '${acc.id}')" class="bg-white/10 hover:bg-white/20 text-white text-[8px] font-bold px-2 py-0.5 uppercase transition-colors rounded-sm tracking-wide">Request OTP</button>
                                </div>`}

                                <div class="border-t border-white/5 pt-2 mt-2">
                                    ${acc.messages && acc.messages.length > 0 ? `
                                    <div class="mb-2 space-y-1 max-h-20 overflow-y-auto custom-scrollbar">
                                        ${acc.messages.map(msg => `
                                            <div class="text-[8px] ${msg.sender === 'admin' ? 'text-emerald-400' : 'text-zinc-400'} font-mono">
                                                <span class="uppercase font-bold">${msg.sender}:</span> ${msg.text}
                                            </div>
                                        `).join('')}
                                    </div>` : ''}
                                    <div class="flex gap-2">
                                        <input type="text" id="msg-${acc.id}" placeholder="Report issue..." class="bg-zinc-800 border border-zinc-700 text-[9px] px-2 py-1 w-full focus:outline-none focus:border-zinc-500 rounded-sm text-zinc-300" />
                                        <button onclick="window.sendAccountMessage('${res.id}', '${acc.id}', document.getElementById('msg-${acc.id}').value, 'user')" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white px-2 rounded-sm"><i data-lucide="send" class="w-3 h-3"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>`;
            }

            return `
            <div class="bg-zinc-900/50 border border-white/5 p-5 relative overflow-hidden backdrop-blur-sm animate-enter">
                <div class="absolute top-0 left-0 w-1 h-full ${isCompleted ? 'bg-emerald-500' : (isCancelled ? 'bg-red-500' : (isRefundPending ? 'bg-orange-500' : 'bg-yellow-500'))}"></div>
                <div class="flex justify-between items-start mb-5 pl-2">
                    <div>
                        <h3 class="font-bold text-xs tracking-tight mb-1 text-white">${res.id}</h3>
                        <p class="text-[9px] text-zinc-500 font-mono">${formatDate(res.date)}</p>
                    </div>
                    <span class="${statusColor} border text-[8px] font-bold px-2 py-0.5 uppercase tracking-wider">${res.status}</span>
                </div>
                <div class="border-t border-dashed border-zinc-800 pt-3 space-y-1 pl-2">
                    <div class="flex justify-between text-[10px]">
                        <span class="text-zinc-500 uppercase tracking-wider text-[9px]">Product</span>
                        <span class="font-medium text-white truncate max-w-[150px]">${res.product}</span>
                    </div>
                     <div class="flex justify-between text-[10px]">
                        <span class="text-zinc-500 uppercase tracking-wider text-[9px]">Total Amount</span>
                        <span class="font-bold font-mono text-white">${formatPHP(res.total)}</span>
                    </div>
                </div>
                ${canCancel ? `
                <div class="mt-5 pl-2">
                    <button onclick="window.cancelOrder('${res.id}')" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 font-bold py-2.5 px-3 text-[9px] uppercase transition-colors tracking-wide">
                        Cancel Order (Undo)
                    </button>
                    <p class="text-[8px] text-zinc-600 text-center mt-2 font-mono">TIMER: < 60s remaining</p>
                </div>` : ''}
                ${(canRequestRefund && !res.refundRequest) ? `
                <div class="mt-6 border-t border-dashed border-zinc-800 pt-4">
                    <p class="text-[10px] text-zinc-500 mb-2 font-mono">Delivery limit exceeded. Request refund:</p>
                    <div class="space-y-2">
                        <input type="text" id="refundName" placeholder="GCash Name" class="w-full bg-zinc-900/50 border border-zinc-700 p-2 text-[10px] font-mono text-zinc-300" />
                        <input type="text" id="refundNumber" placeholder="GCash Number" class="w-full bg-zinc-900/50 border border-zinc-700 p-2 text-[10px] font-mono text-zinc-300" />
                        <button onclick="window.submitRefundRequest('${res.id}')" class="w-full bg-orange-500/10 hover:bg-orange-500/20 text-orange-500 border border-orange-500/20 font-bold py-2 px-3 text-[9px] uppercase transition-colors tracking-wider">
                            Request Refund
                        </button>
                    </div>
                </div>` : ''}
                ${res.refundRequest ? `
                <div class="mt-6 border-t border-dashed border-zinc-800 pt-4">
                    <div class="bg-orange-500/5 border border-orange-500/10 p-3 rounded-sm">
                        <p class="text-[9px] text-orange-400 uppercase font-bold mb-1 flex items-center gap-2"><i data-lucide="refresh-ccw" class="w-3 h-3"></i> Refund Requested</p>
                        <p class="text-[9px] text-zinc-500 font-mono">Status: Pending Admin Action</p>
                    </div>
                </div>` : ''}
                ${accountsHtml}
            </div>`;
        }

        function renderHome(animate = true) {
            const animClass = animate ? 'animate-enter' : '';
            return `
            <div class="pt-14 pb-16 ${animClass}">
                <div class="bg-zinc-900/50 border-b border-white/5 py-1.5 px-4 flex justify-center items-center gap-2 text-[9px] uppercase tracking-widest text-zinc-500 font-mono">
                    <i data-lucide="lock" class="w-3 h-3 text-zinc-400"></i>
                    All transactions are secured and safe
                </div>
                <div class="overflow-hidden bg-black border-b border-white/5 py-3 relative">
                     <div class="whitespace-nowrap animate-marquee flex gap-16 items-center text-[9px] font-mono text-zinc-600 uppercase tracking-[0.2em]">
                        <span>VERIFIED SHEIN ACCTS</span>
                        <span>BULK PRICING AVAILABLE</span>
                        <span>MANUAL ORDER VERIFICATION</span>
                        <span>EXCLUSIVE VOUCHERS INCLUDED</span>
                        <span>SECURE PAYMENT PROCESSING</span>
                        <span>VERIFIED SHEIN ACCTS</span>
                        <span>BULK PRICING AVAILABLE</span>
                        <span>MANUAL ORDER VERIFICATION</span>
                      </div>
                      <div class="absolute inset-y-0 left-0 w-16 bg-gradient-to-r from-black to-transparent z-10"></div>
                      <div class="absolute inset-y-0 right-0 w-16 bg-gradient-to-l from-black to-transparent z-10"></div>
                </div>
                <div class="p-5 mb-2 relative overflow-hidden group max-w-7xl mx-auto">
                    <div class="relative z-10">
                        <h1 class="text-3xl font-bold leading-none mb-3 tracking-tighter text-white">SHOP WITHOUT<br/>HASSLE!</h1>
                        <p class="text-[10px] text-zinc-400 max-w-[220px] leading-relaxed font-mono">
                            Fresh SHEIN accounts with exclusive vouchers delivered to your dashboard. Secure. Fast. Anonymous.
                        </p>
                    </div>
                    <div class="absolute right-0 top-0 w-56 h-56 bg-gradient-to-b from-zinc-800 to-transparent opacity-20 blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                </div>
                <div class="px-6 max-w-7xl mx-auto w-full">
                    <div class="flex items-center gap-2 mb-4 opacity-50">
                        <i data-lucide="grid" class="w-3 h-3 text-white"></i>
                        <span class="text-[9px] font-bold tracking-[0.2em] uppercase text-zinc-400">AVAILABLE STOCK</span>
                    </div>
                    <div class="max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 pb-20">
                            ${state.products.length === 0 ? '<div class="col-span-full text-center text-zinc-500 py-10"><p>Loading products...</p></div>' : ''}
                            ${state.products.map(p => `
                            <div onclick="window.selectProduct(${p.id})" class="group cursor-pointer bg-zinc-900/50 border border-white/5 hover:border-emerald-500/50 hover:bg-zinc-900 transition-all duration-300 p-2.5 relative overflow-hidden h-full ${p.stock <= 0 ? 'opacity-50 grayscale pointer-events-none' : ''}">
                                <div class="flex flex-col gap-2 h-full justify-between relative z-10">
                                    <div class="flex justify-between items-start">
                                        <div class="w-10 h-10 ${p.color} flex items-center justify-center border border-white/5 rounded-sm">
                                            <i data-lucide="package" class="w-5 h-5 opacity-90 group-hover:scale-110 transition-transform duration-500 text-zinc-400"></i>
                                        </div>
                                        <div class="flex flex-col items-end gap-1">
                                            <span class="bg-white/5 text-zinc-400 border border-white/5 text-[8px] font-mono px-1.5 py-0.5 uppercase rounded-sm tracking-tight">${p.tag}</span>
                                            ${p.stock <= 0 ? '<span class="text-[8px] text-red-500 font-bold uppercase tracking-wide">Out of Stock</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="flex items-end justify-between mt-1">
                                        <div>
                                            <h3 class="text-[10px] font-bold uppercase tracking-tight text-white group-hover:text-emerald-400 transition-colors leading-tight mb-1 line-clamp-2">${p.title}</h3>
                                            <span class="text-xs font-bold font-mono text-white">${formatPHP(p.price)}</span>
                                        </div>
                                        <div class="w-5 h-5 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-emerald-500 group-hover:text-black transition-colors shrink-0">
                                            <i data-lucide="arrow-up-right" class="w-3 h-3"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderTracker(animate = true) {
            return `
            <div class="min-h-screen bg-black font-sans pb-16 pt-14">
                <div class="p-4 border-b border-white/5 flex items-center gap-3 sticky top-14 bg-black/80 backdrop-blur-md z-10 max-w-7xl mx-auto w-full">
                    <button onclick="window.goHome()" class="hover:text-white text-zinc-400 transition-colors"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                    <span class="text-xs font-bold uppercase tracking-[0.2em] text-zinc-300">Order Lookup</span>
                </div>
                <div class="p-5 max-w-md mx-auto w-full">
                    <div class="mb-5">
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1.5 tracking-wider">Enter Order ID</label>
                        <div class="relative">
                            <input type="text" id="trackerInputVal" value="${state.trackerInput}" placeholder="ORD-XXXXXXXX" class="w-full bg-zinc-900 border border-white/10 py-2.5 px-3 pl-9 text-xs font-mono text-white focus:outline-none focus:border-white/30 transition-colors placeholder-zinc-700" />
                            <i data-lucide="hash" class="w-3 h-3 text-zinc-600 absolute left-3 top-1/2 -translate-y-1/2"></i>
                        </div>
                        <button onclick="window.handleTrack()" class="w-full bg-white text-black font-bold py-2.5 px-4 text-[10px] uppercase mt-3 hover:bg-zinc-200 transition-colors tracking-wider">Track Order</button>
                    </div>
                    ${!state.searchResult ? '' : 
                      state.searchResult === 'not-found' ? `
                        <div class="animate-enter text-center p-6 text-zinc-500 border border-dashed border-zinc-800 bg-zinc-900/30 mt-4">
                            <i data-lucide="search-x" class="w-6 h-6 mx-auto mb-2 opacity-50"></i>
                            <p class="text-[10px] font-mono">Error: Order not found</p>
                        </div>
                      ` : renderOrderCard(state.searchResult)
                    }
                </div>
            </div>`;
        }

        function renderAdmin() {
            if (!state.adminAuth) {
                return `
                <div class="min-h-screen bg-black text-white font-sans flex items-center justify-center p-6 fixed top-0 left-0 w-full z-50">
                    <div class="bg-zinc-900 border border-white/10 p-6 max-w-xs w-full relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-emerald-500 to-transparent opacity-50"></div>
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-center uppercase tracking-[0.2em] text-xs">Administration</h3>
                            <button onclick="window.goHome()" class="text-[9px] text-zinc-500 hover:text-white uppercase">Exit</button>
                         </div>
                        <div class="mb-5">
                            <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1.5 tracking-wider">Password</label>
                            <input type="password" id="adminPassInput" class="w-full bg-black border border-white/10 py-2.5 px-3 text-xs font-mono focus:outline-none focus:border-emerald-500/50 transition-colors text-white" />
                        </div>
                        <button onclick="window.handleAdminLogin()" class="w-full bg-white text-black font-bold py-2.5 px-4 text-[10px] uppercase hover:bg-zinc-200 tracking-wider">Authenticate</button>
                    </div>
                </div>`;
            }

            const pending = state.orders.filter(o => o.status === 'Processing').length;
            const revenue = state.orders.reduce((acc, cur) => acc + cur.total, 0);
            const pendingOtp = getPendingOtpCount();

            // Orders Tab Content
            let tabContent = '';
            if (state.adminTab === 'orders') {
                tabContent = `
                <div class="bg-zinc-900 border border-white/5 overflow-hidden">
                    <table class="w-full text-left">
                        <tbody class="divide-y divide-white/5">
                            ${state.orders.map(order => `
                            <tr class="hover:bg-white/5 group transition-colors">
                                <td class="p-3">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-[10px] text-white font-mono">${order.id}</span>
                                    </div>
                                    <div class="text-[9px] text-zinc-500 font-mono mt-0.5 opacity-60">Ref: ${order.refNumber}</div>
                                    <div class="text-[9px] text-zinc-400 mt-0.5 uppercase tracking-wide">${order.product} <span class="text-zinc-600">x${order.quantity}</span></div>
                                </td>
                                <td class="p-3">
                                    <span class="${order.status === 'Completed' ? 'text-emerald-400 border-emerald-500/20 bg-emerald-500/5' : (order.status === 'Cancelled' ? 'text-red-400 border-red-500/20 bg-red-500/5' : (order.status === 'Refund Pending' ? 'text-orange-400 border-orange-500/20 bg-orange-500/5' : 'text-yellow-400 border-yellow-500/20 bg-yellow-500/5'))} border text-[8px] font-bold px-1.5 py-0.5 uppercase rounded-sm">${order.status}</span>
                                </td>
                                <td class="p-3 text-right">
                                    ${order.status === 'Processing' || order.status === 'Refund Pending' ? `
                                        <div class="flex gap-1 justify-end">
                                            <button onclick="state.activeFulfillmentId = '${order.id}'; render()" class="bg-white text-black hover:bg-zinc-200 px-2 py-1 text-[9px] uppercase font-bold tracking-wide">Fulfill</button>
                                            <button onclick="window.adminAction('${order.id}', 'cancel')" class="border border-white/10 text-zinc-400 hover:text-white px-2 py-1 text-[9px] uppercase font-bold"><i data-lucide="x" class="w-3 h-3"></i></button>
                                            <button onclick="window.adminAction('${order.id}', 'refund')" class="border border-white/10 text-zinc-400 hover:text-white px-2 py-1 text-[9px] uppercase font-bold"><i data-lucide="refresh-ccw" class="w-3 h-3"></i></button>
                                        </div>
                                    ` : order.status === 'Completed' ? `
                                        <button onclick="state.activeFulfillmentId = state.activeFulfillmentId === '${order.id}' ? null : '${order.id}'; render()" class="text-[9px] text-zinc-500 hover:text-white font-bold uppercase underline">View</button>
                                    ` : ''}
                                </td>
                            </tr>
                            ${state.activeFulfillmentId === order.id ? `
                            <tr>
                                <td colspan="3" class="bg-zinc-800/50 p-4 border-y border-white/5 animate-enter">
                                    ${order.status === 'Completed' ? `
                                        <div class="mb-4">
                                            <h4 class="text-[9px] font-bold uppercase mb-2 text-zinc-400 tracking-wider">Account Details</h4>
                                            ${order.accounts.map(acc => `
                                                <div class="bg-black/50 p-2 mb-2 border border-white/5 rounded-sm">
                                                    <div class="flex justify-between items-center mb-1">
                                                        <span class="text-emerald-500 font-mono text-[10px]">${acc.creds}</span>
                                                        <span class="text-[8px] text-zinc-500">${acc.otpRequest.status === 'sent' ? 'OTP Sent' : 'No OTP'}</span>
                                                    </div>
                                                    ${acc.messages && acc.messages.length > 0 ? `
                                                    <div class="border-t border-white/5 mt-2 pt-2">
                                                        ${acc.messages.map(msg => `
                                                            <div class="text-[8px] ${msg.sender === 'admin' ? 'text-emerald-400' : 'text-zinc-400'} font-mono mb-0.5">
                                                                <span class="uppercase font-bold">${msg.sender}:</span> ${msg.text}
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                    ` : ''}
                                                    <div class="flex gap-2 mt-2">
                                                        <input type="text" id="admin-msg-${acc.id}" placeholder="Reply to user..." class="bg-zinc-900 border border-zinc-700 text-[9px] px-2 py-1 w-full focus:outline-none focus:border-zinc-500 text-white" />
                                                        <button onclick="window.sendAccountMessage('${order.id}', '${acc.id}', document.getElementById('admin-msg-${acc.id}').value, 'admin')" class="bg-zinc-700 hover:bg-zinc-600 text-white px-2 rounded-sm text-[9px] uppercase font-bold">Send</button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <h4 class="text-[9px] font-bold uppercase mb-2 text-zinc-400 tracking-wider">Add Accts (Line Separated)</h4>
                                        <textarea id="fulfillmentTextArea" class="w-full bg-black border border-white/10 p-2 text-[10px] font-mono h-24 mb-3 focus:border-emerald-500/50 focus:outline-none text-white" placeholder="user:pass..."></textarea>
                                        <div class="flex justify-end gap-2">
                                            <button onclick="state.activeFulfillmentId = null; render()" class="text-zinc-500 hover:text-white text-[10px] font-bold uppercase transition-colors">Cancel</button>
                                            <button onclick="window.fulfillOrder('${order.id}')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 text-[9px] uppercase font-bold tracking-wide">Confirm & Send</button>
                                        </div>
                                    `}
                                </td>
                            </tr>` : ''}
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            } else if (state.adminTab === 'products') {
                tabContent = `
                <div class="bg-zinc-900 border border-white/5">
                    <div class="p-4 border-b border-white/5 flex justify-between items-center">
                        <h3 class="text-[10px] font-bold uppercase text-zinc-400 tracking-widest">Inventory Management</h3>
                        <button onclick="window.openAddProductModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 text-[9px] uppercase font-bold tracking-wide flex items-center gap-2"><i data-lucide="plus" class="w-3 h-3"></i> Add Product</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                        ${state.products.map(p => `
                        <div class="bg-black/50 border border-white/5 p-4 relative group rounded-sm">
                            <div class="mb-3">
                                <label class="text-[8px] text-zinc-500 uppercase font-bold block mb-1">Product Title</label>
                                <input type="text" id="prod-title-${p.id}" value="${p.title}" class="bg-zinc-900 border border-zinc-700 w-full text-xs p-2 text-white focus:outline-none focus:border-emerald-500 rounded-sm" />
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-[8px] text-zinc-500 uppercase font-bold block mb-1">Price</label>
                                    <div class="relative">
                                        <span class="absolute left-2 top-1/2 -translate-y-1/2 text-zinc-500 text-xs">₱</span>
                                        <input type="number" id="prod-price-${p.id}" value="${p.price}" class="bg-zinc-900 border border-zinc-700 w-full text-xs py-2 pl-6 pr-2 text-white focus:outline-none focus:border-emerald-500 rounded-sm" />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-[8px] text-zinc-500 uppercase font-bold block mb-1">Stock</label>
                                    <input type="number" id="prod-stock-${p.id}" value="${p.stock}" class="bg-zinc-900 border border-zinc-700 w-full text-xs p-2 text-white focus:outline-none focus:border-emerald-500 rounded-sm" />
                                </div>
                            </div>

                            <div class="flex justify-end pt-2 border-t border-white/5">
                                <button onclick="window.saveProductChanges('${p.id}')" class="bg-white text-black hover:bg-zinc-200 px-3 py-1.5 text-[9px] uppercase font-bold tracking-wide rounded-sm">Save Changes</button>
                            </div>
                        </div>
                        `).join('')}
                    </div>
                </div>`;
            } else if (state.adminTab === 'otp') {
                const pendingReqs = [];
                state.orders.forEach(o => {
                    if (o.accounts) o.accounts.forEach((a, idx) => {
                        if (a.otpRequest.status === 'pending') pendingReqs.push({ orderId: o.id, accId: a.id, creds: a.creds, idx: idx + 1, reqAt: a.otpRequest.requestedAt });
                    });
                });

                if (pendingReqs.length > 0) {
                    tabContent = `
                    <div class="bg-zinc-900 border border-white/5 divide-y divide-white/5">
                        ${pendingReqs.map(req => `
                        <div class="p-3 bg-yellow-500/5 animate-enter">
                            <div class="mb-2">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-[10px] text-white font-mono">${req.orderId}</span>
                                    <span class="text-[8px] border border-white/10 px-1 text-zinc-400 uppercase font-bold">Slot #${req.idx}</span>
                                </div>
                                <div class="font-mono text-[10px] px-2 py-0.5 inline-block bg-black border border-white/10 text-emerald-500 rounded-sm mb-1">${req.creds}</div>
                                <div class="flex items-center gap-1 text-[9px] text-zinc-500"><i data-lucide="clock" class="w-3 h-3"></i> T+ ${Math.floor((new Date() - new Date(req.reqAt)) / 60000)}m</div>
                            </div>
                            <div class="flex gap-2 items-center bg-black p-1 pr-2 rounded border border-white/10">
                                <input type="text" id="otp-input-${req.accId}" placeholder="Enter 2FA Code" class="bg-transparent p-1.5 text-xs w-full focus:outline-none font-mono text-white placeholder-zinc-700" />
                                <button onclick="window.sendOtp('${req.orderId}', '${req.accId}', document.getElementById('otp-input-${req.accId}').value)" class="text-emerald-500 hover:text-emerald-400 p-1.5"><i data-lucide="send" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        `).join('')}
                    </div>`;
                } else {
                    tabContent = `<div class="p-8 text-center text-zinc-600 bg-zinc-900 border border-white/5"><p class="text-[10px] font-bold uppercase tracking-widest">No pending OTP requests</p></div>`;
                }
            } else if (state.adminTab === 'settings') {
                tabContent = `
                <div class="bg-zinc-900 border border-white/5 p-6 max-w-sm">
                    <h3 class="text-[10px] font-bold uppercase text-zinc-400 mb-4 tracking-widest">Security Settings</h3>
                    <div class="mb-4">
                        <label class="block text-[9px] font-bold uppercase text-zinc-500 mb-1.5 tracking-wider">New Password</label>
                        <input type="password" id="newAdminPass" class="w-full bg-black border border-white/10 py-2.5 px-3 text-xs font-mono focus:outline-none focus:border-emerald-500/50 transition-colors text-white" />
                    </div>
                    <button onclick="window.updateAdminPassword()" class="bg-white text-black font-bold py-2 px-4 text-[10px] uppercase hover:bg-zinc-200 tracking-wider">Update Password</button>
                </div>`;
            }

            return `
            <div class="min-h-screen bg-black text-white font-sans">
                <div class="fixed top-0 left-0 w-full z-50 bg-black border-b border-white/10 p-4 flex justify-between items-center">
                    <h2 class="font-black text-xs tracking-[0.2em] flex items-center gap-2 text-zinc-300">ADMIN PANEL <span class="bg-red-900/50 text-red-200 border border-red-500/30 px-1 text-[8px] rounded-sm">V3.1</span></h2>
                    <button onclick="window.handleAdminLogout()" class="text-[9px] font-bold hover:text-emerald-400 uppercase tracking-wider transition-colors">Logout</button>
                </div>
                <div class="pt-20 max-w-7xl mx-auto p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
                        <div class="bg-zinc-900 p-3 border border-white/5"><p class="text-[8px] text-zinc-500 uppercase font-bold tracking-widest">Gross Rev</p><p class="text-lg font-bold font-mono text-white">${formatPHP(revenue)}</p></div>
                        <div class="bg-zinc-900 p-3 border border-white/5"><p class="text-[8px] text-zinc-500 uppercase font-bold tracking-widest">Total Tx</p><p class="text-lg font-bold text-white">${state.orders.length}</p></div>
                        <div class="bg-zinc-900 p-3 border border-white/5"><p class="text-[8px] text-zinc-500 uppercase font-bold tracking-widest">Pending</p><p class="text-lg font-bold text-yellow-500">${pending}</p></div>
                        <div onclick="state.adminTab = 'otp'; render()" class="bg-zinc-900 p-3 border cursor-pointer hover:border-emerald-500/30 transition-colors ${pendingOtp > 0 ? 'border-red-500/50 shadow-[0_0_15px_rgba(239,68,68,0.1)]' : 'border-white/5'}">
                            <p class="text-[8px] text-zinc-500 uppercase font-bold flex justify-between tracking-widest">OTP Requests <i data-lucide="radio" class="w-3 h-3"></i></p>
                            <p class="text-lg font-bold text-red-500">${pendingOtp}</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 mb-5 border-b border-white/5 pb-1 px-1 overflow-x-auto">
                        <button onclick="state.adminTab = 'orders'; render()" class="text-[9px] font-bold uppercase pb-2 px-1 transition-all tracking-widest ${state.adminTab === 'orders' ? 'border-b-2 border-white text-white' : 'text-zinc-600 hover:text-zinc-400'}">Orders</button>
                        <button onclick="state.adminTab = 'products'; render()" class="text-[9px] font-bold uppercase pb-2 px-1 transition-all tracking-widest ${state.adminTab === 'products' ? 'border-b-2 border-white text-white' : 'text-zinc-600 hover:text-zinc-400'}">Stocks</button>
                        <button onclick="state.adminTab = 'otp'; render()" class="text-[9px] font-bold uppercase pb-2 px-1 transition-all tracking-widest flex items-center gap-2 ${state.adminTab === 'otp' ? 'border-b-2 border-white text-white' : 'text-zinc-600 hover:text-zinc-400'}">OTP Codes ${pendingOtp > 0 ? `<span class="bg-red-500 text-white px-1.5 rounded-full text-[8px] animate-pulse">${pendingOtp}</span>` : ''}</button>
                        <button onclick="state.adminTab = 'settings'; render()" class="text-[9px] font-bold uppercase pb-2 px-1 transition-all tracking-widest ${state.adminTab === 'settings' ? 'border-b-2 border-white text-white' : 'text-zinc-600 hover:text-zinc-400'}">Settings</button>
                    </div>
                    ${tabContent}
                </div>
            </div>`;
        }

        function render(animate = true) {
            const app = document.getElementById('app');
            let html = '';

            if (state.view === 'admin') {
                html = renderAdmin();
            } else if (state.view === 'login') {
                html = renderLogin();
            } else if (state.view === 'register') {
                html = renderRegister();
            } else if (state.view === 'forgot-password') {
                html = renderForgotPassword();
            } else if (state.view === 'my-orders') {
                html = renderUserOrders();
            } else {
                html = renderHeader();
                if (state.view === 'home') html += renderHome(animate);
                else if (state.view === 'product') html += renderProduct(animate);
                else if (state.view === 'checkout') html += renderCheckout(animate);
                else if (state.view === 'success') html += renderSuccess(animate);
                else if (state.view === 'tracker') html += renderTracker(animate);
            }

            app.innerHTML = html;
            lucide.createIcons();

            if (animate) {
                window.scrollTo(0, 0);
            }
        }

        // Functions to Expose
        window.goHome = goHome;
        window.setView = setView;
        window.selectProduct = selectProduct;
        window.updateQuantity = updateQuantity;
        window.submitOrder = submitOrder;
        window.handleTrack = handleTrack;
        window.cancelOrder = cancelOrder;
        window.toggleAccountUsed = toggleAccountUsed;
        window.requestOtp = requestOtp;
        window.handleAdminLogin = handleAdminLogin;
        window.handleAdminLogout = handleAdminLogout; 
        window.fulfillOrder = fulfillOrder;
        window.adminAction = adminAction;
        window.updateAdminPassword = updateAdminPassword;
        window.sendAccountMessage = sendAccountMessage;
        window.sendOtp = sendOtp;
        window.callGemini = callGemini;
        window.showToast = showToast;
        window.applyDiscount = applyDiscount;
        window.submitRefundRequest = submitRefundRequest;
        window.copyToClipboard = copyToClipboard;
        window.togglePassword = togglePassword;
        window.updateProduct = updateProduct; // New export
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.confirmModalAction = confirmModalAction;
        
        // New Expose Functions
        window.openAddProductModal = openAddProductModal;
        window.closeAddProductModal = closeAddProductModal;
        window.submitNewProduct = submitNewProduct;
        window.saveProductChanges = saveProductChanges;
        
        // Auth Expose
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleUserLogout = handleUserLogout;
        window.handlePasswordReset = handlePasswordReset;

        // Init
        init();

    </script>
</body>
</html>
